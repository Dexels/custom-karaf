
<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
/*

Copyright (c) 2005 Hakon Wium Lie and Bert Bos

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/
html {
  margin: 0; padding: 0;
  font: 10pt/1.26 "Gill Sans", sans-serif;
}

h1, h2, h3, h4, h5, h6 {
  font-family: "Gill Sans", sans-serif;
  margin: 2em 0 0.5em 0;
  page-break-after: avoid;
}

h1 {
  font-size: 2.0em;
  font-weight: 900;

  margin: 0;
  margin-left:-2cm;
  margin-top:-1cm;
  margin-bottom:1.5cm;
  top: 0cm;
  left: 0cm;
  padding: 2cm;
  padding-top: 0cm;
  padding-bottom: 1cm;
  background: #888;
  border-bottom-right-radius: 2cm;
  page-break-before: always;
  page-break-inside: avoid;
}

@media screen, handheld {
h1 {
  margin-top:1cm;
  background-image: url("chapter-rounded-bottom.png");
  background-repeat: no-repeat;
  background-position: bottom right;
}
div.page-reset > h1 {
  margin-top:0cm;
}
}


h2 {
  font-size: 1.2em;
  text-transform: uppercase;
  font-weight: bold;
}

h3 {
  font-size: 1em;
  font-weight: bold;
}

q::before {
  content: "\201C";
}

q::after {
  content: "\201D";
}

p { margin: 0 }
p + p { text-indent: 1.3em ; margin-top: 0.2em; }
p.sidenote + p, p.caption, p.art { text-indent: 0 }

p.author {
  margin-top: 2em;
  text-indent: 0;
  text-align: right;
}

a { text-decoration: none; color: black }

/* cross-references */

a.pageref::after { content: " on page " target-counter(attr(href), page); }
a.chapref::before { content: " Chapter " target-counter(attr(href), chapter) ", "; }
a.figref { content: " Figure " target-counter(attr(href), figure); }
a.tableref { content: " Table " target-counter(attr(href), figure); }
a.listingref { content: " Listing " target-counter(attr(href), listing); }

/* sidenotes */

.sidenote {
  float: left;
  clear: left;
  margin: 0 0 1em -41%;
  width: 37%;
  font-size: 0.9em;
  font-style: normal;
  text-indent: 0;
  text-align: right;
  page-break-inside: avoid;
}

/* sidebars */

div.sidebar {
  float: top-next;
  margin: 1.2em 0 1.2em 0;
  border: thin solid;
  background: #CCC;
  padding: 0.5em 1em;
  page-break-inside: avoid;
  column-count: 2;
  column-gap: 1.5em;
}

div.sidebar h2 {
  margin-top: 0;
}

/* frontpage */

.title p{
	font-size:22pt;
  	font-family: "Gill Sans", sans-serif;
  	text-align: center;
}

.copyright-section {
	text-align: center;
	font-size: 9pt;
	page-break-after: always;
	margin-top: 50pt;
	margin-bottom: 20pt;
}

.toc-title {
	font-size:18pt;
  	font-family: "Gill Sans", sans-serif;
  	text-align: left;
  	margin-left:20pt;
  	margin-bottom: 40pt;

}

/* figures, tables, and listings */

div.confluenceTableSmall th.confluenceTh {
  font-size: 11px;
}

div.confluenceTableSmall td.confluenceTd {
  font-size: 7px;
}

div.figure {
  margin: 1em 0;
  counter-increment: figure;
}

div.figure .caption, div.table .caption {
  font-size: 0.9em;
  font-style: italic;
}

div.figure .caption::before {
  content: "Figure " counter(figure) ". ";
  font-weight: bold;
  font-style: normal;
}

div.table .caption::before {
  content: "Table " counter(table) ". ";
  font-weight: bold;
  font-style: normal;
}

div.table {
  margin: 1em 0;
  counter-increment: table;
}

div.table th {
  text-align: left;
}

table th, table td {
  text-align: left;
  padding-right: 1em;
  page-break-inside: avoid;
}

table th {
  border-top: thin solid;
  border-bottom: thin solid;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
}
table td {
  border-top: none;
  border-bottom: thin dotted;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
}

div.Scrollbar {
	display: none;
}


/* Weird div.codeHeader a b::before would be a better selection
   but prince does not properly match it.. Firefox does. */
div.codeHeader::before {
  content: "Listing " counter(listing) ". ";
  font-weight: bold;
  font-style: normal;
}
div.codeHeader a b {
  font-style: italic;
  font-weight: normal;
}
div.codeHeader {
  font-size: 0.9em;
  counter-increment: listing;
}
div.code {
	border: 1px dashed #c0c0c0;
    font-size: 12px;
	font-family: Courier;
    margin: 5px;
	line-height: 13px;
	padding: 3px;
	background-color: #f8f8f8;

}


@page {
  margin: 2cm;
  size: 7in 9.25in;

  @footnotes {
    border-top: thin solid black;
    padding-top: 0.3em;
    margin-top: 0.6em;
  }
}


/* define default page and names pages: cover, blank, frontmatter */
div.page-reset {
    counter-reset: page 1;
}

@page :left {
  @top-left-corner {
    font-weight: 900; font: 9pt "Gill Sans", serif;
    content: counter(page);
    text-align: left;
    margin-left: 1cm;
    visibility: hidden;
  }
  @top-left {
    font-weight: 900;
    font: 9pt "Gill Sans", serif; white-space: pre; text-transform: uppercase; letter-spacing: 0.1em;
    content: string(header, first);
    visibility: hidden;
  }
  @bottom-left-corner {
    font-weight: 900; font: 9pt "Gill Sans", serif;
    content: counter(page);
    text-align: left;
    margin-left: 1cm;
  }
  @bottom-left {
    font-weight: 900;
    font: 9pt "Gill Sans", serif; white-space: pre; text-transform: uppercase; letter-spacing: 0.1em;
    content: string(header, first);
  }
}

@page :right {
  @top-right-corner {
    font-weight: 900; font: 9pt "Gill Sans", serif;
    content: counter(page);
    text-align: left;
    margin-left: 1cm;
    visibility: hidden;
  }
  @top-right {
    font-weight: 900;
    font: 9pt "Gill Sans", serif; white-space: pre; text-transform: uppercase; letter-spacing: 0.1em;
    content: string(header, first)
    visibility: hidden;
  }
  @bottom-right-corner {
    font-weight: 900; font: 9pt "Gill Sans", serif;
    content: counter(page);
    text-align: right;
    margin-right: 1cm;
  }
  @bottom-right {
    font-weight: 900; font: 9pt "Gill Sans", serif;
    white-space: pre; text-transform: uppercase; letter-spacing: 0.1em;
    content: string(header, first)
  }
}

/*
  In theory we should be able to use the :first selector so taht
  we can put the page numbering on the bottom of the first page of the chapter
  but have the rest of the pages number at the top.  But this does not seem
  to work.  See http://www.princexml.com/doc/6.0/page-selectors/

  So for now just always number at the bottom :(
*/
/*
div.chapter { page: bottom-number; }
@page bottom-number :first {
  @top-left {
    visibility: hidden;
  }
  @bottom-left {
    visibility: visible;
  }
  @top-right {
    visibility: hidden;
  }
  @bottom-right {
    visibility: visible;
  }
}
*/

@page cover { margin: 0; }

@page frontmatter :left {
  @bottom-left-corner {
    content: counter(page, lower-roman);
  }
  @bottom-left-corner {
    content: counter(page, lower-roman);
  }
}

@page frontmatter :right {
  @bottom-right-corner {
    content: counter(page, lower-roman);
  }
  @bottom-right-corner {
    content: counter(page, lower-roman);
  }
}

@page blank :left {
  @top-left { visibility: hidden; }
  @bottom-left { visibility: hidden; }
  @top-left-corner { visibility: hidden; }
  @bottom-left-corner { visibility: hidden; }
}

@page blank :right {
  @top-right { visibility: hidden; }
  @bottom-right { visibility: hidden; }
  @top-right-corner { visibility: hidden; }
  @bottom-right-corner { visibility: hidden; }
}

/* footnotes */
.footnote {
  display: none;                   /* default rule */

  display: prince-footnote;        /* prince-specific rules */
  position: footnote;
  footnote-style-position: inside;

  counter-increment: footnote;
  margin-left: 1.4em;
  font-size: 90%;
  line-height: 1.4;
}

.footnote::footnote-call {
  vertical-align: super;
  font-size: 80%;
}

.footnote::footnote-marker {
  vertical-align: super;
  color: green;
  padding-right: 0.4em;
}

/* Confluence contents to hide */
#labels-section {
	display: none;
}
#comments-section {
	display: none;
}
#footer {
	display: none;
}
.hidden {
	display: none;
}

/*
   A book consists of different types of sections. We propose to use
   DIV elements with these class names:

    frontcover
    halftitlepage: contains the title of the book
    titlepage: contains the title of the book, name of author(s) and publisher
    imprint: left page with copyright, publisher, library printing information
    dedication: right page with short dedication
    foreword: written by someone other than the author(s)
    toc: table of contents
    preface: preface, including acknowledgements
    chapter: each chapter is given its own DIV element
    references: contains list of references
    appendix: each appendix is given its own
    bibliography
    glossary
    index
    colophon: describes how the book was produced
    backcover

   A book will use several of the types listed above, but few books
   will use all of them.
*/

/* which section uses which named page */

div.halftitlepage, div.titlepage, div.imprint, div.dedication { page: blank }
div.foreword, div.toc, div.preface { page: frontmatter }


/* page breaks */
div.frontcover, div.halftitlepage, div.titlepage { page-break-before: right }
div.imprint { page-break-before: always; }
div.chapter { page-break-before: always; }
div.dedication, div.foreword, div.toc, div.preface, div.reference,
div.appendix, div.bibliography, div.glossary, div.index, div.colophon {
  page-break-before: always
}
div.backcover { page-break-before: left }

/* titlepage, halftitlepage */

div.titlepage h1, div.halftitlepage h1 { margin-bottom: 2em; }
div.titlepage h2, div.halftitlepage h2 { font-size: 1.2em; margin-bottom: 3em; }
div.titlepage h3, div.halftitlepage h3 { font-size: 1em; margin-bottom: 3em; }
div.titlepage p, div.halftitlepage p {
  font-size: 1.4em;
  font-weight: bold;
  margin: 0; padding: 0;
}


/* TOC */

ul.toc, ul.toc ul {
  list-style-type: none;
  margin: 0; padding: 0;
  margin-left: 3cm;
}
ul.toc ul {
  margin-left: 1em;
  font-weight: normal;
}
ul.toc > li {
  font-weight: bold;
  margin-bottom: 0.5em;
}
ul.toc a::after {
  content: leader('.') target-counter(attr(href), page);
  font-style: normal;
}
ul.toc > li.frontmatter a::after {
  content: leader('.') target-counter(attr(href), page, lower-roman);
  font-style: normal;
}
ul.toc > li.endmatter a::after {
  content: leader('.') target-counter(attr(href), page);
  font-style: normal;
}
ul.toc > li.chapter::before {
  content: "Chapter " counter(toc-chapter, decimal);
  display: block;
  margin: 1em 0 0.1em -2.5cm;
  font-weight: normal;
  counter-increment: toc-chapter;
  page-break-after: avoid;
}

/* chapter numbers */

div.chapter { counter-increment: chapter; }
div.chapter h1::before {
  text-transform: uppercase;
  letter-spacing: 0.15em;
  content: "Chapter  " counter(chapter) " \A\B0 \B0 \B0 \B0\A";
  white-space: pre;
  font-size: 50%;
}

div.frontcover h1::before, div.titlepage h1::before, div.halftitlepage h1::before {
  content: normal; /* that is, none */
}

h1 { string-set: header content();}
div.chapter h1 { string-set: header "Chapter " counter(chapter) " - " content(); }

/* index */

ul.index {
  list-style-type: none;
  margin: 0; padding: 0;
  column-count: 2;
  column-gap: 1em;
}

ul.index a::after { content: ", " target-counter(attr(href), page); }


span.element, span.attribute {
  text-transform: uppercase;
  font-weight: bold;
  font-size: 80%;
}
span.property { font-weight: bold }
code, span.css, span.value, span.declaration {
  font: 90% "Lucida Console", "Lucida Sans Typewriter", monospace;
}


@media screen, handheld {
  html {font: 14px "Gill Sans", sans-serif; }
  h1 { margin-bottom: 0.5em }
  div.frontcover, div.halftitlepage, div.titlepage, div.imprint,
  div.dedication, div.foreword, div.toc, div.index { display: none }
  body {
      margin: 0cm;
      margin-left: 2cm;
      margin-right: 2cm;
  }
}

/*
 * Enhancements to the take advantage of some of the style markup that
 * Confluence generates
 */
a sup img { visibility: hidden; position: absolute;}

img {
  prince-image-resolution:150dpi;
}

table {
  font: "Lucida Console", "Lucida Sans Typewriter", monospace;
}

table td {
  font-size: 10pt;
}

pre {
   white-space: pre-wrap;
}

.codeContent {
  font-size: 80%;
}
.code {
}
.code-keyword {
  color: #000091;
  background-color: inherit;
}

.code-object {
  color: #910091;
  background-color: inherit;
}

.code-quote {
  color: #009100;
  background-color: inherit;
}

.code-comment {
  color: #808080;
  background-color: inherit;
}


.code-xml .code-keyword {
  color: inherit;
  font-weight: bold;
}

.code-tag {
  color: #000091;
  background-color: inherit;
}

.noteMacro { border-color: #F0C000; background-color: #FFFFCE;}
.warningMacro { border-color: #CC0000; background-color: #FFCCCC }
.infoMacro { border-color: #3c78b5; background-color: #D8E4F1; }
.tipMacro { border-color: #090; background-color: #dfd;}
.noteMacro, .warningMacro, .infoMacro, .tipMacro, .informationMacroPadding {
  border: thin solid;
  float: top-next;
  margin: 1em 0 1.2em 0;
  padding: 0.5em;
  column-count: 2;
  column-gap: 1.5em;
  width: 100%;
}
table.infoMacro td, table.warningMacro td, table.tipMacro td, table.noteMacro td, table.sectionMacro td {
    border: none;
}
table.infoMacro p, table.warningMacro p, table.tipMacro p, table.noteMacro p, table.sectionMacro p {
    font-size:x-small;
    margin-top: 1em;
}
  </style>
  <style type="text/css">
.syntax .hll { background-color: #ffffcc }
.syntax  { background: #f0f0f0; }
.syntax .c { color: #60a0b0; font-style: italic } /* Comment */
.syntax .err { border: 1px solid #FF0000 } /* Error */
.syntax .k { color: #007020; font-weight: bold } /* Keyword */
.syntax .o { color: #666666 } /* Operator */
.syntax .cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.syntax .cp { color: #007020 } /* Comment.Preproc */
.syntax .c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.syntax .cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.syntax .gd { color: #A00000 } /* Generic.Deleted */
.syntax .ge { font-style: italic } /* Generic.Emph */
.syntax .gr { color: #FF0000 } /* Generic.Error */
.syntax .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.syntax .gi { color: #00A000 } /* Generic.Inserted */
.syntax .go { color: #808080 } /* Generic.Output */
.syntax .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.syntax .gs { font-weight: bold } /* Generic.Strong */
.syntax .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.syntax .gt { color: #0040D0 } /* Generic.Traceback */
.syntax .kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.syntax .kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.syntax .kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.syntax .kp { color: #007020 } /* Keyword.Pseudo */
.syntax .kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.syntax .kt { color: #902000 } /* Keyword.Type */
.syntax .m { color: #40a070 } /* Literal.Number */
.syntax .s { color: #4070a0 } /* Literal.String */
.syntax .na { color: #4070a0 } /* Name.Attribute */
.syntax .nb { color: #007020 } /* Name.Builtin */
.syntax .nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.syntax .no { color: #60add5 } /* Name.Constant */
.syntax .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.syntax .ni { color: #d55537; font-weight: bold } /* Name.Entity */
.syntax .ne { color: #007020 } /* Name.Exception */
.syntax .nf { color: #06287e } /* Name.Function */
.syntax .nl { color: #002070; font-weight: bold } /* Name.Label */
.syntax .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.syntax .nt { color: #062873; font-weight: bold } /* Name.Tag */
.syntax .nv { color: #bb60d5 } /* Name.Variable */
.syntax .ow { color: #007020; font-weight: bold } /* Operator.Word */
.syntax .w { color: #bbbbbb } /* Text.Whitespace */
.syntax .mf { color: #40a070 } /* Literal.Number.Float */
.syntax .mh { color: #40a070 } /* Literal.Number.Hex */
.syntax .mi { color: #40a070 } /* Literal.Number.Integer */
.syntax .mo { color: #40a070 } /* Literal.Number.Oct */
.syntax .sb { color: #4070a0 } /* Literal.String.Backtick */
.syntax .sc { color: #4070a0 } /* Literal.String.Char */
.syntax .sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.syntax .s2 { color: #4070a0 } /* Literal.String.Double */
.syntax .se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.syntax .sh { color: #4070a0 } /* Literal.String.Heredoc */
.syntax .si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.syntax .sx { color: #c65d09 } /* Literal.String.Other */
.syntax .sr { color: #235388 } /* Literal.String.Regex */
.syntax .s1 { color: #4070a0 } /* Literal.String.Single */
.syntax .ss { color: #517918 } /* Literal.String.Symbol */
.syntax .bp { color: #007020 } /* Name.Builtin.Pseudo */
.syntax .vc { color: #bb60d5 } /* Name.Variable.Class */
.syntax .vg { color: #bb60d5 } /* Name.Variable.Global */
.syntax .vi { color: #bb60d5 } /* Name.Variable.Instance */
.syntax .il { color: #40a070 } /* Literal.Number.Integer.Long */


/* don't highlight errors */
.syntax .err {
  border: none;
}

.syntax {
  font-size: .9em;
  font-family:Monaco,"Courier New","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;
  background-color: #F8F8FF;

  overflow:auto;
  -moz-background-clip:border;
  -moz-background-inline-policy:continuous;
  -moz-background-origin:padding;
  margin: 1em 0 1em 0;
  border:1px solid #DDDDDD;

  border-top-left-radius: 8px; -webkit-border-top-left-radius: 8px; -moz-border-radius-topleft: 8px;
  border-top-right-radius: 8px; -webkit-border-top-right-radius: 8px; -moz-border-radius-topright: 8px;
  border-style: solid;  border-width: 1px; border-color: #dedede !important;
  padding: 1em;
}
.syntax .linenodiv  {
  background-color:#ECECEC;
  border-right:1px solid #DDDDDD;
  color:#AAAAAA;
  padding: .5em;
  text-align:right;
}
.syntax .highlight  {
}
.syntax pre {
  margin:0;
}

pre.syntax {
  padding: .5em;
  background-color: #F8F8FF; overflow:auto;
}

.syntax code {
  font-family:Monaco,"Courier New","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;
  font-size: 10pt;
}

div.compare { width: 700px; }
div.compare div.compare-left { float:left; width:340px; padding:5px; margin-top: 15px; }
div.compare div.compare-right { float:right; width:340px; padding:5px; margin-top: 15px; }
div.compare div h3 {
  margin-left: 15px;
  padding: 5px 15px;
  display: inline;
  font-size: .8em;
  color: #666;

  border-top: 1px solid #ccc; -moz-border-top-colors: #ccc white white #e5e5e5;
  border-left: 1px solid #ccc; -moz-border-left-colors: #ccc white white #e5e5e5;
  border-right: 1px solid #ccc;-moz-border-right-colors: #ccc white white #e5e5e5;
  border-top-left-radius: 8px; -webkit-border-top-left-radius: 8px;  -moz-border-radius-topleft: 8px;
  border-top-right-radius: 8px; -webkit-border-top-right-radius: 8px; -moz-border-radius-topright: 8px;
}
div.compare div div {
  margin: 5px 0px 0px 0px;
}
.clear {
  clear:both;
}
.wide div.compare div.compare-left { float:none; width:700px; }
.wide div.compare div.compare-right { float:none; width:700px; }

  </style>

  <title>Apache Karaf ${karaf.version}</title>
</head>
<body>
  <div id="titlepage">
    <div id="title">Apache Karaf</div>
    <div id="subtitle">Version 2.3.0</div>
  </div>
  <div id="main">
    <div class="title"><p><img border="0" src="images/karaf-logos.png"/><br/><br/><br/><br/><br/><br/><br/><br/><br/>Apache Karaf<br/>Users' Guide<br/><br/><br/><br/><br/><br/><br/><br/></p></div><div class="copyright-section"><p>Copyright 2011 The Apache Software Foundation</p><p>The PDF format of the Karaf Manual has been generated by Prince XML (http://www.princexml.com).</p></div><div class="toc-title"><p>Table of contents</p></div><ol style="list-style: none;"><li><a href="#Overview.html">Overview</a></li><li><a href="#QuickStart.html">Quick Start</a></li><li><a href="#UsersGuide.html">Users Guide</a></li><li><a href="#DevelopersGuide.html">Developers Guide</a></li></ol><h1 id="Overview">Overview</h1><h1 id="KarafOverview">Karaf Overview</h1><p>Apache Karaf is a small OSGi based runtime which provides a lightweight container onto which various components and applications can be deployed.</p><p>Here is a short list of features supported by the Karaf:</p><ul><li><strong>Hot deployment</strong>: Karaf supports hot deployment of OSGi bundles by monitoring jar files inside the <tt>[home]/deploy</tt> directory.  Each time a jar is copied in this folder, it will be installed inside the runtime.  You can then update or delete it and changes will be handled automatically.  In addition, Karaf also supports exploded bundles and custom deployers (Blueprint and Spring ones are included by default).</li><li><strong>Dynamic configuration</strong>: Services are usually configured through the ConfigurationAdmin OSGi service.  Such configuration can be defined in Karaf using property files inside the <tt>[home]/etc</tt> directory.  These configurations are monitored and changes on the properties files will be propagated to the services.</li><li><strong>Logging System</strong>: using a centralized logging back end supported by Log4J, Karaf supports a number of different APIs (JDK 1.4, JCL, SLF4J, Avalon, Tomcat, OSGi)</li><li><strong>Provisioning</strong>: Provisioning of libraries or applications can be done through a number of different ways, by which they will be downloaded locally, installed and started.</li><li><strong>Native OS integration</strong>: Karaf can be integrated into your own Operating System as a service so that the lifecycle will be bound to your Operating System.</li><li><strong>Extensible Shell console</strong>: Karaf features a nice text console where you can manage the services, install new applications or libraries and manage their state.  This shell is easily extensible by deploying new commands dynamically along with new features or applications.</li><li><strong>Remote access</strong>: use any SSH client to connect to Karaf and issue commands in the console</li><li><strong>Security framework</strong> based on JAAS</li><li><strong>Managing instances</strong>: Karaf provides simple commands for managing multiple instances. You can easily create, delete, start and stop instances of Karaf through the console.</li><li>Supports the latest OSGi 4.2 containers: Apache Felix Framework 3.0 and Eclipse Equinox 3.6</li></ul><p><img border="0" src="images/karaf.png"/></p><h1 id="QuickStart">Quick Start</h1><h1 id="a1.QuickStart">1. Quick Start</h1><p>If you are in a hurry to have Apache Karaf up and running right away, this section will provide you with some basic steps for downloading, building (when needed) and running the server in no time. This is clearly not a complete guide so you may want to check other sections of this guide for further information.</p><p>All you need is 5 to 10 minutes and to follow these basic steps.</p><ul><li><a href="#Background.html">Background</a></li><li><a href="#Gettingthesoftware.html">Getting the software</a></li><li><a href="#Starttheserver.html">Start the server</a></li><li><a href="#Deployasampleapplication.html">Deploy a sample application</a></li></ul><h2 id="Background">Background</h2><p>Apache Karaf is a small and lightweight OSGi based runtime.  This provides a small lightweight container onto which various bundles can be deployed.</p><p>Apache Karaf started life as the <a href="http://servicemix.apache.org">Apache ServiceMix</a> kernel and then moved as a <a href="http://felix.apache.org">Apache Felix</a> subproject before becoming a top level project.</p><h2 id="Gettingthesoftware">Getting the software</h2><p>At this time you have one option to get the software. The fastest and easiest way is to get the binary directly from the Apache site. Since this article is intended to help you to have Apache Karaf up and running in the fastest way only the binary download will be covered at this time.</p><h3 id="Prerequisites">Prerequisites</h3><p>Although this installation path is the fastest one, you will still need to install some software before installing Karaf.</p><p>Karaf requires a Java SE 5 environment to run. Refer to <a href="http://www.oracle.com/technetwork/java/javase/">http://www.oracle.com/technetwork/java/javase/</a> for details on how to download and install Java SE 1.5 or greater.</p><h3 id="Downloadbinaries">Download binaries</h3><p>You will need to select the appropriate installation image for the platform you're using to run Karaf. Open a Web browser and access the following URL, there you will find the available packages for download (binaries and source code).</p><p><a href="http://karaf.apache.org/index/community/download.html">http://karaf.apache.org/index/community/download.html</a></p><p>Select the file compression format compatible with your system (zip for windows, tar.gz for unixes) by clicking directly on the link, download it and expand the binary to your hard drive in a new directory; for example in z:\karaf - from now on this directory will be referenced as &lt;KARAF_HOME>. Please remember the restrictions concerning illegal characters in Java paths, e.g. !, % etc.</p><p>The installation of Karaf is as simple as uncompressing the .zip or .tar.gz files. The next step is to start the server.</p><h2 id="Starttheserver">Start the server</h2><p>With Karaf already installed, open a command line console and change directory to &lt;KARAF_HOME>. To start the server, run the following command in Windows:</p><pre>
bin\karaf.bat
</pre><p>respectively on Unix:</p><pre>
bin/karaf
</pre><p>You should see the following information on the command line console:</p><p>You can now run your first command.  Simply type the <tt>&lt;tab></tt> key in the console.</p><pre>
karaf@root> 

admin:change-port         admin:connect             admin:create              admin:destroy
admin:list                admin:start               admin:stop                config:cancel
config:edit               config:list               config:propappend         config:propdel
config:proplist           config:propset            config:update             dev:dynamic-import
dev:framework             dev:print-stack-traces    dev:show-tree             features:addUrl
features:info             features:install          features:list             features:listUrl
features:refreshUrl       features:removeUrl        features:uninstall        log:display
log:display-exception     log:get                   log:set                   osgi:bundle-level
osgi:headers              osgi:install              osgi:list                 osgi:ls
osgi:refresh              osgi:resolve              osgi:restart              osgi:shutdown
osgi:start                osgi:start-level          osgi:stop                 osgi:uninstall
osgi:update               packages:exports          packages:imports          shell:cat
shell:clear               shell:each                shell:echo                shell:exec
shell:grep                shell:history             shell:if                  shell:info
shell:java                shell:logout              shell:new                 shell:printf
shell:sleep               shell:sort                shell:tac                 ssh:ssh
ssh:sshd                  cat                       clear                     each
echo                      exec                      grep                      history
if                        info                      java                      logout
new                       printf                    sleep                     sort
tac                       bundle-level              headers                   install
list                      ls                        refresh                   resolve
restart                   shutdown                  start                     start-level
stop                      uninstall                 update
karaf@root> 
</pre><p>You can then grab more specific help for a given command using the <tt>--help</tt> option for this command:</p><pre>
karaf@root> admin:create --help
DESCRIPTION
	admin:create

	Create a new instance.

SYNTAX
	admin:create [options] name

ARGUMENTS
        name
                The name of the new container instance

OPTIONS
        --help
                Display this help message
        -f, --feature
                Initial features. This option can be specified multiple times to enable multiple initial 
                features
        -p, --port
                Port number for remote shell connection
        -l, --location
                Location of the new container instance in the file system
        -furl, --featureURL
                Additional feature descriptor URLs. This option can be specified multiple times to add 
                multiple URLs

karaf@root> 
</pre><p>Note that the console supports tab completion, so you just need to enter <tt>ad &lt;tab> cr &lt;tab></tt> instead of <tt>admin:create</tt>.</p><h2 id="Deployasampleapplication">Deploy a sample application</h2><p>While you will learn in the Karaf user's guide how to fully use and leverage Apache Karaf, let's install a sample <a href="http://camel.apache.org">Apache Camel</a> application for now:</p><p>In the console, run the following commands:</p><pre>
features:addurl mvn:org.apache.camel/camel-example-osgi/2.10.0/xml/features
features:install camel-example-osgi
</pre><p>The example installed is using Camel to start a timer every 2 seconds and output a message on the console.<br/>The previous commands download the Camel features descriptor and install the example feature.</p><pre>
>>>> SpringDSL set body:  Fri Jan 07 11:59:51 CET 2011
>>>> SpringDSL set body:  Fri Jan 07 11:59:53 CET 2011
>>>> SpringDSL set body:  Fri Jan 07 11:59:55 CET 2011

</pre><h3 id="Stoppinganduninstallingthesampleapplication">Stopping and uninstalling the sample application</h3><p>To stop this demo, run the following command:</p><pre>
features:uninstall camel-example-osgi
</pre><h3 id="CommonProblems">Common Problems</h3><ol><li>Launching Karaf can result in a deadlock in Felix during module dependency resolution.<p>This is often a result of sending a SIGINT (control-C) to the process when it will not cleanly exit.<br/>This can corrupt the caches and cause startup problems in the very next launch. It is fixed by emptying the component cache:</p><pre>
rm -rf data/cache/*
</pre></li></ol><h2 id="StoppingKaraf">Stopping Karaf</h2><p>To stop Karaf from the console, enter <tt>^D</tt> in the console:</p><pre>
^D
</pre><p>Alternatively, you can also run the following command:</p><pre>
osgi:shutdown
</pre><h2 id="Summary">Summary</h2><p>This document showed how simple it is to have Apache Karaf up and running. The overall time for getting the server running should be less than five<br/>minutes if you have the prerequisite (Java 1.5) already installed. Additionally, this article also showed you how to deploy and test a simple<br/>Apache Camel application.</p><h1 id="UsersGuide">Users Guide</h1><h1 id="Installation">Installation</h1><p>This chapter describes how to install Apache Karaf for both Unix and Windows platforms, including<br/>prerequisite software and necessary download links.</p><h2 id="PreInstallationRequirements">Pre-Installation Requirements</h2><p><strong>Hardware:</strong></p><ul><li>20 MB of free disk space for the Apache Karaf x.y binary distribution.</li></ul><p><strong>Operating Systems:</strong></p><ul><li>Windows: Windows Vista, Windows XP SP2, Windows 2000.</li><li>Unix: Ubuntu Linux, Powerdog Linux, MacOS, AIX, HP-UX, Solaris, any Unix platform that supports Java.</li></ul><p><strong>Environment:</strong></p><ul><li>Java SE Development Kit 1.5.x or greater (<a href="http://www.oracle.com/technetwork/java/javase/">http://www.oracle.com/technetwork/java/javase/</a>).</li><li>The JAVA_HOME environment variable must be set to the directory where the Java runtime is installed, e.g., <tt>c:\Program Files\jdk.1.5.0_06</tt>. To accomplish that, press Windows key and Break key together, switch to "Advanced" tab and click on "Environment Variables". Here, check for the variable and, if necessary, add it.</li></ul><h2 id="BuildingfromSources">Building from Sources</h2><p>If you intend to build Karaf from the sources, the requirements are a bit different:</p><p><strong>Hardware:</strong></p><ul><li>200 MB of free disk space for the Apache Karaf x.y source distributions or SVN checkout, the Maven build and the dependencies Maven downloads.</li></ul><p><strong>Environment:</strong></p><ul><li>Java SE Developement Kit 1.5.x or greater (<a href="http://www.oracle.com/technetwork/java/javase/">http://www.oracle.com/technetwork/java/javase/</a>).</li><li>Apache Maven 2.2.1 (<a href="http://maven.apache.org/download.html">http://maven.apache.org/download.html</a>).</li></ul><h3 id="BuildingonWindows">Building on Windows</h3><p>This procedure explains how to download and install the source distribution on a Windows system. <strong>NOTE:</strong> Karaf requires Java 5 is compile, build and run.</p><ol><li>From a browser, navigate to <a href="http://karaf.apache.org/index/community/download.html">http://karaf.apache.org/index/community/download.html</a>.</li><li>Scroll down to the "Apache Karaf" section and select the desired distribution.<p>For a source distribution, the filename will be similar to: <tt>apache-karaf-x.y-src.zip</tt>.</p></li><li>Extract Karaf from the ZIP file into a directory of your choice. Please remember the restrictions concerning illegal characters in Java paths, e.g. !, % etc.</li><li><span id="WindowsSourceInstallation"></span> Build Karaf using Maven 2.2.1 or greater and Java 5.<p>The recommended method of building Karaf is the following:</p><pre>
cd [karaf_install_dir]\src
</pre><p> where <tt>[karaf_install_dir]</tt> is the directory in which Karaf was installed.</p><pre>
mvn
</pre><p>Both steps take around 10 to 15 minutes.</p></li><li>Unzip the distribution using your favorite zip tool. The windows distribution is available at<pre>
[karaf_install_dir]\assembly\target\apache-karaf-x.y.zip
</pre></li><li>Proceed to the <a href="start-stop#Starting Karaf.html">Starting Karaf</a> chapter.</li></ol><h3 id="BuildingonUnix">Building on Unix</h3><p>This procedure explains how to download and install the source distribution on a Unix system. This procedure assumes the Unix machine has a browser. Please see the previous <a href="#UnixBinaryInstallation.html">Unix Binary Installation</a> section for ideas on how to install Karaf without a browser. <strong>NOTE:</strong> Karaf requires Java 5 to compile, build and run.</p><ol><li>From a browser, navigate to <a href="http://karaf.apache.org/download.html">http://karaf.apache.org/download.html</a>.</li><li>Scroll down to the "Apache Karaf" section and select the desired distribution.<p>For a source distribution, the filename will be similar to: <tt>apache-karaf-x.y-src.tar.gz</tt>.</p></li><li>Extract the files from the ZIP file into a directory of your choice. For example:<pre>
gunzip apache-karaf-x.y-src.tar.gz
tar xvf apache-karaf-x.y-src.tar
</pre><p>Please remember the restrictions concerning illegal characters in Java paths, e.g. !, % etc.</p></li><li>Build Karaf using Maven:<p>The preferred method of building Karaf is the following:</p><pre>
cd [karaf_install_dir]/src
</pre><p> where [karaf_install_dir] is the directory in which Karaf was installed.</p><pre>
mvn
</pre></li><li>Uncompress the distribution that has just been created<pre>
cd [karaf_install_dir]/assembly/target
gunzip apache-karaf-x.y.tar.gz
tar xvf apache-karaf-x.y.tar
</pre></li><li>Proceed to the <a href="start-stop#Starting Karaf.html">Starting Karaf</a> chapter.</li></ol><h2 id="InstallationProcedureforWindows">Installation Procedure for Windows</h2><p>This procedure explains how to download and install the binary distribution on a Windows system.</p><ol><li>From a browser, navigate to <a href="http://karaf.apache.org/index/community/download.html">http://karaf.apache.org/index/community/download.html</a>.</li><li>Scroll down to the "Apache Karaf" section and select the desired distribution.<p>For a binary distribution, the filename will be similar to: <tt>apache-karaf-x.y.zip</tt>.</p></li><li>Extract the files from the ZIP file into a directory of your choice. Please remember the restrictions concerning illegal characters in Java paths, e.g. !, % etc.</li><li>Proceed to the <a href="start-stop#Starting Karaf.html">Starting Karaf</a> chapter.</li><li>Optional: see <a href="colorized-console.html">enabling Colorized Console Output On Windows</a></li></ol><div class="tip" style="border: 1px solid #090;background-color: #dfd;margin: 20px;padding: 0px 6px 0px 6px;"><p><b>Handy Hint</b></p><p>In case you have to install Karaf into a very deep path or a path containing illegal characters for Java paths, e.g. !, % etc., you may add a bat file to <em>start \-> startup</em> that executes</p><pre>subst S: "C:\your very % problematic path!\KARAF"
</pre><p>so your Karaf root directory is S: <del>-</del> which works for sure and is short to type.</p></div><h2 id="InstallationProcedureForUnix">Installation Procedure For Unix</h2><p>This procedure explains how to download and install the binary distribution on a Unix system.</p><ol><li>From a browser, navigate to <a href="http://karaf.apache.org/download.html">http://karaf.apache.org/download.html</a>.</li><li>Scroll down to the "Apache Karaf" section and select the desired distribution.<p>For a binary Unix distribution, the filename will be similar to: apache-karaf-x.y.tar.gz.</p></li><li>Extract the files from the gzip file into a directory of your choice. For example:<pre>
gunzip apache-karaf-x.y.tar.gz
tar xvf apache-karaf-x.y.tar
</pre><p>Please remember the restrictions concerning illegal characters in Java paths, e.g. !, % etc.</p></li><li>Proceed to the <a href="start-stop#Starting Karaf.html">Starting Karaf</a> chapter.</li></ol><h2 id="PostInstallationsteps">Post-Installation steps</h2><p>Thought it is not always required, it is strongly advised to set up the <tt>JAVA_HOME</tt> environment property to point to the JDK you want Karaf to use before starting it.<br/>This property is used to locate the <tt>java</tt> executable and should be configured to point to the home directory of the Java SE 5 or 6 installation.</p><h1 id="Directorystructure">Directory structure</h1><p>The directory layout of a Karaf installation is as follows:</p><ul><li><tt>/bin</tt>: startup scripts</li><li><tt>/etc</tt>: configuration files</li><li><tt>/data</tt>: working directory <ul><li><tt>/cache</tt>: OSGi framework bundle cache</li><li><tt>/generated-bundles</tt>: temporary folder used by the deployer</li><li><tt>/log</tt>: log files</li></ul></li><li><tt>/deploy</tt>: hot deploy directory</li><li><tt>/instances</tt>: directory containing <a href="users-guide/child-instances.html">child instances</a></li><li><tt>/lib</tt>: contains the bootstrap libraries<ul><li><tt>/lib/ext</tt>: directory for JRE extensions</li><li><tt>/lib/endorsed</tt>: directory for endorsed libraries</li></ul></li><li><tt>/system</tt>: OSGi bundles repository, laid out as a Maven 2 repository</li></ul><div class="tip" style="border: 1px solid #090;background-color: #dfd;margin: 20px;padding: 0px 6px 0px 6px;"><p>The <tt>data</tt> folder contains all the working and temporary files for Karaf.  If you want to restart from a clean state, you can wipe out this directory, which has the same effect as <a href="start-stop#Starting Karaf from clean.html">using the clean option</a>.</p></div>	<h1 id="StartingandStoppingKaraf">Starting and Stopping Karaf</h1><p>This chapter describes how to start and stop Apache Karaf and the various options that are available.</p><h2 id="StartingKaraf">Starting Karaf</h2><h3 id="OnWindows">On Windows</h3><p>From a console window, change to the installation directory and run <tt>Karaf</tt>. For the binary distribution, go to</p><pre>
cd [karaf_install_dir]
</pre><p>where <tt>karaf_install_dir</tt> is the directory in which Karaf was installed, e.g., <tt>c:\Program Files\apache-karaf-x.y</tt>.</p><p>Then type:</p><pre>
bin\karaf.bat
</pre><h3 id="OnUnix">On Unix</h3><p>From a command shell, change to the installation directory and run <tt>Karaf</tt>. For the binary distribution, go to</p><pre>
cd [karaf_install_dir]
</pre><p>where <tt>karaf_install_dir</tt> is the directory in which Karaf was installed, e.g., <tt>/usr/local/apache-karaf-x.y</tt>.</p><p>Then type:</p><pre>
bin/karaf
</pre><div class="warning" style="border: 1px solid #c00;background-color: #fcc;margin: 20px;padding: 0px 6px 0px 6px;"><p><b>Warning</b></p><p>Do NOT close the console or shell in which Karaf was started, as that will terminate Karaf (unless Karaf was started with nohup).</p></div><h2 id="StartingKarafwithoutconsole">Starting Karaf without console</h2><p>Karaf can be started without the console if you don't intend to use it (one can always connect using the remote ssh access) using the following command:</p><pre>
bin\karaf.bat server
</pre><p>or, on Unix:</p><pre>
bin\karaf server
</pre><h2 id="StartingKarafinthebackground">Starting Karaf in the background</h2><p>Karaf can be easily started as a background process using the following command:</p><pre>
bin\start.bat
</pre><p>or, on Unix:</p><pre>
bin\start
</pre><h2 id="StartingKaraffromclean">Starting Karaf from clean</h2><p>Karaf can be reset to a clean state by simply deleting the <tt>[karaf_install_dir]/data</tt> folder.<br/>For convenience, a parameter on the <tt>karaf</tt> and <tt>start</tt> scripts is available:</p><pre>
bin/start clean
</pre><h2 id="StoppingKaraf">Stopping Karaf</h2><p>For both Windows and Unix installations, you can perform a clean shutdown of Karaf by using the following command when inside a Karaf console:</p><pre>
osgi:shutdown
</pre><p>or simply:</p><pre>
shutdown
</pre><p>The shutdown command asks you to confirm that you really want to shutdown. If you are sure about the shutdown and avoid the confirmation message, you can use the -f or --force option:</p><pre>
osgi:shutdown -f
</pre><p>It's also possible to delay the shutdown using the time argument. The time argument can have different formats. First, it can be an absolute time in the format hh:mm, in which hh is the hour (1 or 2 digits) and mm is the minute of the hour (in two digits). Second, it can be in the format +m, in which m is the number of minutes to wait. The work now is an alias for +0.</p><p>The following command will shutdown Karaf at 10:35am:</p><pre>
osgi:shutdown 10:35
</pre><p>The following command will shutdown Karaf in 10 minutes:</p><pre>
osgi:shutdown +10
</pre><p>If you're running from the main console, exiting the shell using <tt>logout</tt> or <tt>Ctrl+D</tt> will also terminate the Karaf instance.</p><p>From a command shell, you can run the following command:</p><pre>
bin\stop.bat
</pre><p>or, on Unix:</p><pre>
bin/stop
</pre><h1 id="ServiceWrapper">Service Wrapper</h1><h2 id="Introduction">Introduction</h2><p>The Karaf Wrapper (for service wrapper) makes it possible to install Karaf as a Windows Service. Likewise, the scripts shipped with Karaf also make it very easy to install Karaf as a daemon process on Unix systems.</p><p>The Wrapper correctly handles "user's log outs" under Windows, service dependencies, and the ability to run services which interact with the desktop.</p><h2 id="Supportedplatforms">Supported platforms</h2><p>The following platforms are supported by the Karaf Wrapper:</p><ul><li>AIX</li><li>FreeBSD</li><li>HP-UX, 32-bit and 64-bit versions</li><li>SGI Irix</li><li>Linux kernels 2.2.x, 2.4.x, 2.6.x. Known to work with Debian, Ubuntu, and Red Hat, but should work with any distribution. Currently supported on both 32-bit and 64-bit x86, Itanium, and PPC systems.</li><li>Macintosh OS X</li><li>Sun OS, Solaris 9 and 10. Currently supported on both 32-bit and 64-bit sparc, and x86 systems.</li><li>Windows - Windows 2000, XP, 2003, Vista, 2008 and Windows 7. Currently supported on both 32-bit and 64-bit x86 and Itanium systems. Also known to run on Windows 98 and ME, however due the lack of support for services in the OS, the Wrapper can be run only in console mode.</li></ul><h2 id="Installation">Installation</h2><p>Karaf Wrapper is an optional feature. To install it, simply type:</p><pre>
karaf@root> features:install wrapper
</pre><p>Once installed, wrapper feature will provide <tt>wrapper:install</tt> new command in the Karaf shell:</p><pre>
karaf@root> wrapper:install --help
DESCRIPTION
        wrapper:install

        Install the container as a system service in the OS.

SYNTAX
        wrapper:install [options]

OPTIONS
        -s, --start-type
                Mode in which the service is installed. AUTO_START or DEMAND_START (Default: AUTO_START)
                (defaults to AUTO_START)
        --help
                Display this help message
        -n, --name
                The service name that will be used when installing the service. (Default: karaf)
                (defaults to karaf)
        -d, --display
                The display name of the service.
        -D, --description
                The description of the service.
                (defaults to )
</pre><p>Using <tt>wrapper:install</tt>, you can install Karaf as a service.</p><p>For instance, to register Karaf as a service (depending of the running OS), in automatic start mode, simply type:</p><pre>
karaf@root> wrapper:install -s AUTO_START -n KARAF -d Karaf -D "Karaf Service"
</pre><p>For instance, on Linux, <tt>wrapper:install</tt> command will do:</p><pre>
karaf@root> wrapper:install -s AUTO_START -n KARAF -d Karaf -D "Karaf Service"
Creating file: /home/onofreje/apache-karaf-2.1.3/bin/KARAF-wrapper
Creating file: /home/onofreje/apache-karaf-2.1.3/bin/KARAF-service
Creating file: /home/onofreje/apache-karaf-2.1.3/etc/KARAF-wrapper.conf
Creating file: /home/onofreje/apache-karaf-2.1.3/lib/libwrapper.so
Creating file: /home/onofreje/apache-karaf-2.1.3/lib/karaf-wrapper.jar
Creating file: /home/onofreje/apache-karaf-2.1.3/lib/karaf-wrapper-main.jar

Setup complete.  You may wish to tweak the JVM properties in the wrapper configuration file:
        /home/onofreje/apache-karaf-2.1.3/etc/KARAF-wrapper.conf
before installing and starting the service.

The way the service is installed depends upon your flavor of Linux.

On Redhat/Fedora/CentOS Systems:
  To install the service:
    $ ln -s /home/onofreje/apache-karaf-2.1.3/bin/KARAF-service /etc/init.d/
    $ chkconfig KARAF-service --add

  To start the service when the machine is rebooted:
    $ chkconfig KARAF-service on

  To disable starting the service when the machine is rebooted:
    $ chkconfig KARAF-service off

  To start the service:
    $ service KARAF-service start

  To stop the service:
    $ service KARAF-service stop

  To uninstall the service :
    $ chkconfig KARAF-service --del
    $ rm /etc/init.d/KARAF-service

On Ubuntu/Debian Systems:
  To install the service:
    $ ln -s /home/onofreje/apache-karaf-2.1.3/bin/KARAF-service /etc/init.d/

  To start the service when the machine is rebooted:
    $ update-rc.d KARAF-service defaults

  To disable starting the service when the machine is rebooted:
    $ update-rc.d -f KARAF-service remove

  To start the service:
    $ /etc/init.d/KARAF-service start

  To stop the service:
    $ /etc/init.d/KARAF-service stop

  To uninstall the service :
    $ rm /etc/init.d/KARAF-service

</pre><h1 id="Usingtheconsole">Using the console</h1><h2 id="Viewingavailablecommands">Viewing available commands</h2><p>To see a list of the available commands in the console press the <tt>&lt;tab></tt> key at the prompt.</p><pre>
root@root> Display all 182 possibilities? (y or n)
*:help                           addurl                           admin:change-opts
admin:change-rmi-registry-port   admin:change-ssh-port            admin:connect
admin:create                     admin:destroy                    admin:list
admin:rename                     admin:start                      admin:stop
bundle-level                     cancel                           cat
change-opts                      change-rmi-registry-port         change-ssh-port
clear                            commandlist                      config:cancel
config:edit                      config:list                      config:propappend
config:propdel                   config:proplist                  config:propset
config:update                    connect                          create
create-dump                      destroy                          dev:create-dump
dev:dynamic-import               dev:framework                    dev:print-stack-traces
dev:restart                      dev:show-tree                    dev:watch
display                          display-exception                dynamic-import
each                             echo                             edit
exec                             exports                          features:addurl
features:info                    features:install                 features:list
features:listrepositories        features:listurl                 features:listversions
features:refreshurl              features:removerepository        features:removeurl
features:uninstall               framework                        get
grep                             head                             headers
help                             history                          if
imports                          info                             install
jaas:cancel                      jaas:commandlist                 jaas:list
jaas:manage                      jaas:roleadd                     jaas:roledel
jaas:update                      jaas:useradd                     jaas:userdel
jaas:userlist                    java                             list
listrepositories                 listurl                          listversions
log:clear                        log:display                      log:display-exception
log:get                          log:set                          log:tail
logout                           ls                               manage
more                             new                              osgi:bundle-level
osgi:headers                     osgi:info                        osgi:install
osgi:list                        osgi:ls                          osgi:refresh
osgi:resolve                     osgi:restart                     osgi:shutdown
osgi:start                       osgi:start-level                 osgi:stop
osgi:uninstall                   osgi:update                      packages:exports
packages:imports                 print-stack-traces               printf
propappend                       propdel                          proplist
propset                          refresh                          refreshurl
removerepository                 removeurl                        rename
resolve                          restart                          roleadd
roledel                          set                              shell:cat
shell:clear                      shell:each                       shell:echo
shell:exec                       shell:grep                       shell:head
shell:history                    shell:if                         shell:info
shell:java                       shell:logout                     shell:more
shell:new                        shell:printf                     shell:sleep
shell:sort                       shell:tac                        shell:tail
show-tree                        shutdown                         sleep
sort                             ssh                              ssh:ssh
ssh:sshd                         sshd                             start
start-level                      stop                             tac
tail                             uninstall                        update
useradd                          userdel                          userlist
watch
root@root>
</pre><p>The <tt>&lt;tab></tt> key toggles autocompletion anywhere on the line, so if you want to see the commands in the <tt>osgi</tt> group, type the first letters and hit <tt>&lt;tab></tt>.  Depending on the commands, autocompletion may be available for options and arguments too.</p><h2 id="Gettinghelpforacommand">Getting help for a command</h2><p>To view help on a particular command, type the command followed by <tt>--help</tt> or use the <tt>help</tt> command followed by the name of the command:</p><pre>
karaf@root> features:list --help
DESCRIPTION
        features:list

        Lists all existing features available from the defined repositories.

SYNTAX
        features:list [options]

OPTIONS
        --help
                       Display this help message
        -i, --installed
                       Display a list of all installed features only
</pre><h2 id="More...">More...</h2><p>The list of all available commands and their usage is also available in a <a href="commands/commands.html">dedicated section</a>.</p><p>You'll find a more in-depth guide to the shell syntax in the <a href="developers-guide/shell-syntax.html">developers guide</a>.</p><p>The console can also be easily extended by creating new commands as explained in the <a href="developers-guide/extending-console.html">developers guide</a>.</p><h1 id="Usingremoteinstances">Using remote instances</h1><h2 id="Configuringremoteinstances">Configuring remote instances</h2><p>It does not always make sense to manage an instance of Karaf using its local console. You can manage Karaf remotely using a remote console.</p><p>When you start Karaf, it enables a remote console that can be accessed over SSH from any other Karaf console or plain SSH client.  The remote console provides all the features of the local console and gives a remote user complete control over the container and services running inside of it.</p><p>The SSH hostname and port number is configured in the <tt>[karaf_install_dir]/etc/org.apache.karaf.shell.cfg</tt> configuration file with the following default values:</p><pre>
sshPort=8101
sshHost=0.0.0.0
sshRealm=karaf
hostKey=${karaf.base}/etc/host.key
</pre><p>You can change this configuration using the <a href="users-guide/configuration.html">config commands</a> or by editing the above file, but you'll need to restart the ssh console in order for it to use the new parameters.</p><pre>
# define helper functions
bundle-by-sn = { bm = new java.util.HashMap ;  each (bundles) { $bm put ($it symbolicName) $it } ; $bm get $1 }
bundle-id-by-sn = { b = (bundle-by-sn $1) ; if { $b } { $b bundleId } { -1 } }
# edit config
config:edit org.apache.karaf.shell
config:propset sshPort 8102
config:update 
# force a restart
osgi:restart --force (bundle-id-by-sn org.apache.karaf.shell.ssh)
</pre><h2 id="Connectinganddisconnectingremotely">Connecting and disconnecting remotely</h2><h3 id="Usingthesshsshcommand">Using the <tt>ssh:ssh</tt> command</h3><p>You can connect to a remote Karaf's console using the <a href="commands/ssh-ssh.html"><tt>ssh:ssh</tt></a> command.</p><pre>
karaf@root> ssh:ssh -l karaf -P karaf -p 8101 hostname
</pre><div class="warning" style="border: 1px solid #c00;background-color: #fcc;margin: 20px;padding: 0px 6px 0px 6px;"><p>The default password is <tt>karaf</tt> but we recommend changing it. See the <a href="users-guide/security.html">security</a> section for more informations.</p></div><p>To confirm that you have connected to the correct Karaf instance, type <a href="commands/shell-info.html"><tt>shell:info</tt></a> at the <tt>karaf></tt> prompt. Information about the currently connected instance is returned, as shown.</p><pre>
Karaf
  Karaf home                  /local/apache-karaf-2.0.0
  Karaf base                  /local/apache-karaf-2.0.0
  OSGi Framework              org.eclipse.osgi - 3.5.1.R35x_v20090827
JVM
  Java Virtual Machine        Java HotSpot(TM) Server VM version 14.1-b02
  ...
</pre><h3 id="UsingtheKarafclient">Using the Karaf client</h3><p>The Karaf client allows you to securely connect to a remote Karaf instance without having to launch a Karaf instance locally.</p><p>For example, to quickly connect to a Karaf instance running in server mode on the same machine, run the following command from the <tt><a href="karaf-install-dir.html">karaf-install-dir</a></tt> directory:</p><pre>
bin/client
</pre><p>More commonly, you would provide a hostname, port, username and password to connect to a remote instance.  And, if you were using the client within a larger script, you could append console commands as follows:</p><pre>
bin/client -a 8101 -h hostname -u karaf -p karaf features:install wrapper
</pre><p>To display the available options for the client, type:</p><pre>
> bin/client --help
Apache Karaf client
  -a [port]     specify the port to connect to
  -h [host]     specify the host to connect to
  -u [user]     specify the user name
  -p [password] specify the password
  --help        shows this help message
  -v            raise verbosity
  -r [attempts] retry connection establishment (up to attempts times)
  -d [delay]    intra-retry delay (defaults to 2 seconds)
  [commands]    commands to run
If no commands are specified, the client will be put in an interactive mode
</pre><h3 id="UsingaplainSSHclient">Using a plain SSH client</h3><p>You can also connect using a plain SSH client from your *nix system or Windows SSH client like Putty.</p><pre>
~$ ssh -p 8101 karaf@localhost
karaf@localhost's password: 
</pre><h3 id="Disconnectingfromaremoteconsole">Disconnecting from a remote console</h3><p>To disconnect from a remote console, press <tt>Ctrl+D</tt>, <tt>shell:logout</tt> or simply <tt>logout</tt> at the Karaf prompt.</p><h2 id="Stoppingaremoteinstance">Stopping a remote instance</h2><h3 id="Usingtheremoteconsole">Using the remote console </h3><p>If you have connected to a remote console using the <a href="commands/ssh-ssh.html"><tt>ssh:ssh</tt></a> command or the Karaf client, you can stop the remote instance using the <a href="commands/osgi-shutdown.html"><tt>osgi:shutdown</tt></a> command.</p><div class="info" style="border: 1px solid #3c78b5;background-color: #D8E4F1;margin: 20px;padding: 0px 6px 0px 6px;"><p>Pressing <tt>Ctrl+D</tt> in a remote console simply closes the remote connection and returns you to the local shell.</p></div><h3 id="UsingtheKarafclient2">Using the Karaf client</h3><p>To stop a remote instance using the Karaf client, run the following from the <tt><a href="karaf-install-dir.html">karaf-install-dir</a>/lib</tt> directory:</p><pre>
bin/client -u karaf -p karaf -a 8101 hostname osgi:shutdown
</pre><h1 id="Webconsole">Web console</h1><p>The Karaf web console provides a graphical overview of the runtime.<br/>You can use it to:</p><ul><li>install and uninstall features</li><li>start, stop, install bundles</li><li>create child instances</li><li>configure Karaf</li><li>view logging informations</li></ul><h2 id="Installingthewebconsole">Installing the web console</h2><p>The web console is not installed by default.  To install it, run the following command from the Karaf prompt:</p><pre>
root@karaf> features:install webconsole
</pre><h2 id="Accessingthewebconsole">Accessing the web console</h2><p>To access the console for an instance of Karaf running locally, enter the following address in your web browser:</p><pre>
http://localhost:8181/system/console
</pre><p>Log in with the username <tt>karaf</tt> and the password <tt>karaf</tt>.  If you have changed the default user or password, use the one you have configured.</p><h2 id="Changingthewebconsoleportnumber">Changing the web console port number</h2><p>By default, the console runs on port 8181. You can change the port number by creating the properties file, <tt>etc/org.ops4j.pax.web.cfg</tt>, and adding the following property setting (changing the port number to whatever value desired):</p><pre>
org.osgi.service.http.port=8181
</pre><h1 id="Managingchildinstances">Managing child instances</h1><p>A child instance of Karaf is a copy that you can launch separately and deploy applications into.  An instance does not contain the full copy of Karaf, but only a copy of the configuration files and data folder which contains all the runtime information, logs and temporary files.</p><h2 id="Usingtheadminconsolecommands">Using the admin console commands</h2><p>The <strong>admin</strong> console commands allow you to create and manage instances of Karaf on the same machine.  Each new runtime is a child instance of the runtime that created it.  You can easily manage the children using names instead of network addresses.   For details on the <strong>admin</strong> commands, see the <a href="commands/admin.html"><tt>admin</tt> commands</a>.</p> <h2 id="Creatingchildinstances">Creating child instances</h2><p>You create a new runtime instance by typing <a href="commands/admin-create.html"><tt>admin:create</tt></a> in the Karaf console.</p><p>As shown in the following example, <tt>admin:create</tt> causes the runtime to create a new runtime installation in the active runtime's {{instances/<a href="name.html">name</a>} directory.  The new instance is a new Karaf instance and is assigned an SSH port number based on an incremental count starting at 8101 and a RMI registry port number based on an incremental count starting at 1099/44444.</p><pre>
karaf@root> admin:create alpha 
Creating new instance on SSH port 8102 and RMI ports 1100/44445 at: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha
Creating dir:  /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/bin
Creating dir:  /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc
Creating dir:  /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/system
Creating dir:  /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/deploy
Creating dir:  /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/data
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/config.properties
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/jre.properties
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/custom.properties
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/java.util.logging.properties
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/org.apache.felix.fileinstall-deploy.cfg
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/org.apache.karaf.log.cfg
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/org.apache.karaf.features.cfg
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/org.ops4j.pax.logging.cfg
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/org.ops4j.pax.url.mvn.cfg
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/startup.properties
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/users.properties
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/system.properties
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/org.apache.karaf.shell.cfg
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/etc/org.apache.karaf.management.cfg
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/bin/karaf
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/bin/start
Creating file: /x3/karaf/test/apache-karaf-2.2.4/instances/alpha/bin/stop
karaf@root>
</pre><h2 id="Changingachildsports">Changing a child's ports</h2><p>You can change the SSH port number assigned to a child instance using the <a href="commands/admin-change-port.html"><tt>admin:change-ssh-port</tt></a> command.  The syntax for the command is:</p><pre>
admin:change-ssh-port instance port
</pre><p>Note that the child instance has to be stopped in order to run this command.</p><p>In the same way, you can change the RMI registry port number assigned to a child instance using the <a href="commands/admin-change-rmi-registry-port.html"><tt>admin:change-rmi-registry-port</tt></a> command. The syntax for the command is:</p><pre>
admin:change-rmi-registry-port instance port
</pre><p>Note that the child instance has to be stopped in order to run this command.</p><h2 id="Startingchildinstances">Starting child instances</h2><p>New instances are created in a stopped state.  To start a child instance and make it ready to host applications, use the <a href="commands/admin-start.html"><tt>admin:start</tt></a> command.  This command takes a single argument <tt><a href="instance-name.html">instance-name</a></tt> that identifies the child you want started.</p><h2 id="Listingallcontainerinstances">Listing all container instances</h2><p>To see a list of all Karaf instances running under a particular installation, use the <a href="commands/admin-list.html"><tt>admin:list</tt></a> command.</p><pre>
karaf@root>admin:list
  SSH Port   RMI Port   State       Pid  Name
[    8107] [      1106] [Started ] [10628] harry
[    8101] [      1099] [Started ] [20076] root
[    8106] [      1105] [Stopped ] [15924] dick
[    8105] [      1104] [Started ] [18224] tom
karaf@root>
</pre><h2 id="Connectingtoachildinstance">Connecting to a child instance</h2><p>You can connect to a started child instance's remote console using the <a href="commands/admin-connect.html"><tt>admin:connect</tt></a> command which takes three arguments:</p><pre>
admin:connect [-u username] [-p password] instance 
</pre><p>Once you are connected to the child instance, the Karaf prompt changes to display the name of the current instance, as shown:</p><pre>
karaf@harry>
</pre><h2 id="Stoppingachildinstance">Stopping a child instance</h2><p>To stop a child instance from within the instance itself, type <tt>osgi:shutdown</tt> or simply <tt>shutdown</tt>.</p><p>To stop a child instance remotely, in other words, from a parent or sibling instance, use the <a href="commands/admin-stop.html"><tt>admin:stop</tt></a>:</p><pre>
admin:stop instance
</pre><h2 id="Destroyingachildinstance">Destroying a child instance</h2><p>You can permanently delete a stopped child instance using the <a href="commands/admin-destroy.html"><tt>admin:destroy</tt></a> command:</p><pre>
admin:destroy instance
</pre><p>Note that only stopped instances can be destroyed.</p><h2 id="Usingtheadminscript">Using the admin script</h2><p>You can also manage the local instances of Karaf.  The <tt>admin</tt> script in the <tt><a href="karaf-install-dir.html">karaf-install-dir</a>/bin</tt> directory provides the same commands as the <tt>admin</tt> console commands, apart from <a href="commands/admin-connect.html"><tt>admin:connect</tt></a>.</p> <pre>
> bin/admin
Available commands:
  change-ssh-port - Changes the secure shell port of an existing container instance.
  change-rmi-registry-port - Changes the RMI registry port (used by management layer) of an existing container instance.
  create - Creates a new container instance.
  destroy - Destroys an existing container instance.
  list - List all existing container instances.
  start - Starts an existing container instance.
  stop - Stops an existing container instance.
Type 'command --help' for more help on the specified command.
</pre><p>For example, to list all the instances of Karaf on the local machine, type:</p><pre>
bin/admin list
</pre><h1 id="Security">Security</h1><h2 id="Managingusersandpasswords">Managing users and passwords</h2><p>The default security configuration uses a property file located at <tt><a href="karaf-install-dir.html">karaf-install-dir</a>/etc/users.properties</tt> to store authorized users and their passwords.</p><p>The default user name is <tt>karaf</tt> and the associated password is <tt>karaf</tt> too.  We strongly encourage you to change the default password by editing the above file before moving Karaf into production.</p><p>The users are currently used in three different places in Karaf:</p><ul><li>access to the SSH console</li><li>access to the JMX management layer</li><li>access to the Web console<p>Those three ways all delegate to the same JAAS based security authentication.</p><p>The <tt>users.properties</tt> file contains one or more lines, each line defining a user, its password and the associated roles.</p><pre>
user=password[,role][,role]...
</pre></li></ul><h2 id="Managingroles">Managing roles</h2><p>JAAS roles can be used by various components. The three management layers (SSH, JMX and WebConsole) all use a global role based authorization system. The default role name is configured in the <tt>etc/system.properties</tt> using the <tt>karaf.admin.role</tt> system property and the default value is <tt>admin</tt>. All users authenticating for the management layer must have this role defined.</p><p>The syntax for this value is the following:</p><pre>
[classname:]principal
</pre><p>where classname is the class name of the principal object (defaults to org.apache.karaf.jaas.modules.RolePrincipal) and principal is the name of the principal of that class (defaults to admin).</p><p>Note that roles can be changed for a given layer using ConfigAdmin in the following configurations:</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Layer </th><th class="confluenceTh"> PID                        </th><th class="confluenceTh"> Value  </th></tr><tr><td class="confluenceTd"> SSH     </td><td class="confluenceTd"> org.apache.karaf.shell      </td><td class="confluenceTd"> sshRole </td></tr><tr><td class="confluenceTd"> JMX     </td><td class="confluenceTd"> org.apache.karaf.management </td><td class="confluenceTd"> jmxRole </td></tr><tr><td class="confluenceTd"> Web     </td><td class="confluenceTd"> org.apache.karaf.webconsole </td><td class="confluenceTd"> role    </td></tr></table></div><h2 id="Enablingpasswordencryption">Enabling password encryption</h2><p>In order to not keep the passwords in plain text, the passwords can be stored encrypted in the configuration file.<br/>This can be easily enabled using the following commands:</p><pre>
# edit config
config:edit org.apache.karaf.jaas
config:propset encryption.enabled true
config:update 
# force a restart
dev:restart
</pre><p>The passwords will be encrypted automatically in the <tt>etc/users.properties</tt> configuration file the first time the user logs in.<br/>Encrypted passwords are prepended with <tt>{CRYPT}</tt> so that are easy to recognize.</p><h2 id="Managingrealms">Managing realms</h2><p>More information about modifying the default realm or deploying new realms is provided in the <a href="developers-guide/security-framework.html">developers guide</a>.</p><h2 id="Deployingsecurityproviders">Deploying security providers</h2><p>Some applications require specific security providers to be available, such as <a href="http://www.bouncycastle.org">BouncyCastle</a>.  The JVM impose some restrictions about the use of such jars: they have to be signed and be available on the boot classpath.  One way to deploy those providers is to put them in the JRE folder at <tt>$JAVA_HOME/jre/lib/ext</tt> and modify the security policy configuration (<tt>$JAVA_HOME/jre/lib/security/java.security</tt>) in order to register such providers.</p><p>While this approach works fine, it has a global effect and requires you to configure all your servers accordingly.</p><p>Karaf offers a simple way to configure additional security providers:</p><ul><li>put your provider jar in <tt><a href="karaf-install-dir.html">karaf-install-dir</a>/lib/ext</tt></li><li>modify the <tt><a href="karaf-install-dir.html">karaf-install-dir</a>/etc/config.properties</tt> configuration file to add the following property</li></ul><pre>
org.apache.karaf.security.providers = xxx,yyy
</pre><p>The value of this property is a comma separated list of the provider class names to register.<br/>For example:</p><pre>
org.apache.karaf.security.providers = org.bouncycastle.jce.provider.BouncyCastleProvider
</pre><p>In addition, you may want to provide access to the classes from those providers from the system bundle so that all bundles can access those.  It can be done by modifying the <tt>org.osgi.framework.bootdelegation</tt> property in the same configuration file:</p><pre>
org.osgi.framework.bootdelegation = ...,org.bouncycastle*
</pre><h1 id="FailoverDeployments">Failover Deployments</h1><p>Karaf provides failover capability using either a simple lock file system or a JDBC locking mechanism. In both cases, a container-level lock system allows bundles to be preloaded into the slave Karaf instance in order to provide faster failover performance.</p><h2 id="Simplelockfile">Simple lock file</h2><p>The simple lock file mechanism is intended for failover configurations where instances reside on the same host machine.</p><p>To use this feature, edit the <tt>$KARAF_HOME/etc/system.properties</tt> file as follows on each system in the master/slave setup:</p><pre>karaf.lock=true
karaf.lock.class=org.apache.karaf.main.SimpleFileLock
karaf.lock.dir=&lt;PathToLockFileDirectory>
karaf.lock.delay=10
</pre><p><strong>Note</strong>: Ensure that the <tt>karaf.lock.dir</tt> property points to the same directory for both the master and slave instance, so that the slave can acquire the lock only when the master releases it.</p><h2 id="JDBClocking">JDBC locking</h2><p>The JDBC locking mechanism is intended for failover configurations where instances exist on separate machines. In this deployment, the master instance holds a lock on a Karaf locking table hosted on a database. If the master loses the lock, a waiting slave process gains access to the locking table and fully starts its container. </p><p>To use this feature, do the following on each system in the master/slave setup:</p><ul><li>Update the classpath to include the JDBC driver</li><li>Update the <tt>$KARAF_HOME/bin/karaf</tt> script to have a unique JMX remote port set if instances reside on the same host</li><li>Update the <tt>$KARAF_HOME/etc/system.properties</tt> file as follows:</li></ul><pre>karaf.lock=true
karaf.lock.class=org.apache.karaf.main.DefaultJDBCLock
karaf.lock.level=50
karaf.lock.delay=10
karaf.lock.jdbc.url=jdbc:derby://dbserver:1527/sample
karaf.lock.jdbc.driver=org.apache.derby.jdbc.ClientDriver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30
</pre><p><strong>Note</strong>:</p><ul><li>This process will fail if a JDBC driver is not on the classpath.</li><li>The "sample" database referred to above will be created if it does not exist.</li><li>The first Karaf instance to acquire the locking table is the master instance.</li><li>If the connection to the database is lost, the master instance tries to gracefully shutdown, allowing a slave instance to become master when the database service is restored. The former master will require a manual restart.</li></ul><h3 id="JDBClockingonOracle">JDBC locking on Oracle</h3><p>If you are using Oracle as your database for JDBC locking, the <tt>karaf.lock.class</tt> property in the <tt>$KARAF_HOME/etc/system.properties</tt> file must point to <tt>org.apache.karaf.main.OracleJDBCLock</tt>.</p><p>Otherwise, configure the system.properties file as normal for your setup, for example:</p><pre>karaf.lock=true
karaf.lock.class=org.apache.karaf.main.OracleJDBCLock
karaf.lock.jdbc.url=jdbc:oracle:thin:@hostname:1521:XE
karaf.lock.jdbc.driver=oracle.jdbc.OracleDriver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30
</pre><p>As with the default JDBC locking setup, the Oracle JDBC driver JAR file must be in your classpath. You can ensure this by copying the <tt>ojdbc14.jar</tt> into Karaf's <tt>lib</tt> folder before starting Karaf.</p><p><strong>Note</strong>: The <tt>karaf.lock.jdbc.url</tt> requires an active SID, which means you must manually create a database instance before using this particular lock.</p><h3 id="Derby">Derby</h3><p>The same rules apply when using derby.  Make sure you have the driver jar file in the Karaf <tt>lib</tt> folder before starting Karaf.</p><p>Then make you update the properties in <tt>$KARAF_HOME/etc/system.properties</tt> to look something like this example:</p><pre>karaf.lock=true
karaf.lock.class=org.apache.karaf.main.DerbyJDBCLock
karaf.lock.jdbc.url=jdbc:derby://127.0.0.1:1527/dbname
karaf.lock.jdbc.driver=org.apache.derby.jdbc.ClientDriver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30
</pre><h3 id="MySQL">MySQL</h3><p>Make sure you have the MySQL driver jar file in the Karaf <tt>lib</tt> folder before starting Karaf.</p><p><strong>NOTE</strong>: for 2.2.x, 2.3.x you need to rename the MySQL Driver jar to prefix with 'karaf-' in order for karaf to pick it up, otherwise you will see karaf just hang on startup and the log will show you that it could not find the driver.</p><p>Then make you update the properties in <tt>$KARAF_HOME/etc/system.properties</tt> to look something like this example:</p><pre>karaf.lock=true
karaf.lock.class=org.apache.karaf.main.MySQLJDBCLock
karaf.lock.jdbc.url=jdbc:mysql://127.0.0.1:3306/dbname
karaf.lock.jdbc.driver=com.mysql.jdbc.Driver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30
</pre><h3 id="PostgreSQL">PostgreSQL</h3><p>Make sure you have the PostgreSQL driver jar file in the Karaf <tt>lib</tt> folder before starting Karaf.</p><p><strong>NOTE</strong>: for 2.2.x, 2.3.x you need to rename the PostgreSQL Driver jar to prefix with 'karaf-' in order for karaf to pick it up, otherwise you will see karaf just hang on startup and the log will show you that it could not find the driver.</p><p>Then make you update the properties in <tt>$KARAF_HOME/etc/system.properties</tt> to look something like this example:</p><pre>karaf.lock=true
karaf.lock.class=org.apache.karaf.main.PostgreSQLJDBCLock
karaf.lock.jdbc.url=jdbc:postgresql://127.0.0.1:5432/dbname
karaf.lock.jdbc.driver=org.postgresql.Driver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=0
</pre><p><span id="locklevel"></span></p><h2 id="Containerlevellocking">Container-level locking</h2><p>Container-level locking allows bundles to be preloaded into the slave kernel instance in order to provide faster failover performance. Container-level locking is supported in both the simple file and JDBC locking mechanisms.</p><p>To implement container-level locking, add the following to the <tt>$KARAF_HOME/etc/system.properties</tt> file on each system in the master/slave setup:</p><pre>karaf.lock=true
karaf.lock.level=50
karaf.lock.delay=10
</pre><p>The <tt>karaf.lock.level</tt> property tells the Karaf instance how far into the boot process to bring the OSGi container. All bundles with an ID equal or lower to this start level will be started in that Karaf instance.</p><p>Bundle start levels are specified in <tt>$KARAF_HOME/etc/startup.properties</tt>, in the format <tt>jar.name=level</tt>. The core system bundles have levels below 50, where user bundles have levels greater than 50.</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Level </th><th class="confluenceTh"> Behavior </th></tr><tr><td class="confluenceTd"> 1 </td><td class="confluenceTd"> A 'cold' standby instance. Core bundles are not loaded into container. Slaves will wait until lock acquired to start server. </td></tr><tr><td class="confluenceTd"> &lt;50 </td><td class="confluenceTd"> A 'hot' standby instance. Core bundles are loaded into the container. Slaves will wait until lock acquired to start user level bundles. The console will be accessible for each slave instance at this level. </td></tr><tr><td class="confluenceTd"> >50 </td><td class="confluenceTd"> This setting is not recommended as user bundles will end up being started. </td></tr></table></div><p><strong>Note</strong>: When using a 'hot' spare on the same host you need to set the JMX remote port to a unique value to avoid bind conflicts. You can edit the Karaf start script to include the following:</p><pre>DEFAULT_JAVA_OPTS="-server $DEFAULT_JAVA_OPTS -Dcom.sun.management.jmxremote.port=1100 -Dcom.sun.management.jmxremote.authenticate=false"
</pre><h1 id="Loggingsystem">Logging system</h1><p>Karaf provides a powerful logging system based on <a href="http://team.ops4j.org/wiki/display/paxlogging/Pax+Logging">OPS4j Pax Logging</a>. </p><p>In addition to being a standard OSGi Log service, it supports the following APIs:</p><ul><li>Apache Commons Logging</li><li>SLF4J</li><li>Apache Log4j</li><li>Java Util Logging</li></ul><p>Karaf also comes with a set of console commands that can be used to display, view and change the log levels.</p><h2 id="Configuration">Configuration</h2><h3 id="Configurationfile">Configuration file</h3><p>The configuration of the logging system uses a <a href="http://logging.apache.org/log4j/1.2/manual.html">standard Log4j configuration file</a> at the following location:</p><pre>
[karaf_install_dir]/etc/org.ops4j.pax.logging.cfg
</pre><p>You can edit this file at runtime and any change will be reloaded and be effective immediately.</p><h3 id="Configuringtheappenders">Configuring the appenders</h3><p>The default logging configuration defines three appenders:</p><ul><li>the <tt>stdout</tt> console appender is disabled by default.  If you plan to run Karaf in server mode only (i.e. with the locale console disabled), you can turn on this appender on by adding it to the list of configured appenders using the <tt>log4j.rootLogger</tt> property</li><li>the <tt>out</tt> appender is the one enabled by default. It logs events to a number of rotating log files of a fixed size.  You can easily change the parameters to control the number of files using <tt>maxBackupIndex</tt> and their size size <tt>maxFileSize</tt></li><li>the <tt>sift</tt> appender can be used instead to provide a per-bundle log file.  The default configuration uses the bundle symbolic name as the file name to log to</li></ul><h3 id="Changingtheloglevels">Changing the log levels</h3><p>The default logging configuration sets the logging levels so that the log file will provide enough information to monitor the behavior of the runtime and provide clues about what caused a problem. However, the default configuration will not provide enough information to debug most problems.</p><p>The most useful logger to change when trying to debug an issue with Karaf is the root logger. You will want to set its logging level to <tt>DEBUG</tt> in the <tt>org.ops4j.pax.logging.cfg</tt> file.</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.rootLogger=DEBUG, out, osgi:VmLogAppender
...</code></pre></div><p>When debugging a problem in Karaf you may want to change the level of logging information that is displayed on the console. The example below shows how to set the root logger to <tt>DEBUG</tt> but limiting the information displayed on the console to WARN.</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.rootLogger=DEBUG, out, stdout, osgi:VmLogAppender
log4j.appender.stdout.threshold=WARN
...</code></pre></div><h2 id="ConsoleLogCommands">Console Log Commands</h2><p>The log subshell comes with the following commands:</p><ul><li><a href="commands/log-clear.html"><tt>log:clear</tt></a>: clear the log</li><li><a href="commands/log-display.html"><tt>log:display</tt></a>: display the last log entries</li><li><a href="commands/log-display-exception.html"><tt>log:display-exception</tt></a>: display the last exception from the log</li><li><a href="commands/log-get.html"><tt>log:get</tt></a>: show the log levels</li><li><a href="commands/log-set.html"><tt>log:set</tt></a>: set the log levels</li><li><a href="commands/log-tail.html"><tt>log:tail</tt></a>: continuous display of the log entries</li></ul><p>For example, if you want to debug something, you might want to run the following commands:</p><pre>
> log:set DEBUG
... do something ...
> log:display
</pre><p>Note that the log levels set using the <tt>log:set</tt> commands are not persistent and will be lost upon restart.<br/>To configure those in a persistent way, you should edit the configuration file mentioned above using the config commands or directly using a text editor of your choice.</p><p>The log commands has a separate configure file:</p><pre>
[karaf_install_dir]/etc/org.apache.karaf.log.cfg
</pre><h2 id="Advancedconfiguration">Advanced configuration</h2><p>The logging backend uses Log4j, but offer a number of additional features.</p><h3 id="Nestedfiltersappendersanderrorhandlers">Nested filters, appenders and error handlers</h3><h4 id="Filters">Filters</h4><p>Appender filters can be added using the following syntax:</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.appender.[appender-name].filter.[filter-name]=[filter-class]
log4j.appender.[appender-name].filter.[filter-name].[option]=[value]</code></pre></div><p>Below is a real example:</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.appender.out.filter.f1=org.apache.log4j.varia.LevelRangeFilter
log4j.appender.out.filter.f1.LevelMax=FATAL
log4j.appender.out.filter.f1.LevelMin=DEBUG</code></pre></div><h4 id="Nestedappenders">Nested appenders</h4><p>Nested appenders can be added using the following syntax:</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.appender.[appender-name].appenders=[comma-separated-list-of-appender-names]</code></pre></div><p>Below is a real example:</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.appender.async=org.apache.log4j.AsyncAppender
log4j.appender.async.appenders=jms

log4j.appender.jms=org.apache.log4j.net.JMSAppender
...</code></pre></div><h4 id="Errorhandlers">Error handlers</h4><p>Error handlers can be added using the following syntax:</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.appender.[appender-name].errorhandler=[error-handler-class]
log4j.appender.[appender-name].errorhandler.root-ref=[true|false]
log4j.appender.[appender-name].errorhandler.logger-ref=[logger-ref]
log4j.appender.[appender-name].errorhandler.appender-ref=[appender-ref]</code></pre></div><h3 id="OSGispecificMDCattributes">OSGi specific MDC attributes</h3><p>Pax-Logging provides the following attributes by default:</p><ul><li><tt>bundle.id</tt>: the id of the bundle from which the class is loaded</li><li><tt>bundle.name</tt>: the symbolic-name of the bundle</li><li><tt>bundle.version</tt>: the version of the bundle</li></ul><p>An MDC sifting appender is available to split the log events based on MDC attributes.  Below is a configuration example for this appender:</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
log4j.appender.sift=org.apache.log4j.sift.MDCSiftingAppender
log4j.appender.sift.key=bundle.name
log4j.appender.sift.default=karaf
log4j.appender.sift.appender=org.apache.log4j.FileAppender
log4j.appender.sift.appender.layout=org.apache.log4j.PatternLayout
log4j.appender.sift.appender.layout.ConversionPattern=%d{ABSOLUTE} | %-5.5p | %-16.16t | %-32.32c{1} | %-32.32C %4L | %m%n
log4j.appender.sift.appender.file=${karaf.data}/log/$\\{bundle.name\\}.log
log4j.appender.sift.appender.append=true</code></pre></div><h3 id="EnhancedOSGistacktracerenderer">Enhanced OSGi stack trace renderer</h3><p>This renderer is configured by default in Karaf and will give additional informations when printing stack traces.<br/>For each line of the stack trace, it will display OSGi specific informations related to the class on that line: the bundle id, the bundle symbolic name and the bundle version.  This information can greatly help diagnosing problems in some cases.<br/>The information is appended at the end of each line in the following format <tt><a href="id:name:version">id:name:version</a></tt> as shown below</p><div class="syntax"><pre name='code' class='brush: text; gutter: false;'><code>
java.lang.IllegalArgumentException: Command not found:  *:foo
	at org.apache.felix.gogo.runtime.shell.Closure.execute(Closure.java:225)[21:org.apache.karaf.shell.console:2.1.0]
	at org.apache.felix.gogo.runtime.shell.Closure.executeStatement(Closure.java:162)[21:org.apache.karaf.shell.console:2.1.0]
	at org.apache.felix.gogo.runtime.shell.Pipe.run(Pipe.java:101)[21:org.apache.karaf.shell.console:2.1.0]
	at org.apache.felix.gogo.runtime.shell.Closure.execute(Closure.java:79)[21:org.apache.karaf.shell.console:2.1.0]
	at org.apache.felix.gogo.runtime.shell.CommandSessionImpl.execute(CommandSessionImpl.java:71)[21:org.apache.karaf.shell.console:2.1.0]
	at org.apache.karaf.shell.console.jline.Console.run(Console.java:169)[21:org.apache.karaf.shell.console:2.1.0]
	at java.lang.Thread.run(Thread.java:637)[:1.6.0_20]</code></pre></div><h3 id="Usingyourownappenders">Using your own appenders</h3><p>If you plan to use your own appenders, you need to create an OSGi bundle and attach it as a fragment to the bundle with a symbolic name of <br/><tt>org.ops4j.pax.logging.pax-logging-service</tt>.  This way, the underlying logging system will be able to see and use your appenders.</p><p>So for example you write a log4j appender:<br/>class MyAppender extends AppenderSkeleton {<br/>...<br/>}</p><p>Then you need to package the appender in a jar with a Manifest like this:</p><p>Manifest:<br/>Bundle-SymbolicName: org.mydomain.myappender       <br/>Fragment-Host: org.ops4j.pax.logging.pax-logging-service<br/>...</p><p>Copy the new appender fragment into the ${karaf.home}/system directory. Karaf uses a virtual maven repository to access resources in the system<br/>directory, so the jar path should use the standard maven groupId/artifactId/version/ convention, where the groupId is a directory structure.</p><p>Edit ${karaf.home}/etc/startup.properties and add the new fragment bundle to the list before the pax-logging-service bundle.</p><p>Restart karaf with a clean run to reload the system bundles, and now you can use the appender in your log4j config file like shown in the config<br/>examples above.</p><h1 id="Deployer">Deployer</h1><p>The following picture describes the architecture of the deployer.</p><p><img border="0" src="images/deployer.png"/></p><h2 id="Blueprintdeployer">Blueprint deployer</h2><p>Karaf includes a deployer that is able to deploy plain blueprint configuration files.<br/>The deployer will transform on the fly any spring configuration file dropped into the <tt>deploy</tt> folder into a valid OSGi bundle.</p><p>The generated OSGi manifest will contain the following headers:</p><pre>
Manifest-Version: 2
Bundle-SymbolicName: [name of the file]
Bundle-Version: [version of the file]
Import-Package: [required packages]
DynamicImport-Package: *
</pre><p>The <tt>name</tt> and <tt>version</tt> of the file are extracted using a heuristic that will match common patterns.  For example <tt>my-config-1.0.1.xml</tt> will lead to <tt>name = my-config</tt> and <tt>version = 1.0.1</tt>.<br/>The default imported packages are extracted from the spring file definition and includes all classes referenced directly.</p><p>If you need to customize the generated manifest, you can do so by including an xml element in your blueprint configuration:</p><pre>
&lt;blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0">
  &lt;manifest xmlns="http://karaf.apache.org/xmlns/deployer/blueprint/v1.0.0">
    Require-Bundle= my-bundle
  &lt;/manifest>
</pre><h2 id="Springdeployer">Spring deployer</h2><p>Similar to the blueprint deployer, you can deploy spring-dm configuration files.</p><p>The generated OSGi manifest will contain the following headers:</p><pre>
Manifest-Version: 2
Bundle-SymbolicName: [name of the file]
Bundle-Version: [version of the file]
Spring-Context: *;publish-context:=false;create-asynchronously:=true
Import-Package: [required packages]
DynamicImport-Package: *
</pre><p>If you need to customize the generated manifest, you can do so by including an xml element in your spring configuration:</p><pre>
&lt;spring:beans ...>
  &lt;manifest xmlns="http://karaf.apache.org/xmlns/deployer/spring/v1.0.0">
    Require-Bundle= my-bundle
  &lt;/manifest>
</pre><h2 id="Featuresdeployer">Features deployer</h2><p>To be able to hot deploy features from the deploy folder, you can just drop a feature descriptor on that folder.  A bundle will be created and its installation (automatic) will trigger the installation of all features contained in the descriptor.  Removing the file from the deploy folder will uninstall the features.<br/>If you want to install a single feature, you can do so by writing a feature descriptor like the following:</p><pre>
&lt;features>
  &lt;repository>mvn:org.apache.servicemix.nmr/apache-servicemix-nmr/1.0.0/xml/features&lt;/repository>
  &lt;feature name="nmr-only">
    &lt;feature>nmr&lt;/feature>
  &lt;/feature>
&lt;/features>
</pre><p>For more informations about features, see the <a href="users-guide/provisioning.html">provisioning section</a>.</p><h2 id="Wardeployer">War deployer</h2><p>To be able to hot deploy web application (war) from the deploy folder, you have to install the war feature:</p><pre>
karaf@root> features:install war
</pre><p>NB: you can use the -v or --verbose option to see exactly what is performed by the feature deployer.</p><pre>
karaf@root> features:install -v war
Installing feature war 2.1.99-SNAPSHOT
Installing feature http 2.1.99-SNAPSHOT
Installing feature jetty 7.2.2.v20101205
Installing bundle mvn:org.apache.geronimo.specs/geronimo-servlet_2.5_spec/1.1.2
Found installed bundle: org.apache.servicemix.bundles.asm [9]
Installing bundle mvn:org.eclipse.jetty/jetty-util/7.2.2.v20101205
Installing bundle mvn:org.eclipse.jetty/jetty-io/7.2.2.v20101205
Installing bundle mvn:org.eclipse.jetty/jetty-http/7.2.2.v20101205
Installing bundle mvn:org.eclipse.jetty/jetty-continuation/7.2.2.v20101205
Installing bundle mvn:org.eclipse.jetty/jetty-server/7.2.2.v20101205
Installing bundle mvn:org.eclipse.jetty/jetty-security/7.2.2.v20101205
Installing bundle mvn:org.eclipse.jetty/jetty-servlet/7.2.2.v20101205
Installing bundle mvn:org.eclipse.jetty/jetty-xml/7.2.2.v20101205
Checking configuration file mvn:org.apache.karaf/apache-karaf/2.1.99-SNAPSHOT/xml/jettyconfig
Installing bundle mvn:org.ops4j.pax.web/pax-web-api/1.0.0
Installing bundle mvn:org.ops4j.pax.web/pax-web-spi/1.0.0
Installing bundle mvn:org.ops4j.pax.web/pax-web-runtime/1.0.0
Installing bundle mvn:org.ops4j.pax.web/pax-web-jetty/1.0.0
Installing bundle mvn:org.apache.karaf.shell/org.apache.karaf.shell.web/2.1.99-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-jsp/1.0.0
Installing bundle mvn:org.ops4j.pax.web/pax-web-extender-war/1.0.0
Installing bundle mvn:org.ops4j.pax.web/pax-web-extender-whiteboard/1.0.0
Installing bundle mvn:org.ops4j.pax.web/pax-web-deployer/1.0.0
Installing bundle mvn:org.ops4j.pax.url/pax-url-war/1.2.5
</pre><p>As you can see, the war feature uses PAX Web as war deployer.</p><p>You should now be able to see the PAX Web war deployer:</p><pre>
karaf@root> osgi:list |grep -i war
[  57] [Active     ] [            ] [   60] OPS4J Pax Web - Extender - WAR (1.0.0)
[  60] [Active     ] [            ] [   60] OPS4J Pax Url - war:, war-i: (1.2.5)
</pre><p>You can deploy a web application packaged in war or exploded in a directory.</p><p>Your web application should at least contain a WEB-INF/web.xml file.</p><h2 id="Wrapdeployer">Wrap deployer</h2><p>The wrap deployer allows you to hot deploy non-OSGi jar files ("classical" jar files) from the deploy folder.</p><p>It's a standard deployer (you don't need to install additional Karaf features):</p><pre>
karaf@root> la|grep -i wrap
[   1] [Active     ] [            ] [    5] OPS4J Pax Url - wrap: (1.2.5)
[  32] [Active     ] [Created     ] [   30] Apache Karaf :: Deployer :: Wrap Non OSGi Jar (2.1.99.SNAPSHOT)
</pre><p>Karaf wrap deployer looks for jar files in the deploy folder. The jar files is considered as non-OSGi if the MANIFEST<br/>doesn't contain the Bundle-SymbolicName and Bundle-Version attributes, or if there is no MANIFEST at all.</p><p>The non-OSGi jar file is transformed into an OSGi bundle.</p><p>The deployer tries to populate the Bundle-SymbolicName and Bundle-Version extracted from the jar file path.</p><p>For example, if you simply copy commons-lang-2.3.jar (which is not an OSGi bundle) into the deploy folder, you<br/>will see:</p><pre>
karaf@root> la|grep -i commons-lang
[  41] [Active     ] [            ] [   60] commons-lang (2.3)
</pre><p>If you take a look on the commons-lang headers, you can see that the bundle exports all packages with optional resolution<br/>and that Bundle-SymbolicName and Bundle-Version have been populated:</p><pre>
karaf@root> osgi:headers 41

commons-lang (41)
-----------------
Specification-Title = Commons Lang
Tool = Bnd-0.0.357
Specification-Version = 2.3
Specification-Vendor = Apache Software Foundation
Implementation-Version = 2.3
Generated-By-Ops4j-Pax-From = wrap:file:/home/onofreje/workspace/karaf/assembly/target/apache-karaf-2.99.99-SNAPSHOT/deploy/commons-lang-2.3.jar$Bundle-SymbolicName=commons-lang&amp;Bundle-Version=2.3
Implementation-Vendor-Id = org.apache
Created-By = 1.6.0_21 (Sun Microsystems Inc.)
Implementation-Title = Commons Lang
Manifest-Version = 1.0
Bnd-LastModified = 1297248243231
X-Compile-Target-JDK = 1.1
Originally-Created-By = 1.3.1_09-85 ("Apple Computer, Inc.")
Ant-Version = Apache Ant 1.6.5
Package = org.apache.commons.lang
X-Compile-Source-JDK = 1.3
Extension-Name = commons-lang
Implementation-Vendor = Apache Software Foundation

Bundle-Name = commons-lang
Bundle-SymbolicName = commons-lang
Bundle-Version = 2.3
Bundle-ManifestVersion = 2

Import-Package =
        org.apache.commons.lang;resolution:=optional,
        org.apache.commons.lang.builder;resolution:=optional,
        org.apache.commons.lang.enum;resolution:=optional,
        org.apache.commons.lang.enums;resolution:=optional,
        org.apache.commons.lang.exception;resolution:=optional,
        org.apache.commons.lang.math;resolution:=optional,
        org.apache.commons.lang.mutable;resolution:=optional,
        org.apache.commons.lang.text;resolution:=optional,
        org.apache.commons.lang.time;resolution:=optional
Export-Package =
        org.apache.commons.lang;uses:="org.apache.commons.lang.builder,org.apache.commons.lang.math,org.apache.commons.lang.exception",
        org.apache.commons.lang.builder;uses:="org.apache.commons.lang.math,org.apache.commons.lang",
        org.apache.commons.lang.enum;uses:=org.apache.commons.lang,
        org.apache.commons.lang.enums;uses:=org.apache.commons.lang,
        org.apache.commons.lang.exception;uses:=org.apache.commons.lang,
        org.apache.commons.lang.math;uses:=org.apache.commons.lang,
        org.apache.commons.lang.mutable;uses:="org.apache.commons.lang,org.apache.commons.lang.math",
        org.apache.commons.lang.text;uses:=org.apache.commons.lang,
        org.apache.commons.lang.time;uses:=org.apache.commons.lang


</pre><h1 id="Provisioning">Provisioning</h1><p>Karaf provides a simple, yet flexible, way to provision applications or "features".  Such a mechanism is mainly provided by a set of commands available in the <tt>features</tt> shell.  The provisioning system uses xml "repositories" that define a set of features.</p><h2 id="Repositories">Repositories</h2><p>The complete xml schema for feature descriptor are available on <a href="users-guide/provisioning-schema.html">Features XML Schema</a> page. We recommend using this XML schema. It will allow Karaf to validate your repository before parsing. You may also verify your descriptor before adding it to Karaf by simply validation, even from IDE level.</p><p>Here is an example of such a repository:</p><pre>
&lt;features xmlns="http://karaf.apache.org/xmlns/features/v1.0.0">
    &lt;feature name="spring" version="3.0.4.RELEASE">
        &lt;bundle>mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.aopalliance/1.0_1&lt;/bundle>
        &lt;bundle>mvn:org.springframework/spring-core/3.0.4.RELEASE&lt;/bundle>
        &lt;bundle>mvn:org.springframework/spring-beans/3.0.4.RELEASE&lt;/bundle>
        &lt;bundle>mvn:org.springframework/spring-aop/3.0.4.RELEASE&lt;/bundle>
        &lt;bundle>mvn:org.springframework/spring-context/3.0.4.RELEASE&lt;/bundle>
        &lt;bundle>mvn:org.springframework/spring-context-support/3.0.4.RELEASE&lt;/bundle>
    &lt;/feature>
&lt;/features>
</pre><p>A repository includes a list of <tt>feature</tt> elements, each one representing an application that can be installed.  The feature is identified by its <tt>name</tt> which must be unique amongst all the repositories used and consists of a set of bundles that need to be installed along with some optional dependencies on other features and some optional configurations for the Configuration Admin OSGi service.</p><p>References to features define in other repositories are allow and can be achieved by adding a list of repository.</p><pre class="xml code-xml">
&lt;features xmlns="http://karaf.apache.org/xmlns/features/v1.0.0">
  &lt;repository>mvn:org.apache.servicemix.nmr/apache-servicemix-nmr/1.3.0/xml/features&lt;/repository>
  &lt;repository>mvn:org.apache.camel.karaf/apache-camel/2.5.0/xml/features&lt;/repository>
  &lt;repository>mvn:org.apache.karaf/apache-karaf/2.1.2/xml/features&lt;/repository>
  ...
</pre><div class="warning" style="border: 1px solid #c00;background-color: #fcc;margin: 20px;padding: 0px 6px 0px 6px;"><p>Be careful when you define them as there is a risk of 'cycling' dependencies.</p></div><p>Remark: By default, all the features defined in a repository are not installed at the launch of Apache Karaf (see section hereafter 'h2. Service configuration' for more info).</p><h3 id="Bundles">Bundles</h3><p>The main information provided by a feature is the set of OSGi bundles that defines the application.  Such bundles are URLs pointing to the actual bundle jars.  For example, one would write the following definition:</p><pre>
&lt;bundle>http://repo1.maven.org/maven2/org/apache/servicemix/nmr/org.apache.servicemix.nmr.api/1.0.0-m2/org.apache.servicemix.nmr.api-1.0.0-m2.jar&lt;/bundle>
</pre><p>Doing this will make sure the above bundle is installed while installing the feature.</p><p>However, Karaf provides several URL handlers, in addition to the usual ones (file, http, etc...). One of these is the Maven URL handler, which allow reusing Maven repositories to point to the bundles.</p><h4 id="MavenURLHandler">Maven URL Handler</h4><p>The equivalent of the above bundle would be:</p><pre>
&lt;bundle>mvn:org.apache.servicemix.nmr/org.apache.servicemix.nmr.api/1.0.0-m2&lt;/bundle>
</pre><p>In addition to being less verbose, the Maven url handlers can also resolve snapshots and can use a local copy of the jar if one is available in your Maven local repository.</p><p>The <tt>org.ops4j.pax.url.mvn</tt> bundle resolves <tt>mvn</tt> URLs. This flexible tool can be configured through the configuration service. For example, to find the current repositories type:</p><pre>
karaf@root:/> config:list
...
----------------------------------------------------------------
Pid:            org.ops4j.pax.url.mvn
BundleLocation: mvn:org.ops4j.pax.url/pax-url-mvn/0.3.3
Properties:
   service.pid = org.ops4j.pax.url.mvn
   org.ops4j.pax.url.mvn.defaultRepositories = file:/opt/development/karaf/assembly/target/apache-felix-karaf-1.2.0-SNAPSHOT/system@snapshots
   org.ops4j.pax.url.mvn.repositories = http://repo1.maven.org/maven2, 
                                         http://svn.apache.org/repos/asf/servicemix/m2-repo 
   below = list of repositories and even before the local repository
</pre><p>The repositories checked are controlled by these configuration properties. </p><p>For example, <tt>org.ops4j.pax.url.mvn.repositories</tt> is a comma separate list of repository URLs specifying those remote repositories to be checked. So, to replace the defaults with a new repository at <tt>http://www.example.org/repo</tt> on the local machine:</p><pre>
karaf@root:/> config:edit org.ops4j.pax.url.mvn
karaf@root:/> config:proplist                  
   service.pid = org.ops4j.pax.url.mvn
   org.ops4j.pax.url.mvn.defaultRepositories = file:/opt/development/karaf/assembly/target/apache-felix-karaf-1.2.0-SNAPSHOT/system@snapshots
   org.ops4j.pax.url.mvn.repositories = http://repo1.maven.org/maven2,
                                        http://svn.apache.org/repos/asf/servicemix/m2-repo
   below = list of repositories and even before the local repository
karaf@root:/> config:propset org.ops4j.pax.url.mvn.repositories http://www.example.org/repo
karaf@root:/> config:update
</pre><p>By default, snapshots are disabled. To enable an URL for snapshots append @snapshots. For example</p><pre>
http://www.example.org/repo@snapshots
</pre><p>Repositories on the local machine are supported through <tt>file:/</tt> URLs</p><h4 id="Bundlestartlevel">Bundle start-level</h4><p><strong>Available since Karaf 2.0</strong></p><p>By default, the bundles deployed through the feature mechanism will have a start-level equals to the value defined in the configuration file <tt>config.properties</tt><br/>with the variable <tt>karaf.startlevel.bundle=80</tt>. This value can be changed using the xml attribute start-level. </p><pre class="xml code-xml">
  &lt;feature name='my-project' version='1.0.0'>
    &lt;feature version='2.4.0'>camel-spring&lt;/feature>
    &lt;bundle start-level='80'>mvn:com.mycompany.myproject/myproject-dao&lt;/bundle>    
    &lt;bundle start-level='85'>mvn:com.mycompany.myproject/myproject-service&lt;/bundle>
    &lt;bundle start-level='85'>mvn:com.mycompany.myproject/myproject-camel-routing&lt;/bundle>
  &lt;/feature> 
</pre><p>  </p><p>The advantage in defining the bundle start-level is that you can deploy all your bundles including any required 'infrastructure' bundles (e.g Camel, ActiveMQ)<br/>at the same time and you will have the guarantee when using Spring Dynamic Modules or Blueprint that the Spring context will not be<br/>created without all the required services installed.</p><h4 id="Bundlestopstart">Bundle 'stop/start'</h4><p>The OSGI specification allows for installing a bundle without starting it. To use this functionality, simply add the following attribute in your &lt;bundle> definition</p><pre class="xml code-xml">
  &lt;feature name='my-project' version='1.0.0'>
    &lt;feature version='2.4.0'>camel-spring&lt;/feature>
    &lt;bundle start-level='80' start='false'>mvn:com.mycompany.myproject/myproject-dao&lt;/bundle>    
    &lt;bundle start-level='85' start='false'>mvn:com.mycompany.myproject/myproject-service&lt;/bundle>
    &lt;bundle start-level='85' start='false'>mvn:com.mycompany.myproject/myproject-camel-routing&lt;/bundle>
  &lt;/feature> 
</pre><div class="warning" style="border: 1px solid #c00;background-color: #fcc;margin: 20px;padding: 0px 6px 0px 6px;"><p>Before Karaf 3.0 the start-level was NOT considered during the feature startup, but only the order in which bundles are defined in your feature.xml. Starting with 3.0 the start-level is no considered correctly. If you need to use the old behavior you can uncomment and change the respectStartLvlDuringFeatureStartup variable in org.apache.karaf.features.xml to false. But please be aware that it will be removed in 4.0 and should therefore be used only temporarily.</p></div><h4 id="Bundledependency">Bundle 'dependency'</h4><p>A bundle can be flagged as being a dependency.  Such information can be used by resolvers to compute the full list of bundles to be installed.</p><h3 id="Dependentfeatures">Dependent features</h3><p>Dependent features are useful when a given feature depends on another feature to be installed.  Such a dependency can be expressed easily in the feature definition:</p><pre>
&lt;feature name="jbi">
  &lt;feature>nmr&lt;/feature>
  ...
&lt;/feature>
</pre><p>The effect of such a dependency is to automatically install the required <tt>nmr</tt> feature when the <tt>jbi</tt> feature is installed.</p><p>A version range can be specified on the feature dependency:</p><pre>
&lt;feature name="spring-dm">
  &lt;feature version="[2.5.6,4)">spring&lt;/feature>
  ...
&lt;/feature>
</pre><p>In such a case, if no matching feature is already installed, the feature with the highest version available in the range will be installed.  If a single version is specified, this version will be chosen.  If nothing is specified, the highest available will be installed.</p><h3 id="Configurations">Configurations</h3><p>The configuration section allows for declaring deployment configuration of the OSGi Configuration Admin service along a set of bundles.<br/>Here is an example of such a configuration:</p><pre>
&lt;config name="com.foo.bar">
  myProperty = myValue
&lt;/config>
</pre><p>The <tt>name</tt> attribute of the <tt>configuration</tt> element will be used as the ManagedService PID for the configuration set in the Configuration Admin service.  When using a ManagedServiceFactory, the <tt>name</tt> attribute is <em>servicePid</em>-_aliasId_, where <em>servicePid</em> is the PID of the ManagedServiceFactory and <em>aliasId</em> is a label used to uniquely identify a particular service (an alias to the factory generated service PID).</p><p>Deploying such a configuration has the same effect as dropping a file named <tt>com.foo.bar.cfg</tt> into the <tt>etc</tt> folder.</p><p>The content of the <tt>configuration</tt> element is set of properties parsed using the <a href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/Properties.html#load(java.io.InputStream)">standard java property mechanism</a>.</p><p>Such configuration as usually used with Spring-DM or Blueprint support for the Configuration Admin service, as in the following example, but using plain OSGi APIs will of course work the same way:</p><pre>
&lt;bean ...>
    &lt;property name="propertyName" value="${myProperty}" />
&lt;/bean>

&lt;osgix:cm-properties id="cmProps" persistent-id="com.foo.bar">
    &lt;prop key="myProperty">myValue&lt;/prop>
&lt;/osgix:cm-properties>
&lt;ctx:property-placeholder properties-ref="cmProps" />
</pre><p>There may also be cases where you want to make the properties from multiple configuration files available to your bundle context. This is something you may<br/>want to do if you have a multi-bundle application where there are application properties used by multiple bundles, and each bundle has its own specific<br/>properties. In that case, <tt>&lt;ctx:property-placeholder></tt> won't work as it was designed to make only one configuration file available to a bundle context.<br/> To make more than one configuration file available to your bundle-context you would do something like this:</p><pre>
&lt;beans:bean id="myBundleConfigurer"
            class="org.springframework.beans.factory.config.PropertyPlaceholderConfig">
    &lt;beans:property name="ignoreUnresolvablePlaceholders" value="true"/>
    &lt;beans:property name="propertiesArray">
        &lt;osgix:cm-properties id="myAppProps" persistent-id="myApp.props"/>
        &lt;osgix:cm-properties id="myBundleProps" persistent-id="my.bundle.props"/>
    &lt;/beans:property>
&lt;/beans:bean>
</pre><p>In this example, we are using SpringDM with osgi as the primary namespace. Instead of using ctx:context-placeholder we are using the "PropertyPlaceholderConfig"<br/>class. Then we are passing in a beans array and inside of that array is where we set our osgix:cm-properties elements. This element "returns" a properties bean.</p><p>For more information about using the Configuration Admin service in Spring-DM, see the <a href="http://static.springframework.org/osgi/docs/1.2.0-m2/reference/html/compendium.html#compendium:cm:props">Spring-DM documentation</a>.</p><h3 id="Configurationfiles">Configuration files</h3><p>In certain cases it is needed not only to provide configurations for the configuration admin service but to add additional<br/>configuration files e.g. a configuration file for jetty (jetty.xml). It even might be helpful to deploy a configuration<br/>file instead of a configuration for the config admin service since. To achieve this the attribute <tt>finalname</tt> shows the<br/>final destination of the <tt>configfile</tt>, while the value references the Maven artifact to deploy.</p><pre>
&lt;configfile finalname="/etc/jetty.xml">mvn:org.apache.karaf/apache-karaf/2.3.0/xml/jettyconfig&lt;/configfile>
</pre><h3 id="Featureresolver">Feature resolver</h3><p>The resolver attribute on a feature can be set to force the use of a given resolver instead of the default resolution process.  A resolver will be use to obtain the list of bundles to actually install for a given feature.<br/>The default resolver will simply return the list of bundles provided in the feature description.<br/>The OBR resolver can be installed and used instead of the standard one.  In that case, the resolver will use the OBR service<br/>to determine the list of bundles to install (bundles flagged as dependency will only be used as possible candidates to solve<br/>various constraints).</p><h2 id="Commands">Commands</h2><h3 id="Repositorymanagement">Repository management</h3><p>The following commands can be used to manage the list of descriptors known by Karaf.  They use URLs pointing to features descriptors.  These URLs can use any protocol known to the Apache Karaf, the most common ones being http, file and mvn.</p><pre>
features:addUrl      Add a list of repository URLs to the features service
features:removeUrl   Remove a list of repository URLs from the features service
features:listUrl     Display the repository URLs currently associated with the features service.
features:refreshUrl  Reload the repositories to obtain a fresh list of features
</pre><p>Karaf maintains a persistent list of these repositories so that if you add one URL and restart Karaf, the features will still be available.</p><p>The <tt>refreshUrl</tt> command is mostly used when developing features descriptors: when changing the descriptor, it can be<br/>handy to reload it in the Kernel without having to restart it or to remove then add the URL again.</p><h3 id="Featuresmanagement">Features management</h3><pre>
features:install
features:uninstall
features:list
</pre><h3 id="Examples">Examples</h3><p>1. Install features using mvn handler</p><pre>
features:addUrl mvn:org.apache.servicemix.nmr/apache-servicemix-nmr/1.0.0-m2/xml/features
features:install nmr
</pre><p>2. Use file handler to deploy features file</p><pre>
features:addUrl file:base/features/features.xml
</pre><p>Note: The path is relative to the Apache Karaf installation directory</p><p>3. Deploy bundles from file system without using Maven</p><p>As we can use file:// as protocol handler to deploy bundles, you can use the following syntax to deploy bundles when they are <br/>located in a directory which is not available using Maven</p><pre class="xml code-xml">
&lt;features xmlns="http://karaf.apache.org/xmlns/features/v1.0.0">
   &lt;feature name="spring-web" version="2.5.6.SEC01">
      &lt;bundle>file:base/bundles/spring-web-2.5.6.SEC01.jar&lt;/bundle>
   &lt;/feature>
&lt;/features>
</pre><p>Note: The path is relative to the Apache Karaf installation directory</p><h2 id="Serviceconfiguration">Service configuration</h2><p>A simple configuration file located in <tt>[FELIX:karaf]/etc/org.apache.karaf.features.cfg</tt> can be modified to customize the behavior when starting the Kernel for the first time.<br/>This configuration file contains two properties:</p><ul><li><tt>featuresBoot</tt>: a comma separated list of features to install at startup</li><li><tt>featuresRepositories</tt>: a comma separated list of feature repositories to load at startup</li></ul><p>This configuration file is of interest if you plan to distribute a customized Karaf distribution having pre-installed features.  Such a process is detailed in the <a href="6.2. Building custom distributions">6.2. Building custom distributions</a> section.</p><h1 id="XMLSchemaforprovisioning">XML Schema for provisioning</h1><p>The following schema can be found in Karaf sources. It is also available publicly at url http://karaf.apache.org/xmlns/features/v1.0.0.</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code></code></pre></div><h1 id="KarafArchivesKAR">Karaf Archives (KAR)</h1><p>Karaf provides a specific archive format named the KAR (Karaf ARchive).</p><p>Basically, the kar format is a jar (so a zip file) which contains a set of feature descriptor and bundle jar files.</p><p>For instance, a kar looks like:</p><ul><li>my-features-1.xml</li><li>bundle1.jar</li><li>bundle2.jar</li><li>bundle3.jar</li></ul><p>all packaged in zip format.</p><h2 id="Createakararchive">Create a kar archive</h2><p>You can create a kar file by hand, just by zip compressing a directory representing the kar content.</p><p>You can also use the Karaf features maven plugin. The features maven plugin provides an create-kar goal.</p><p>The kar-archive goal:<br/>1. Reads all features specified in the features descriptor.<br/>2. For each feature, it resolves the bundles defined in the feature.<br/>3. All bundles are packaged into the kar archive.</p><p>For instance, you can use the following POM to create a kar:</p><pre>
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

    &lt;modelVersion>4.0.0&lt;/modelVersion>

    &lt;groupId>my.groupId&lt;/groupId>
    &lt;artifactId>my-kar&lt;/artifactId>
    &lt;version>1.0&lt;/version>
    &lt;packaging>pom&lt;/packaging>

    &lt;build>
        &lt;plugins>
            &lt;plugin>
                &lt;groupId>org.apache.karaf.tooling&lt;/groupId>
                &lt;artifactId>features-maven-plugin&lt;/artifactId>
                &lt;version>2.2.8&lt;/version>
                &lt;executions>
                    &lt;execution>
                        &lt;id>create-kar&lt;/id>
                        &lt;goals>
                            &lt;goal>create-kar&lt;/goal>
                        &lt;/goals>
                        &lt;configuration>
                            &lt;featuresFile>src/main/resources/features.xml&lt;/featuresFile>
                        &lt;/configuration>
                    &lt;/execution>
                &lt;/executions>
            &lt;/plugin>
        &lt;/plugins>
    &lt;/build>

&lt;/project>
</pre><p>For the example, the features descriptor is very simple:</p><pre>
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;features>

   &lt;feature name="my" version="1.0">
      &lt;bundle>mvn:commons-collections/commons-collections/3.2.1&lt;/bundle>
   &lt;/feature>

&lt;/features>
</pre><p>To create the kar archive, simply type:</p><pre>
mvn install
</pre><p>and you will have your kar in the <tt>target</tt> directory.</p><h2 id="Deployakararchive">Deploy a kar archive</h2><p>Karaf provides a KAR deployer:</p><pre>
karaf@root> la|grep -i archive
[  12] [Active     ] [Created     ] [   30] Apache Karaf :: Deployer :: Karaf Archive (.kar) (2.2.4)
</pre><p>It's a core deployer (you don't need to install additional features).</p><p>To deploy a kar, simply drop the kar into the deploy directory. The KAR Deployer will deploy all the kar content starting<br/>from the features descriptor.</p><p>The KAR Deployer creates a repository dedicated to your kar (in the $/local-repo) and register the features<br/>descriptor. You can now see your feature available for installation:</p><pre>
karaf@root> features:list|grep -i my
[uninstalled] [1.0             ] my                            repo-0
</pre><p>Now you can use any commands available on features:</p><pre>
karaf@root> features:install my
</pre><h1 id="Configuration">Configuration</h1><p>The files in the <tt>etc</tt> directory are used to set the startup configuration.  </p><p>For dynamic configuration, Karaf provides a suite of command to administer the configuration service grouped under <tt>config</tt>. To learn about all currently supported configuration commands type:</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Command                                </th><th class="confluenceTh"> Description   </th></tr><tr><td class="confluenceTd"> <a href="commands/config-cancel.html"><tt>cancel</tt></a>     </td><td class="confluenceTd"> Change the changes to the configuration being edited. </td></tr><tr><td class="confluenceTd"> <a href="commands/config-edit.html"><tt>edit</tt></a>         </td><td class="confluenceTd"> Create or edit a configuration. </td></tr><tr><td class="confluenceTd"> <a href="commands/config-list.html"><tt>list</tt></a>         </td><td class="confluenceTd"> List existing configurations. </td></tr><tr><td class="confluenceTd"> <a href="commands/config-propdel.html"><tt>propdel</tt></a>   </td><td class="confluenceTd"> Delete a property from the edited configuration. </td></tr><tr><td class="confluenceTd"> <a href="commands/config-proplist.html"><tt>proplist</tt></a> </td><td class="confluenceTd"> List properties from the edited configuration. </td></tr><tr><td class="confluenceTd"> <a href="commands/config-propset.html"><tt>propset</tt></a>   </td><td class="confluenceTd"> Set a property on the edited configuration. </td></tr><tr><td class="confluenceTd"> <a href="commands/config-update.html"><tt>update</tt></a>     </td><td class="confluenceTd"> Save and propagate changes from the configuration being edited. </td></tr></table></div><h2 id="Editing">Editing</h2><h3 id="SelectConfigurationToEdit">Select Configuration To Edit</h3><p>For example to edit configuration <tt>foo.bar</tt>:</p><pre>
karaf@root> config:edit foo.bar
</pre><h3 id="ModifyProperties">Modify Properties</h3><p>Use:</p> <p> * <a href="commands/config-proplist.html"><tt>config:proplist</tt></a> to list existing properties<br/> * <a href="commands/config-propdel.html"><tt>config:propdel</tt></a> to delete existing properties<br/> * <a href="commands/config-propset.html"><tt>config:propset</tt></a> to set a new value for a property</p><p>Any number of properties can be modified within a single editing session. </p><h3 id="CommitOrRollbackChanges">Commit Or Rollback Changes</h3><p>Use</p><p> * <a href="commands/config-update.html"><tt>config:update</tt></a> to commit all changes made in the current session<br/> * <a href="commands/config-cancel.html"><tt>config:cancel</tt></a> to roll back any changes made in the current session</p><h1 id="PaxWebOSGiHttpService">Pax Web (OSGi HttpService)</h1><p>The Karaf http feature enables the Pax Web implementation of the OSGi HTTP service.</p><h2 id="InstallingtheHTTPfeature">Installing the HTTP feature</h2><pre>
root@karaf> features:install http
</pre><p>Create a file <tt>etc/org.ops4j.pax.web.cfg</tt> with the following content:</p><pre>
org.osgi.service.http.port=8080
</pre><p>This tells Pax Web to listen to the port 8080. As soon as the http feature is installed and the config<br/>file is present, the following URL will be reachable:</p><pre>
http://localhost:8080/
</pre><h2 id="RegisteringaservletwiththeHttpServicemanually">Registering a servlet with the HttpService manually</h2><p>See <a href="http://felix.apache.org/site/apache-felix-http-service.html">Apache Felix HTTP Service</a>.</p><h2 id="UsingthePaxWebwhiteboardextender">Using the Pax Web whiteboard extender</h2><p>The Pax Web whiteboard extender is part of the war feature. So use the following command to install:</p><pre>
root@karaf> features:install war
</pre><p>The <a href="http://wiki.ops4j.org/display/ops4j/Pax+Web+Extender+-+Whiteboard">Pax Web whiteboard</a> extender listens to services<br/>of interface type HttpServlet and Filter.<br/>It will register each of these interfaces with the HttpService and remove them as soon as the service goes down.<br/>So it is much more convenient than registering with the HttpService directly.</p><pre>
&lt;blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0">
    &lt;service interface="javax.servlet.http.HttpServlet">
        &lt;service-properties>
            &lt;entry key="alias" value="/myservlet"/>
        &lt;/service-properties>
        &lt;bean id="myServlet" class="com.example.MyServlet"/>
    &lt;/service>
&lt;/blueprint>
</pre><p>The above snippet publishes the Servlet MyServlet on http://localhost:8080/myServlet.</p><p>Please keep in mind that the Whiteboard pattern for Servlets is not standardized and only works with Pax Web.</p><h1 id="Webapplications">Web applications</h1><h2 id="Installingwarsupport">Installing war support</h2><p>The following steps will install the "war" feature (support for deploying WAR files with Servlet and JSPs into a Jetty server) into your Karaf instance.</p><ol><li>List the available features -<pre>karaf@root> features:list 
 State        Name
. . .
[uninstalled] [2.2.0] obr        karaf-2.2.0
[uninstalled] [2.2.0] config     karaf-2.2.0
[uninstalled] [2.2.0] http       karaf-2.2.0
[uninstalled] [2.2.0] war        karaf-2.2.0
[uninstalled] [2.2.0] webconsole karaf-2.2.0
[installed  ] [2.2.0] ssh        karaf-2.2.0
. . .
</pre></li><li>Install the war feature (and the sub-features it requires) -<pre>karaf@root> features:install war 
</pre><p>Note: you can use the -v or --verbose to see exactly what Karaf does</p><pre>karaf@root> features:install -v war
Installing feature war 2.1.99-SNAPSHOT
Installing feature http 2.1.99-SNAPSHOT
Installing feature jetty 7.1.6.v20100715
Installing bundle mvn:org.apache.geronimo.specs/geronimo-servlet_2.5_spec/1.1.2
Found installed bundle: org.apache.servicemix.bundles.asm [10]
Installing bundle mvn:org.eclipse.jetty/jetty-util/7.1.6.v20100715
Installing bundle mvn:org.eclipse.jetty/jetty-io/7.1.6.v20100715
Installing bundle mvn:org.eclipse.jetty/jetty-http/7.1.6.v20100715
Installing bundle mvn:org.eclipse.jetty/jetty-continuation/7.1.6.v20100715
Installing bundle mvn:org.eclipse.jetty/jetty-server/7.1.6.v20100715
Installing bundle mvn:org.eclipse.jetty/jetty-security/7.1.6.v20100715
Installing bundle mvn:org.eclipse.jetty/jetty-servlet/7.1.6.v20100715
Installing bundle mvn:org.eclipse.jetty/jetty-xml/7.1.6.v20100715
Checking configuration file mvn:org.apache.karaf/apache-karaf/2.1.99-SNAPSHOT/xml/jettyconfig
Installing bundle mvn:org.ops4j.pax.web/pax-web-api/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-spi/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-runtime/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-jetty/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-jsp/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-extender-war/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-extender-whiteboard/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.web/pax-web-deployer/0.8.2-SNAPSHOT
Installing bundle mvn:org.ops4j.pax.url/pax-url-war/1.2.4
</pre></li><li>Verify the features were installed<pre>servicemix> features/list
 State        Name
. . .
[installed ] [2.2.0] http karaf-2.2.0
[installed ] [2.2.0] war  karaf-2.2.0
. . .
</pre></li><li>Verify the installed bundles were started<pre>karaf@root> osgi:list 
START LEVEL 100
   ID   State         Level  Name
. . .
[ 32] [Active ] [ ] [ 60] geronimo-servlet_2.5_spec (1.1.2) 
[ 33] [Active ] [ ] [ 60] Apache ServiceMix :: Bundles :: jetty (6.1.22.2) 
[ 34] [Active ] [ ] [ 60] OPS4J Pax Web - API (1.0.0)
[ 35] [Active ] [ ] [ 60] OPS4J Pax Web - Service SPI (1.0.0)
[ 36] [Active ] [ ] [ 60] OPS4J Pax Web - Runtime (1.0.0)
[ 37] [Active ] [ ] [ 60] OPS4J Pax Web - Jetty (1.0.0)
[ 38] [Active ] [ ] [ 60] OPS4J Pax Web - Jsp Support (1.0.0)
[ 39] [Active ] [ ] [ 60] OPS4J Pax Web - Extender - WAR (1.0.0)
[ 40] [Active ] [ ] [ 60] OPS4J Pax Web - Extender - Whiteboard (1.0.0)
[ 42] [Active ] [ ] [ 60] OPS4J Pax Web - FileInstall Deployer (1.0.0)
[ 41] [Active ] [ ] [ 60] OPS4J Pax Url - war:, war-i: (1.2.4)
. . .
</pre></li><li>The Jetty server should now be listening on http://localhost:8181/, but with no published applications available.<pre>HTTP ERROR: 404
NOT_FOUND
RequestURI=/
Powered by jetty://
</pre></li></ol><h2 id="DeployingaWARtotheinstalledwebfeature">Deploying a WAR to the installed web feature</h2><p>The following steps will describe how to install a simple WAR file (with JSPs or Servlets) to the just installed web feature.</p><ol><li>To deploy a WAR (JSP or Servlet) to Jetty, update its MANIFEST.MF to include the required OSGi headers as described here - <br/><p><a href="http://team.ops4j.org/wiki/display/ops4j/Pax+Web+Extender+-+War+-+OSGi-fy">http://team.ops4j.org/wiki/display/ops4j/Pax+Web+Extender+-+War+-+OSGi-fy</a></p></li><li>Copy the updated WAR (archive or extracted files) to the <em>deploy</em> directory.</li></ol><p>If you want to deploy a sample web application into Karaf, you could use the following command:</p><pre>
karaf@root> osgi:install -s webbundle:http://tomcat.apache.org/tomcat-5.5-doc/appdev/sample/sample.war?Bundle-SymbolicName=tomcat-sample&amp;Webapp-Context=/sample
</pre><p>Then open your web browser and point to <tt>http://localhost:8181/sample/index.html</tt>.</p><h1 id="JREandsystempackagestuning">JRE and system packages tuning</h1><p>Some packages are part of the JRE, but could be provided by tier libraries.</p><p>Some examples of package in this case are:</p><ul><li><tt>javax.xml.stream</tt> package is provided by the JRE, but also by Apache Geronimo Spec bundles (and the implementation of provided by Woodstox).</li><li><tt>com.sun.org.apache.xerces.internal.dom</tt> package is provided by the JRE, but also by Apache Xerces.</li><li><tt>javax.activation</tt> package is provided by the JRE, but also by Apache Geronimo Spec bundles.</li><li><tt>javax.annotation</tt> package is provided by the JRE, but also by Apache Geronimo Spec bundles.</li><li>etc ...</li></ul><p>We should define in the Karaf instance which packages should be provided by the JRE or by tier bundles.</p><p>Moreover, we should manage the exported packages of JRE depending of the JRE version: the JRE 1.6 provides more packages<br/>than the 1.5 one.</p><p>To customize this in Karaf, you can tune the <tt>etc/jre.properties</tt> file.</p><p>In the <tt>etc/jre.properties</tt> file, you have two properties <tt>jre-1.5</tt> and <tt>jre-1.6</tt>.</p><p>They allow you to define the packages exported by the JRE (in function of the runtime version).<br/>Each property provide the exhaustive list of packages provided by the JRE (and so part of the sytem packages).</p><p>For instance, a "standard" Karaf distribution provides the following <tt>etc/jre.properties</tt>:</p><pre>
#
# Java platform package export properties.
#

# Standard package set.  Note that:
#   - javax.transaction* is exported with a mandatory attribute
jre-1.5= \
 javax.accessibility, \
 javax.activity, \
 javax.crypto, \
 javax.crypto.interfaces, \
 javax.crypto.spec, \
 javax.imageio, \
 javax.imageio.event, \
 javax.imageio.metadata, \
 javax.imageio.plugins.bmp, \
 javax.imageio.plugins.jpeg, \
 javax.imageio.spi, \
 javax.imageio.stream, \
 javax.management, \
 javax.management.loading, \
 javax.management.modelmbean, \
 javax.management.monitor, \
 javax.management.openmbean, \
 javax.management.relation, \
 javax.management.remote, \
 javax.management.remote.rmi, \
 javax.management.timer, \
 javax.naming, \
 javax.naming.directory, \
 javax.naming.event, \
 javax.naming.ldap, \
 javax.naming.spi, \
 javax.net, \
 javax.net.ssl, \
 javax.print, \
 javax.print.attribute, \
 javax.print.attribute.standard, \
 javax.print.event, \
 javax.rmi, \
 javax.rmi.CORBA, \
 javax.rmi.ssl, \
 javax.security.auth, \
 javax.security.auth.callback, \
 javax.security.auth.kerberos, \
 javax.security.auth.login, \
 javax.security.auth.spi, \
 javax.security.auth.x500, \
 javax.security.cert, \
 javax.security.sasl, \
 javax.sound.midi, \
 javax.sound.midi.spi, \
 javax.sound.sampled, \
 javax.sound.sampled.spi, \
 javax.sql, \
 javax.sql.rowset, \
 javax.sql.rowset.serial, \
 javax.sql.rowset.spi, \
 javax.swing, \
 javax.swing.border, \
 javax.swing.colorchooser, \
 javax.swing.event, \
 javax.swing.filechooser, \
 javax.swing.plaf, \
 javax.swing.plaf.basic, \
 javax.swing.plaf.metal, \
 javax.swing.plaf.multi, \
 javax.swing.plaf.synth, \
 javax.swing.table, \
 javax.swing.text, \
 javax.swing.text.html, \
 javax.swing.text.html.parser, \
 javax.swing.text.rtf, \
 javax.swing.tree, \
 javax.swing.undo, \
 javax.transaction; javax.transaction.xa; partial=true; mandatory:=partial, \
 javax.xml, \
 javax.xml.datatype, \
 javax.xml.namespace, \
 javax.xml.parsers, \
 javax.xml.transform, \
 javax.xml.transform.dom, \
 javax.xml.transform.sax, \
 javax.xml.transform.stream, \
 javax.xml.validation, \
 javax.xml.xpath, \
 org.ietf.jgss, \
 org.omg.CORBA, \
 org.omg.CORBA_2_3, \
 org.omg.CORBA_2_3.portable, \
 org.omg.CORBA.DynAnyPackage, \
 org.omg.CORBA.ORBPackage, \
 org.omg.CORBA.portable, \
 org.omg.CORBA.TypeCodePackage, \
 org.omg.CosNaming, \
 org.omg.CosNaming.NamingContextExtPackage, \
 org.omg.CosNaming.NamingContextPackage, \
 org.omg.Dynamic, \
 org.omg.DynamicAny, \
 org.omg.DynamicAny.DynAnyFactoryPackage, \
 org.omg.DynamicAny.DynAnyPackage, \
 org.omg.IOP, \
 org.omg.IOP.CodecFactoryPackage, \
 org.omg.IOP.CodecPackage, \
 org.omg.Messaging, \
 org.omg.PortableInterceptor, \
 org.omg.PortableInterceptor.ORBInitInfoPackage, \
 org.omg.PortableServer, \
 org.omg.PortableServer.CurrentPackage, \
 org.omg.PortableServer.POAManagerPackage, \
 org.omg.PortableServer.POAPackage, \
 org.omg.PortableServer.portable, \
 org.omg.PortableServer.ServantLocatorPackage, \
 org.omg.SendingContext, \
 org.omg.stub.java.rmi, \
 org.omg.stub.javax.management.remote.rmi, \
 org.w3c.dom, \
 org.w3c.dom.bootstrap, \
 org.w3c.dom.css, \
 org.w3c.dom.events, \
 org.w3c.dom.html, \
 org.w3c.dom.ls, \
 org.w3c.dom.ranges, \
 org.w3c.dom.stylesheets, \
 org.w3c.dom.traversal, \
 org.w3c.dom.views, \
 org.xml.sax, \
 org.xml.sax.ext, \
 org.xml.sax.helpers

# Standard package set.  Note that:
#   - javax.transaction* is exported with a mandatory attribute
jre-1.6= \
 javax.accessibility, \
 javax.activation, \
 javax.activity, \
 javax.annotation, \
 javax.annotation.processing, \
 javax.crypto, \
 javax.crypto.interfaces, \
 javax.crypto.spec, \
 javax.imageio, \
 javax.imageio.event, \
 javax.imageio.metadata, \
 javax.imageio.plugins.bmp, \
 javax.imageio.plugins.jpeg, \
 javax.imageio.spi, \
 javax.imageio.stream, \
 javax.jws, \
 javax.jws.soap, \
 javax.lang.model, \
 javax.lang.model.element, \
 javax.lang.model.type, \
 javax.lang.model.util, \
 javax.management, \
 javax.management.loading, \
 javax.management.modelmbean, \
 javax.management.monitor, \
 javax.management.openmbean, \
 javax.management.relation, \
 javax.management.remote, \
 javax.management.remote.rmi, \
 javax.management.timer, \
 javax.naming, \
 javax.naming.directory, \
 javax.naming.event, \
 javax.naming.ldap, \
 javax.naming.spi, \
 javax.net, \
 javax.net.ssl, \
 javax.print, \
 javax.print.attribute, \
 javax.print.attribute.standard, \
 javax.print.event, \
 javax.rmi, \
 javax.rmi.CORBA, \
 javax.rmi.ssl, \
 javax.script, \
 javax.security.auth, \
 javax.security.auth.callback, \
 javax.security.auth.kerberos, \
 javax.security.auth.login, \
 javax.security.auth.spi, \
 javax.security.auth.x500, \
 javax.security.cert, \
 javax.security.sasl, \
 javax.sound.midi, \
 javax.sound.midi.spi, \
 javax.sound.sampled, \
 javax.sound.sampled.spi, \
 javax.sql, \
 javax.sql.rowset, \
 javax.sql.rowset.serial, \
 javax.sql.rowset.spi, \
 javax.swing, \
 javax.swing.border, \
 javax.swing.colorchooser, \
 javax.swing.event, \
 javax.swing.filechooser, \
 javax.swing.plaf, \
 javax.swing.plaf.basic, \
 javax.swing.plaf.metal, \
 javax.swing.plaf.multi, \
 javax.swing.plaf.synth, \
 javax.swing.table, \
 javax.swing.text, \
 javax.swing.text.html, \
 javax.swing.text.html.parser, \
 javax.swing.text.rtf, \
 javax.swing.tree, \
 javax.swing.undo, \
 javax.tools, \
 javax.transaction; javax.transaction.xa; partial=true; mandatory:=partial, \
 javax.xml, \
 javax.xml.bind, \
 javax.xml.bind.annotation, \
 javax.xml.bind.annotation.adapters, \
 javax.xml.bind.attachment, \
 javax.xml.bind.helpers, \
 javax.xml.bind.util, \
 javax.xml.crypto, \
 javax.xml.crypto.dom, \
 javax.xml.crypto.dsig, \
 javax.xml.crypto.dsig.dom, \
 javax.xml.crypto.dsig.keyinfo, \
 javax.xml.crypto.dsig.spec, \
 javax.xml.datatype, \
 javax.xml.namespace, \
 javax.xml.parsers, \
 javax.xml.soap, \
 javax.xml.stream, \
 javax.xml.stream.events, \
 javax.xml.stream.util, \
 javax.xml.transform, \
 javax.xml.transform.dom, \
 javax.xml.transform.sax, \
 javax.xml.transform.stax, \
 javax.xml.transform.stream, \
 javax.xml.validation, \
 javax.xml.ws, \
 javax.xml.ws.handler, \
 javax.xml.ws.handler.soap, \
 javax.xml.ws.http, \
 javax.xml.ws.soap, \
 javax.xml.ws.spi, \
 javax.xml.ws.wsaddressing, \
 javax.xml.xpath, \
 org.ietf.jgss, \
 org.omg.CORBA, \
 org.omg.CORBA_2_3, \
 org.omg.CORBA_2_3.portable, \
 org.omg.CORBA.DynAnyPackage, \
 org.omg.CORBA.ORBPackage, \
 org.omg.CORBA.portable, \
 org.omg.CORBA.TypeCodePackage, \
 org.omg.CosNaming, \
 org.omg.CosNaming.NamingContextExtPackage, \
 org.omg.CosNaming.NamingContextPackage, \
 org.omg.Dynamic, \
 org.omg.DynamicAny, \
 org.omg.DynamicAny.DynAnyFactoryPackage, \
 org.omg.DynamicAny.DynAnyPackage, \
 org.omg.IOP, \
 org.omg.IOP.CodecFactoryPackage, \
 org.omg.IOP.CodecPackage, \
 org.omg.Messaging, \
 org.omg.PortableInterceptor, \
 org.omg.PortableInterceptor.ORBInitInfoPackage, \
 org.omg.PortableServer, \
 org.omg.PortableServer.CurrentPackage, \
 org.omg.PortableServer.POAManagerPackage, \
 org.omg.PortableServer.POAPackage, \
 org.omg.PortableServer.portable, \
 org.omg.PortableServer.ServantLocatorPackage, \
 org.omg.SendingContext, \
 org.omg.stub.java.rmi, \
 org.omg.stub.javax.management.remote.rmi, \
 org.w3c.dom, \
 org.w3c.dom.bootstrap, \
 org.w3c.dom.css, \
 org.w3c.dom.events, \
 org.w3c.dom.html, \
 org.w3c.dom.ls, \
 org.w3c.dom.ranges, \
 org.w3c.dom.stylesheets, \
 org.w3c.dom.traversal, \
 org.w3c.dom.views, \
 org.w3c.dom.xpath, \
 org.xml.sax, \
 org.xml.sax.ext, \
 org.xml.sax.helpers
</pre><p>For instance, if we deploy the Apache Geronimo Specs bundle providing the <tt>javax.xml.stream</tt> package, we have to comment<br/>the <tt>javax.xml.stream</tt> package in the the jre-1.6 definition. Indeed, jre-1.5 doesn't provide <tt>javax.xml.stream</tt>, it's<br/>new in the JRE 1.6:</p><pre>
jre-1.6= \
[...]
# javax.xml.stream, \
# javax.xml.stream.events, \
# javax.xml.stream.util, \
[...]
</pre><h1 id="MonitoringandAdministrationusingJMX">Monitoring and Administration using JMX</h1><p>Apache Karaf provides a large set of MBeans that allow you to fully monitore and administrate Karaf using any JMX client<br/>(like jconsole for instance).</p><p>You can find more or less the same actions that you can do using the shell commands on the JMX layer.</p><p>Apache Karaf provides the following MBeans:</p><ul><li>org.apache.karaf:type=admin to administrate the child instances</li><li>org.apache.karaf:type=bundles to manipulate the OSGi bundles</li><li>org.apache.karaf:type=config to manipulate the Karaf configuration files (in the etc folder) and the ConfigAdmin layer</li><li>org.apache.karaf:type=dev to get information and manipulate the OSGi framework</li><li>org.apache.karaf:type=diagnostic to create information file (dump) about Karaf activity</li><li>org.apache.karaf:type=features to manipulate the Karaf features</li><li>org.apache.karaf:type=log to manipulate to logging layer</li><li>org.apache.karaf:type=packages to manipulate to PackageAdmin layer and get information about exported and imported packages</li><li>org.apache.karaf:type=services to get information about the OSGi services</li><li>org.apache.karaf:type=system to shutdown the Karaf container itself</li><li>org.apache.karaf:type=web to get information about the Web bundles (installed with the war feature)</li><li>org.apache.karaf:type=obr to manipulate the OBR layer (installed with the obr feature)</li></ul><h1 id="DevelopersGuide">Developers Guide</h1><h1 id="Archetypes">Archetypes</h1><p>Karaf provides archetypes to easily create commands, manage [features or repository and create a kar archive.<br/>This section describes each of them and explain How to use it.</p><h2 id="Createacommandkarafcommandarchetype">Create a command (karaf-command-archetype)</h2><p>This archetype creates a Maven skeleton project that you will use to develop new Karaf commands.</p><h3 id="Commandline">Command line</h3><p>Using the command line, we can create our project:</p><pre>
mvn archetype:generate \
  -DarchetypeGroupId=org.apache.karaf.archetypes \
  -DartifactId=karaf-command-archetype \
  -DarchetypeVersion=2.3.0 \
  -DgroupId=com.mycompany \
  -DartifactId=com.mycompany.command \
  -Dversion=1.0-SNAPSHOT \
  -Dpackage=com.mycompany.package
</pre><h3 id="Additionalparameters">Additional parameters</h3><p>During the maven creation process, additional questions will be asked on the console :</p><ul><li><ul><li>Define value for property 'command':<p>   The name of the command (list, add-item, ...)</p></li><li>Define value for property 'description':<p>   Provide a description of the command that you want to create. This description will be displayed in the Karaf console when<br/>   the parameter --help is used</p></li><li>Define value for property 'scope':<p>   This value represents the family name to which the command belongs (features, osgi, admin, jaas, ...)</p><h3 id="ResultofMavencommandexecution">Result of Maven command execution</h3><pre>
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] >>> maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom >>>
[INFO]
[INFO] &lt;&lt;&lt; maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom &lt;&lt;&lt;
[INFO]
[INFO] --- maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom ---
[INFO] Generating project in Interactive mode
[INFO] Archetype repository missing. Using the one from [org.apache.karaf.archetypes:karaf-command-archetype:2.3.0] found in catalog local
[INFO] Using property: groupId = com.mycompany
[INFO] Using property: artifactId = com.mycompany.command
[INFO] Using property: version = 1.0-SNAPSHOT
[INFO] Using property: package = com.mycompany.package
Define value for property 'command': : list
Define value for property 'description': : List sample command
Define value for property 'scope': : my
Confirm properties configuration:
groupId: com.mycompany
artifactId: com.mycompany.command
version: 1.0-SNAPSHOT
package: com.mycompany.package
command: list
description: List sample command
scope: my
 Y: :
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: karaf-command-archetype:2.3.0
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.command
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: packageInPathFormat, Value: com/mycompany/package
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: scope, Value: my
[INFO] Parameter: description, Value: List sample command
[INFO] Parameter: command, Value: list
[INFO] Parameter: artifactId, Value: com.mycompany.command
[WARNING] Don't override file /home/jbonofre/workspace/karaf/test/com.mycompany.command/pom.xml
[INFO] project created from Archetype in dir: /home/jbonofre/workspace/karaf/test/com.mycompany.command
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 27.204s
[INFO] Finished at: Mon Dec 19 09:38:49 CET 2011
[INFO] Final Memory: 7M/111M
[INFO] ------------------------------------------------------------------------
</pre></li></ul></li></ul><p>Next, you can import your project in Eclipse/IntelliJ and developp the karaf command.</p><h2 id="CreateanOSGibundlekarafbundlearchetype">Create an OSGi bundle (karaf-bundle-archetype)</h2><p>This archetype creates a Maven skeleton to create an OSGi bundle, including a bundle Activator (a special callback class for bundle start/stop).</p><h3 id="Commandline2">Command line</h3><p>Using the command line, we can create our project:</p><pre>
mvn archetype:generate \
    -DarchetypeGroupId=org.apache.karaf.archetypes \
    -DarchetypeArtifactId=karaf-bundle-archetype \
    -DarchetypeVersion=2.3.0 \
    -DgroupId=com.mycompany \
    -DartifactId=com.mycompany.bundle \
    -Dversion=1.0-SNAPSHOT \
    -Dpackage=com.mycompany.package
</pre><h3 id="ResultofMavencommandexecution2">Result of Maven command execution</h3><pre>
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] >>> maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom >>>
[INFO]
[INFO] &lt;&lt;&lt; maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom &lt;&lt;&lt;
[INFO]
[INFO] --- maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom ---
[INFO] Generating project in Interactive mode
[INFO] Archetype repository missing. Using the one from [org.apache.karaf.archetypes:karaf-bundle-archetype:3.0.0-SNAPSHOT] found in catalog local
[INFO] Using property: groupId = com.mycompany
[INFO] Using property: artifactId = com.mycompany.bundle
[INFO] Using property: version = 1.0-SNAPSHOT
[INFO] Using property: package = com.mycompany.package
Confirm properties configuration:
groupId: com.mycompany
artifactId: com.mycompany.bundle
version: 1.0-SNAPSHOT
package: com.mycompany.package
 Y: :
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: karaf-bundle-archetype:3.0.0-SNAPSHOT
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.bundle
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: packageInPathFormat, Value: com/mycompany/package
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.bundle
[INFO] project created from Archetype in dir: /home/jbonofre/workspace/karaf/test/com.mycompany.bundle
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 7.895s
[INFO] Finished at: Mon Dec 19 11:41:44 CET 2011
[INFO] Final Memory: 8M/111M
[INFO] ------------------------------------------------------------------------
</pre><h2 id="CreateanOSGiblueprintbundlekarafblueprintarchetype">Create an OSGi blueprint bundle (karaf-blueprint-archetype)</h2><p>This archetype creates a Maven skeleton project to create an OSGi blueprint bundle, including a sample bean exposed as an OSGi service in the blueprint XML descriptor.</p><h3 id="Commandline3">Command line</h3><p>Using the command line, we can create our project:</p><pre>
mvn archetype:generate \
    -DarchetypeGroupId=org.apache.karaf.archetypes \
    -DarchetypeArtifactId=karaf-blueprint-archetype \
    -DarchetypeVersion=2.3.0 \
    -DgroupId=com.mycompany \
    -DartifactId=com.mycompany.blueprint \
    -Dversion=1.0-SNAPSHOT \
    -Dpackage=com.mycompany.blueprint
</pre><h3 id="ResultofMavencommandexecution3">Result of Maven command execution</h3><pre>
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] >>> maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom >>>
[INFO]
[INFO] &lt;&lt;&lt; maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom &lt;&lt;&lt;
[INFO]
[INFO] --- maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom ---
[INFO] Generating project in Interactive mode
[INFO] Archetype repository missing. Using the one from [org.apache.karaf.archetypes:karaf-blueprint-archetype:3.0.0-SNAPSHOT] found in catalog local
[INFO] Using property: groupId = com.mycompany
[INFO] Using property: artifactId = com.mycompany.blueprint
[INFO] Using property: version = 1.0-SNAPSHOT
[INFO] Using property: package = com.mycompany.package
Confirm properties configuration:
groupId: com.mycompany
artifactId: com.mycompany.blueprint
version: 1.0-SNAPSHOT
package: com.mycompany.package
 Y: :
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: karaf-blueprint-archetype:3.0.0-SNAPSHOT
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.blueprint
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: packageInPathFormat, Value: com/mycompany/package
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.blueprint
[INFO] project created from Archetype in dir: /home/jbonofre/workspace/karaf/test/com.mycompany.blueprint
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1:06:36.741s
[INFO] Finished at: Mon Dec 19 13:04:43 CET 2011
[INFO] Final Memory: 7M/111M
[INFO] ------------------------------------------------------------------------
</pre><h2 id="CreateafeaturesXMLkaraffeaturearchetype">Create a features XML (karaf-feature-archetype)</h2><p>This archetype creates a Maven skeleton project which create a features XML file, using the dependencies that you define in the POM.</p><h3 id="Commandline4">Command line</h3><p>Using the command line, we can create our project:</p><pre>
mvn archetype:generate \
    -DarchetypeGroupId=org.apache.karaf.archetypes \
    -DarchetypeArtifactId=karaf-feature-archetype \
    -DarchetypeVersion=2.3.0 \
    -DgroupId=my.company \
    -DartifactId=my.company.feature \
    -Dversion=1.0-SNAPSHOT \
    -Dpackage=my.company.package
</pre><h3 id="Resultofmavencommandexecution">Result of maven command execution</h3><pre>
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] >>> maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom >>>
[INFO]
[INFO] &lt;&lt;&lt; maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom &lt;&lt;&lt;
[INFO]
[INFO] --- maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom ---
[INFO] Generating project in Interactive mode
[INFO] Archetype repository missing. Using the one from [org.apache.karaf.archetypes:karaf-feature-archetype:3.0.0-SNAPSHOT] found in catalog local
[INFO] Using property: groupId = com.mycompany
[INFO] Using property: artifactId = com.mycompany.feature
[INFO] Using property: version = 1.0-SNAPSHOT
[INFO] Using property: package = com.mycompany.package
Confirm properties configuration:
groupId: com.mycompany
artifactId: com.mycompany.feature
version: 1.0-SNAPSHOT
package: com.mycompany.package
 Y: :
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: karaf-feature-archetype:3.0.0-SNAPSHOT
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.feature
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: packageInPathFormat, Value: com/mycompany/package
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.feature
[INFO] project created from Archetype in dir: /home/jbonofre/workspace/karaf/test/com.mycompany.feature
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 7.262s
[INFO] Finished at: Mon Dec 19 13:20:00 CET 2011
[INFO] Final Memory: 7M/111M
[INFO] ------------------------------------------------------------------------
</pre><h2 id="CreateaKARfilekarafkararchetype">Create a KAR file (karaf-kar-archetype)</h2><p>This archetype creates a Maven skeleton project including a features XML sample, used to generate a KAR file.</p><h3 id="Commandline5">Command line</h3><p>Using the command line, we can create our project:</p><pre>
mvn archetype:generate \
    -DarchetypeGroupId=org.apache.karaf.archetypes \
    -DarchetypeArtifactId=karaf-kar-archetype \
    -DarchetypeVersion=2.3.0 \
    -DgroupId=com.mycompany \
    -DartifactId=com.mycompany.kar \
    -Dversion=1.0-SNAPSHOT \
    -Dpackage=com.mycompany.package
</pre><h3 id="Resultofmavencommandexecution2">Result of maven command execution</h3><pre>
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] >>> maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom >>>
[INFO]
[INFO] &lt;&lt;&lt; maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom &lt;&lt;&lt;
[INFO]
[INFO] --- maven-archetype-plugin:2.1:generate (default-cli) @ standalone-pom ---
[INFO] Generating project in Interactive mode
[INFO] Archetype repository missing. Using the one from [org.apache.karaf.archetypes:karaf-kar-archetype:3.0.0-SNAPSHOT] found in catalog local
[INFO] Using property: groupId = com.mycompany
[INFO] Using property: artifactId = com.mycompany.kar
[INFO] Using property: version = 1.0-SNAPSHOT
[INFO] Using property: package = com.mycompany.package
Confirm properties configuration:
groupId: com.mycompany
artifactId: com.mycompany.kar
version: 1.0-SNAPSHOT
package: com.mycompany.package
 Y: :
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: karaf-kar-archetype:3.0.0-SNAPSHOT
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.kar
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: packageInPathFormat, Value: com/mycompany/package
[INFO] Parameter: package, Value: com.mycompany.package
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.mycompany
[INFO] Parameter: artifactId, Value: com.mycompany.kar
[INFO] project created from Archetype in dir: /home/jbonofre/workspace/karaf/test/com.mycompany.kar
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 7.465s
[INFO] Finished at: Mon Dec 19 13:30:15 CET 2011
[INFO] Final Memory: 8M/157M
[INFO] ------------------------------------------------------------------------
</pre><h1 id="BrandingtheConsole">Branding the Console</h1><p>This chapter will show you how to customize the user interface of the Karaf console, making  <br/>changes such as a new welcome message and console prompt.  This is what we refer to as "branding" Karaf.</p><h2 id="Createyourbrandingbundle">Create your branding bundle</h2><p>At startup, Karaf is looking for a bundle which exports the <tt>org.apache.karaf.branding</tt> package containing a <tt>branding.properties</tt><br/>file.</p><p>So you need to create a very simple bundle containing just a <tt>org/apache/karaf/branding/branding.properties</tt> file.</p><p>The Maven POM of your branding bundle should look like this:</p><pre>
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

    &lt;modelVersion>4.0.0&lt;/modelVersion>

    &lt;groupId>your.group.id&lt;/groupId>
    &lt;artifactId>your.branding.artifact.id&lt;/artifactId>
    &lt;version>1.0-SNAPSHOT&lt;/version>
    &lt;packaging>bundle&lt;/packaging>
    &lt;name>Your Branding Bundle Name&lt;/name>

    &lt;build>
        &lt;plugins>
            &lt;plugin>
                &lt;groupId>org.apache.felix&lt;/groupId>
                &lt;artifactId>maven-bundle-plugin&lt;/artifactId>
                &lt;version>2.2&lt;/version>
                &lt;extensions>true&lt;/extensions>
                &lt;configuration>
                    &lt;instructions>
                        &lt;Bundle-SymbolicName>manual&lt;/bundle-SymbolicName>
                        &lt;Import-Package>*&lt;/Import-Package>
                        &lt;Private-Package>!*&lt;/Private-Package>
                        &lt;Export-Package>
                            org.apache.karaf.branding
                        &lt;/Export-Package>
                        &lt;Spring-Context>*;public-context:=false&lt;/Spring-Context>
                    &lt;/instructions>
                &lt;/configuration>
            &lt;/plugin>
        &lt;/plugins>
    &lt;/build>

&lt;/project>
</pre><p>Now, add a <tt>src/main/resources/org/apache/karaf/branding/branding.properties</tt> similar to:</p><p>{</p><pre>}
welcome = \
\u001B[36m        __ __                  ____      \u001B[0m\r\n\
\u001B[36m       / //_/____ __________ _/ __/      \u001B[0m\r\n\
\u001B[36m      / ,&lt;  / __ `/ ___/ __ `/ /_        \u001B[0m\r\n\
\u001B[36m     / /| |/ /_/ / /  / /_/ / __/        \u001B[0m\r\n\
\u001B[36m    /_/ |_|\\__,_/_/   \\__,_/_/         \u001B[0m\r\n\
\r\n\
\u001B[1m  Apache Karaf\u001B[0m (2.3.0)\r\n\
\r\n\
Hit '\u001B[1m&lt;tab>\u001B[0m' for a list of available commands\r\n\
   and '\u001B[1m[cmd] --help\u001B[0m' for help on a specific command.\r\n\
Hit '\u001B[1m&lt;ctrl-d>\u001B[0m' or '\u001B[1mosgi:shutdown\u001B[0m' to shutdown Karaf.\r\n

prompt = \u001B[1m${USER}@${APPLICATION}\u001B[0m>
{
</pre><p>}</p><p>As you can see, the <tt>branding.properties</tt> contains two properties:</p><ul><li>welcome is the welcome message displayed when you start Karaf.</li><li>prompt is the string used to display the console prompt. This string supports variables:<ul><li>$} defines the user name of the prompt. Caveat &#8211; the user name is presently static and hardcoded to "karaf",<p>however you can override here with your own static user name.</p></li><li>${{APPLICATION}} defines the Karaf instance name.</li></ul></li></ul><p>As you can see, both strings support ASCII escaped format. For instance \u001B[1m switches the foreground to bold and \u001B[0m<br/>switches it back to normal.</p><p>Some examples of customized prompts:</p><pre>
# Define a user with fancy colors
prompt = \u001B[36mmy-karaf-user\u001B[0m\u001B[1m@\u001B[0m\u001B[34m${APPLICATION}\u001B[0m>
</pre><pre>
# Static sober prompt
prompt = my-user@my-karaf>
</pre><h2 id="ConfiguringKaraftousethebrandingbundle">Configuring Karaf to use the branding bundle</h2><p>In order for Karaf to pick up the branding jar please edit the <br/>$KARAF_HOME/etc/custom.properties file to include the following: </p><p>  org.osgi.framework.system.packages.extra = \ <br/>    org.apache.karaf.branding;</p><h2 id="Installingthebrandingbundle">Installing the branding bundle</h2><p>Build your branding bundle:</p><pre>
mvn install
</pre><p>and simply drop the generated jar file into the Karaf lib directory.</p><p>Start Karaf and you will see your branded Karaf console.</p><h1 id="Extendingtheconsole">Extending the console</h1><p>This chapter will guide you through the steps needed to extend the console and create a new shell.  <br/>We will leverage Maven, Blueprint and OSGi, so you will need some knowledge of those products.</p><p>You may also find some information about the console at <a href="http://felix.apache.org/site/rfc-147-overview.html">http://felix.apache.org/site/rfc-147-overview.html</a>.</p><h2 id="Createtheprojectusingmaven">Create the project using maven</h2><p>We first need to create a project using Maven.  Let's leverage Maven archetypes for that.</p><h3 id="Commandline">Command line</h3><p>Using the command line, we can create our project:</p><pre>
mvn archetype:create \
  -DarchetypeArtifactId=maven-archetype-quickstart \
  -DgroupId=org.apache.karaf.shell.samples \
  -DartifactId=shell-sample-commands \
  -Dversion=1.0-SNAPSHOT
</pre><p>This generate the main <tt>pom.xml</tt> and some additional packages.</p><h3 id="Interactiveshell">Interactive shell</h3><p>You can also use the interactive mode for creating the skeleton project:</p><pre>
mvn archetype:generate
</pre><p>Use the following values when prompted:</p><pre>
Choose a number:  (1/2/3/4/5/6/7/.../32/33/34/35/36) 15: : 15
Define value for groupId: : org.apache.karaf.shell.samples
Define value for artifactId: : shell-sample-commands
Define value for version:  1.0-SNAPSHOT: : 
Define value for package: : org.apache.karaf.shell.samples
</pre><h3 id="Manualcreation">Manual creation</h3><p>Alternatively, you can simply create the directory <tt>shell-sample-commands</tt> and create the <tt>pom.xml</tt> file inside it:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;org.apache.karaf.shell.samples&lt;/groupId&gt;
  &lt;artifactId&gt;shell-sample-commands&lt;artifactId&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;name&gt;shell-sample-commmands&lt;/name&gt;


  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.karaf.shell&lt;/groupId&gt;
      &lt;artifactId&gt;org.apache.karaf.shell.console&lt;/artifactId&gt;
      &lt;version&gt;2.3.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
      &lt;version&gt;3.8.1&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;

  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
        &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.3.7&lt;/version&gt;
        &lt;configuration&gt;
          &lt;instructions&gt;
            &lt;Import-Package&gt;
              org.apache.felix.service.command,
              org.apache.felix.gogo.commands,
              org.apache.karaf.shell.console,
              *
            &lt;/Import-Package&gt;
          &lt;/instructions&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</code></pre></div><h2 id="ConfiguringforJava5">Configuring for Java 5</h2><p>We are using annotations to define commands, so we need to ensure Maven will actually use JDK 1.5 to compile the jar.<br/>Just add the following snippet after the <tt>dependencies</tt> section.</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
      &lt;configuration&gt;
        &lt;target&gt;1.5&lt;/target&gt;
        &lt;source&gt;1.5&lt;/source&gt;
      &lt;/configuration&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre></div><h2 id="LoadingtheprojectinyourIDE">Loading the project in your IDE</h2><p>We can use Maven to generate the needed files for your IDE:</p><p>Inside the project, run the following command</p><pre>
mvn eclipse:eclipse
</pre><p>or</p><pre>
mvn idea:idea
</pre><p>The project files for your IDE should now be created.  Just open the IDE and load the project.</p><h2 id="Creatingabasiccommandclass">Creating a basic command class</h2><p>We can now create the command class <tt>HelloShellCommand.java</tt></p><div class="syntax"><pre name='code' class='brush: java; gutter: false;'><code>
package org.apache.karaf.shell.samples;

import org.apache.felix.gogo.commands.Command;
import org.apache.karaf.shell.console.OsgiCommandSupport;

@Command(scope = &quot;test&quot;, name = &quot;hello&quot;, description=&quot;Says hello&quot;)
public class HelloShellCommand extends OsgiCommandSupport {

    @Override
    protected Object doExecute() throws Exception {
        System.out.println(&quot;Executing Hello command&quot;);
        return null;
    }
}</code></pre></div><h2 id="Creatingtheassociatedblueprintconfigurationfiles">Creating the associated blueprint configuration files</h2><p>The blueprint configuration file will be used to create the command and register it in the OSGi registry, which is the way to make the command available to Karaf console.  This blueprint file must be located in the <tt>OSGI-INF/blueprint/</tt> directory inside the bundle.</p><p>If you don't have the <tt>src/main/resources</tt> directory yet, create it.</p><pre>
mkdir src/main/resources
</pre><p>Then, re-generate the IDE project files and reload it so that this folder is now recognized as a source folder.</p><p>Inside this directory, create the <tt>OSGI-INF/blueprint/</tt> directory and put the following file inside (the name of this file has no impact at all):</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;&gt;

    &lt;command-bundle xmlns=&quot;http://karaf.apache.org/xmlns/shell/v1.0.0&quot;&gt;
        &lt;command name=&quot;test/hello&quot;&gt;
            &lt;action class=&quot;org.apache.karaf.shell.samples.HelloShellCommand&quot;/&gt;
        &lt;/command&gt;
    &lt;/command-bundle&gt;

&lt;/blueprint&gt;</code></pre></div><h2 id="Compilingthejar">Compiling the jar</h2><p>Let's try to build the jar.  Remove the test classes and sample classes if you used the artifact, then from the command line, run:</p><pre>
mvn install
</pre><p>The end of the maven output should look like:</p><pre>
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESSFUL
[INFO] ------------------------------------------------------------------------
</pre><h2 id="TestinKaraf">Test in Karaf</h2><p>Launch a Karaf instance and run the following command to install the newly created bundle:</p><pre>
karaf@root> osgi:install -s mvn:org.apache.karaf.shell.samples/shell-sample-commands/1.0-SNAPSHOT
</pre><p>Let's try running the command:</p><pre>
karaf@root> test:hello
Executing Hello command
</pre><h1 id="Commandcompleter">Command completer</h1><p>A completer allows you to automatically complete a command argument using &lt;tab>. A completer is simply a bean which is injected to a command.</p><p>Of course to be able to complete it, the command should require an argument.</p><h2 id="Commandargument">Command argument</h2><p>We add an argument to the HelloCommand:</p><pre>
package org.apache.karaf.shell.samples;

import org.apache.felix.gogo.commands.Command;
import org.apache.felix.gogo.commands.Argument;
import org.apache.karaf.shell.console.OsgiCommandSupport;

@Command(scope = "test", name = "hello", description="Says hello")
public class HelloShellCommand extends OsgiCommandSupport {

    @Argument(index = 0, name = "arg", description = "The command argument", required = false, multiValued = false)
    String arg = null;

    @Override
    protected Object doExecute() throws Exception {
        System.out.println("Executing Hello command");
        return null;
    }
}
</pre><p>The Blueprint configuration file is the same as previously.</p><h2 id="Completerbean">Completer bean</h2><p>A completer is a bean which implements the Completer interface:</p><pre>
package org.apache.karaf.shell.samples;

import org.apache.karaf.shell.console.completer.StringsCompleter;
import org.apache.karaf.shell.console.Completer;

/**
 * &lt;p>
 * A very simple completer.
 * &lt;/p>
 */
public class SimpleCompleter implements Completer {

 /**
  * @param buffer the beginning string typed by the user
  * @param cursor the position of the cursor
  * @param candidates the list of completions proposed to the user
  */
 public int complete(String buffer, int cursor, List candidates) {
    StringsCompleter delegate = new StringsCompleter();
    delegate.getStrings().add("one");
    delegate.getStrings().add("two");
    delegate.getStrings().add("three");
    return delegate.complete(buffer, cursor, candidates);
 }

}
</pre><h2 id="Blueprintconfigurationfile">Blueprint configuration file</h2><p>Using Blueprint, you can "inject" the completer linked to your command. The same completer could be used for several commands and a command can have several completers:</p><pre>
&lt;blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0">

    &lt;command-bundle xmlns="http://karaf.apache.org/xmlns/shell/v1.0.0">
        &lt;command name="test/hello">
            &lt;action class="org.apache.karaf.shell.samples.HelloShellCommand"/>
            &lt;completers>
                &lt;ref component-id="simpleCompleter"/>
                &lt;null/>
            &lt;/completers>
        &lt;/command>
    &lt;/command-bundle>

    &lt;bean id="simpleCompleter" class="org.apache.karaf.shell.samples.SimpleCompleter"/>

&lt;/blueprint>
</pre><h2 id="TestinKaraf2">Test in Karaf</h2><p>Launch a Karaf instance and run the following command to install the newly created bundle:</p><pre>
karaf@root> osgi:install -s mvn:org.apache.karaf.shell.samples/shell-sample-commands/1.0-SNAPSHOT
</pre><p>Let's try running the command:</p><pre>
karaf@root> test:hello &lt;tab>
 one    two    three
</pre><h1 id="Customdistributions">Custom distributions</h1><p>As Karaf is an OSGi container, it's heavily used as an application and middleware kernel.</p><p>You may wish to construct your own Karaf distribution preconfigured to your requirements.<br/>This custom distribution could contain:</p><ul style="list-style: square"><li>branding to change the Karaf console look-and-feel</li><li>configuration files (in the etc folder) altered to your requirements</li><li>pre-packaged artifacts in the deploy folder</li><li>a pre-populated system repository (containing your own bundle and features descriptor)</li><li>renamed or specific scripts in the bin folder</li><li>system documentation files</li></ul><h2 id="Mavenassembly">Maven assembly</h2><p>Basically a Karaf custom distribution involves:<br/>1. Uncompressing a standard Karaf distribution in a given directory.<br/>2. Populating the system repo with your features.<br/>3. Populating the lib directory with your branding or other system bundle jar files.<br/>4. Overriding the configuration files in the etc folder.</p><p>These tasks could be performed using scripting, or more easily and portable, using Apache Maven and a set of Maven plugins.</p><p>For instance, the Maven POM could look like:</p><pre>
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM http://maven.apache.org/xsd/maven-4.0.0.xsd">

  &lt;groupId>my.company&lt;/groupId>
  &lt;artifactId>mycustom-karaf&lt;/artifactId>
  &lt;version>1.0&lt;/version>
  &lt;packaging>pom&lt;/packaging>
  &lt;name>My Unix Custom Karaf Distribution&lt;/name>

  &lt;properties>
    &lt;karaf.version>2.2.2&lt;/karaf.version>
  &lt;/properties>

  &lt;dependencies>
    &lt;dependency>
      &lt;groupId>org.apache.karaf&lt;/groupId>
      &lt;artifactId>apache-karaf&lt;/artifactId>
      &lt;version>2.3.0&lt;/version>
      &lt;type>tar.gz&lt;/type>
    &lt;/dependency>
    &lt;dependency>
      &lt;groupId>org.apache.karaf.assemblies.features&lt;/groupId>
      &lt;artifactId>standard&lt;/artifactId>
      &lt;version>2.3.0&lt;/version>
      &lt;type>xml&lt;/type>
      &lt;classifier>features&lt;/classifier>
    &lt;/dependency>
  &lt;/dependencies>

  &lt;build>
    &lt;resources>
      &lt;resource>
        &lt;directory>/x1/asf/karaf-2.3.x/target/checkout/manual/src/main/filtered-resources&lt;/directory>
        &lt;filtering>true&lt;/filtering>
        &lt;includes>
          &lt;include>**/*&lt;/include>
        &lt;/includes>
      &lt;/resource>
    &lt;/resources>
    &lt;plugins>
      &lt;plugin>
        &lt;groupId>org.apache.maven.plugins&lt;/groupId>
        &lt;artifactId>maven-resources-plugin&lt;/artifactId>
        &lt;executions>
          &lt;execution>
            &lt;id>filter&lt;/id>
            &lt;phase>generate-resources&lt;/phase>
            &lt;goals>
              &lt;goal>resources&lt;/goal>
            &lt;/goals>
          &lt;/execution>
        &lt;/executions>
      &lt;/plugin>
      &lt;plugin>
        &lt;groupId>org.apache.karaf.tooling&lt;/groupId>
        &lt;artifactId>features-maven-plugin&lt;/artifactId>
        &lt;version>2.3.0&lt;/version>
        &lt;executions>
          &lt;execution>
           &lt;id>add-features-to-repo&lt;/id>
           &lt;phase>generate-resources&lt;/phase>
           &lt;goals>
             &lt;goal>add-features-to-repo&lt;/goal>
           &lt;/goals>
           &lt;configuration>
              &lt;descriptors>
                &lt;descriptor>mvn:org.apache.karaf.assemblies.features/standard/2.3.0/xml/features&lt;/descriptor>
                &lt;descriptor>file:/x1/asf/karaf-2.3.x/target/checkout/manual/target/classes/my-features.xml&lt;/descriptor>
              &lt;/descriptors>
              &lt;features>
                &lt;feature>my-feature&lt;/feature>
              &lt;/features>
           &lt;/configuration>
          &lt;/execution>
        &lt;/executions>
      &lt;/plugin>
      &lt;plugin>
        &lt;groupId>org.apache.maven.plugins&lt;/groupId>
        &lt;artifactId>maven-dependency-plugin&lt;/artifactId>
        &lt;executions>
          &lt;execution>
            &lt;id>copy&lt;/id>
            &lt;phase>generate-resources&lt;/phase>
            &lt;goals>
              &lt;goal>copy&lt;/goal>
            &lt;/goals>
            &lt;configuration>
               &lt;!-- Define here the artifacts which should be considered in the assembly -->
               &lt;!-- For instance, the branding jar -->
               &lt;artifactItems>
                 &lt;artifactItem>
                    &lt;groupId>my.groupId&lt;/groupId>
                    &lt;artifactId>my.branding.id&lt;/artifactId>
                    &lt;version>1.0&lt;/version>
                    &lt;outputDirectory>target/dependencies&lt;/outputDirectory>
                    &lt;destFileName>mybranding.jar&lt;/destFileName>
                 &lt;/artifactItem>
               &lt;/artifactItems>
            &lt;/configuration>
          &lt;/execution>
          &lt;execution>
            &lt;!-- Uncompress the standard Karaf distribution -->
            &lt;id>unpack&lt;/id>
            &lt;phase>generate-resources&lt;/phase>
            &lt;goals>
              &lt;goal>unpack&lt;/goal>
            &lt;/goals>
            &lt;configuration>
              &lt;artifactItems>
                &lt;artifactItem>
                  &lt;groupId>org.apache.karaf&lt;/groupId>
                  &lt;artifactId>apache-karaf&lt;/artifactId>
                  &lt;type>tar.gz&lt;/type>
                  &lt;outputDirectory>target/dependencies&lt;/outputDirectory>
                &lt;/artifactItem>
              &lt;/artifactItems>
            &lt;/configuration>
          &lt;/execution>
        &lt;/executions>
      &lt;/plugin>
      &lt;plugin>
        &lt;groupId>org.apache.maven.plugins&lt;/groupId>
        &lt;artifactId>maven-assembly-plugin&lt;/artifactId>
        &lt;executions>
          &lt;execution>
            &lt;id>bin&lt;/id>
            &lt;phase>package&lt;/phase>
            &lt;goals>
              &lt;goal>single&lt;/goal>
            &lt;/goals>
            &lt;configuration>
              &lt;descriptors>
                &lt;descriptor>src/main/descriptors/bin.xml&lt;/descriptor>
              &lt;/descriptors>
              &lt;appendAssemblyId>false&lt;/appendAssemblyId>
              &lt;tarLongFileMode>gnu&lt;/tarLongFileMode>
            &lt;/configuration>
          &lt;/execution>
        &lt;/executions>
      &lt;/plugin>
    &lt;/plugins>
  &lt;/build>

&lt;/project>
</pre><p>The Maven POM will download the Karaf standard distribution and prepare resources to be processed by the Maven assembly plugin.</p><p>Your Maven project structure should look like:</p><ul><li>pom.xml: the previous POM file</li><li>src/main/descriptors/bin.xml: the assembly maven plugin descriptor (see below)</li><li>src/main/filtered-resources: contains all resource files that have Maven property values to be filtered/replaced. Typically, this will include features descriptor and configuration files.</li><li>src/main/distribution: contains all raw files which will be copied as-is into your custom distribution.</li></ul><p>For instance, <tt>src/main/filtered-resources</tt> could contain:</p><ul><li><tt>my-features.xml</tt> where maven properties will be replaced</li><li><tt>etc/org.apache.karaf.features.cfg</tt> file containing your my-features descriptor:<pre>
#
# Comma separated list of features repositories to register by default
#
featuresRepositories=mvn:org.apache.karaf/apache-karaf/2.3.0/xml/features,mvn:my.groupId/my-features/2.3.0/xml/features

#
# Comma separated list of features to install at startup
#
featuresBoot=config,ssh,management,my-feature
</pre></li></ul><p>The <tt>src/main/distribution</tt> contains all your custom Karaf configuration files and scripts, as, for examples:</p><ul><li>etc/org.ops4j.pax.logging.cfg<pre>
# Root logger
log4j.rootLogger=INFO, out, osgi:VmLogAppender
log4j.throwableRenderer=org.apache.log4j.OsgiThrowableRenderer

# CONSOLE appender not used by default
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d{ABSOLUTE} | %-5.5p | %-16.16t | %-32.32C %4L | %X{bundle.id} - %X{bundle.name} - %X{bundle.version} | %m%n

# File appender
log4j.appender.out=org.apache.log4j.RollingFileAppender
log4j.appender.out.layout=org.apache.log4j.PatternLayout
log4j.appender.out.layout.ConversionPattern=%d{ABSOLUTE} | %-5.5p | %-16.16t | %-32.32C %4L | %X{bundle.id} - %X{bundle.name} - %X{bundle.version} | %m%n
log4j.appender.out.file=${karaf.home}/log/my-customer-distribution.log
log4j.appender.out.append=true
log4j.appender.out.maxFileSize=1MB
log4j.appender.out.maxBackupIndex=10

# Sift appender
log4j.appender.sift=org.apache.log4j.sift.MDCSiftingAppender
log4j.appender.sift.key=bundle.name
log4j.appender.sift.default=my-custom
log4j.appender.sift.appender=org.apache.log4j.FileAppender
log4j.appender.sift.appender.layout=org.apache.log4j.PatternLayout
log4j.appender.sift.appender.layout.ConversionPattern=%d{ABSOLUTE} | %-5.5p | %-16.16t | %-32.32c{1} | %-32.32C %4L | %m%n
log4j.appender.sift.appender.file=${karaf.data}/log/$\\{bundle.name\\}.log
log4j.appender.sift.appender.append=true
</pre></li><li>etc/system.properties<pre>
#
# The properties defined in this file will be made available through system
# properties at the very beginning of the FAS boot process.
#

# Log level when the pax-logging service is not available
# This level will only be used while the pax-logging service bundle
# is not fully available.
# To change log levels, please refer to the org.ops4j.pax.logging.cfg file
# instead.
org.ops4j.pax.logging.DefaultServiceLog.level=ERROR

#
# Name of this custom instance.
#
karaf.name=my-custom

#
# Default repository where bundles will be loaded from before using
# other maven repositories. For the full Maven configuration, see the
# org.ops4j.pax.url.mvn.cfg file.
#
karaf.default.repository=system

#
# Location of a shell script that will be run when starting a shell
# session. This script can be used to create aliases and define
# additional commands.
#
karaf.shell.init.script=${karaf.home}/etc/shell.init.script

#
# Set this empty property to avoid errors when validating xml documents.
#
xml.catalog.files=

#
# Suppress the bell in the console when hitting backspace to many times
# for example
#
jline.nobell=true

#
# Default port for the OSGi HTTP Service
#
org.osgi.service.http.port=8181

#
# Allow usage of ${custom.home} as an alias for ${karaf.home}
#
custom.home=${karaf.home}
</pre></li><li>etc/users.properties<pre>
admin=admin,admin
</pre></li><li>You can add a <tt>etc/custom.properties</tt>, it's a placeholder for any override you may need. For instance:<pre>
karaf.systemBundlesStartLevel=50
obr.repository.url=http://svn.apache.org/repos/asf/servicemix/smx4/obr-repo/repository.xml
org.osgi.framework.system.packages.extra = \
  org.apache.karaf.branding; \
  com.sun.org.apache.xalan.internal.xsltc.trax; \
  com.sun.org.apache.xerces.internal.dom; \
  com.sun.org.apache.xerces.internal.jaxp; \
  com.sun.org.apache.xerces.internal.xni; \
  com.sun.jndi.ldap
</pre></li></ul><p>Now, we can "assemble" our custom distribution using the Maven assembly plugin. The Maven assembly plugin uses an assembly descriptor, configured in POM above to be <tt>src/main/descriptors/bin.xml</tt>:</p><pre>
&lt;assembly>

    &lt;id>bin&lt;/id>

    &lt;formats>
        &lt;format>tar.gz&lt;/format>
    &lt;/formats>

    &lt;fileSets>

        &lt;!-- Expanded Karaf Standard Distribution -->
        &lt;fileSet>
            &lt;directory>target/dependencies/apache-karaf-2.3.0&lt;/directory>
            &lt;outputDirectory>/&lt;/outputDirectory>
            &lt;excludes>
                &lt;exclude>**/demos/**&lt;/exclude>
                &lt;exclude>bin/**&lt;/exclude>
                &lt;exclude>etc/system.properties&lt;/exclude>
                &lt;exclude>etc/users.properties&lt;/exclude>
                &lt;exclude>etc/org.apache.karaf.features.cfg&lt;/exclude>
                &lt;exclude>etc/org.ops4j.pax.logging.cfg&lt;/exclude>
                &lt;exclude>LICENSE&lt;/exclude>
                &lt;exclude>NOTICE&lt;/exclude>
                &lt;exclude>README&lt;/exclude>
                &lt;exclude>RELEASE-NOTES&lt;/exclude>
                &lt;exclude>karaf-manual*.html&lt;/exclude>
                &lt;exclude>karaf-manual*.pdf&lt;/exclude>
            &lt;/excludes>
        &lt;/fileSet>

        &lt;!-- Copy over bin/* separately to get the correct file mode -->
        &lt;fileSet>
            &lt;directory>target/dependencies/apache-karaf-2.3.0&lt;/directory>
            &lt;outputDirectory>/&lt;/outputDirectory>
            &lt;includes>
                &lt;include>bin/admin&lt;/include>
                &lt;include>bin/karaf&lt;/include>
                &lt;include>bin/start&lt;/include>
                &lt;include>bin/stop&lt;/include>
            &lt;/includes>
            &lt;fileMode>0755&lt;/fileMode>
        &lt;/fileSet>

        &lt;!-- Copy over jar files -->
        &lt;fileSet>
            &lt;directory>target/dependencies&lt;/directory>
            &lt;includes>
                &lt;include>my-custom.jar&lt;/include>
            &lt;/includes>
            &lt;outputDirectory>/lib/&lt;/outputDirectory>
        &lt;/fileSet>

        &lt;fileSet>
            &lt;directory>src/main/distribution&lt;/directory>
            &lt;outputDirectory>/&lt;/outputDirectory>
            &lt;fileMode>0644&lt;/fileMode>
        &lt;/fileSet>
        &lt;fileSet>
            &lt;directory>target/classes/etc&lt;/directory>
            &lt;outputDirectory>/etc/&lt;/outputDirectory>
            &lt;lineEnding>unix&lt;/lineEnding>
            &lt;fileMode>0644&lt;/fileMode>
        &lt;/fileSet>

        &lt;fileSet>
            &lt;directory>target/features-repo&lt;/directory>
            &lt;outputDirectory>/system&lt;/outputDirectory>
        &lt;/fileSet>

    &lt;/fileSets>

    &lt;files>
        &lt;file>
            &lt;source>/x1/asf/karaf-2.3.x/target/checkout/manual/target/dependencies/apache-karaf-2.3.0/bin/karaf&lt;/source>
            &lt;outputDirectory>/bin/&lt;/outputDirectory>
            &lt;destName>my-custom&lt;/destName>
            &lt;fileMode>0755&lt;/fileMode>
            &lt;lineEnding>unix&lt;/lineEnding>
        &lt;/file>
        &lt;file>
            &lt;source>/x1/asf/karaf-2.3.x/target/checkout/manual/target/classes/features.xml&lt;/source>
            &lt;outputDirectory>/system/my.groupid/my-features/2.3.0&lt;/outputDirectory>
            &lt;destName>my-features-2.3.0-features.xml&lt;/destName>
            &lt;fileMode>0644&lt;/fileMode>
            &lt;lineEnding>unix&lt;/lineEnding>
        &lt;/file>
    &lt;/files>

&lt;/assembly>
</pre><p>To build your custom Karaf distribution, just run:</p><pre>
mvn install
</pre><p>You will find your Karaf custom distribution tar.gz in the target directory.</p><h2 id="Roadmap">Roadmap</h2><p>A distribution goal is in preparation in the next Karaf</p><h2 id="Customdistributionexamples">Custom distribution examples</h2><ul><li><a href="http://svn.apache.org/repos/asf/servicemix/smx4/features/trunk/assembly/">Apache ServiceMix 4</a></li><li><a href="http://svn.apache.org/repos/asf/servicemix/smx4/nmr/trunk/assembly/">Apache ServiceMix NMR</a></li><li><a href="http://buildprocess.svn.sourceforge.net/viewvc/buildprocess/builderaser/trunk/assembly/">BuildProcess BuildEraser</a></li></ul><h1 id="Securityframework">Security framework</h1><p>Karaf supports <a href="http://download.oracle.com/javase/6/docs/technotes/guides/security/jaas/JAASRefGuide.html">JAAS</a> with some enhancements to allow JAAS to work nicely in an OSGi environment.  This framework also features an OSGi keystore manager with the ability to deploy new keystores or truststores at runtime.  </p><h2 id="Overview">Overview</h2><p>This feature allows runtime deployment of JAAS based configuration for use in various parts of the application. This includes the remote console login, which uses the <tt>karaf</tt> realm, but which is configured with a dummy login module by default.  These realms can also be used by the NMR, JBI components or the JMX server to authenticate users logging in or sending messages into the bus.</p><p>In addition to JAAS realms, you can also deploy keystores and truststores to secure the remote shell console, setting up HTTPS connectors or using certificates for WS-Security.</p><p>A very simple XML schema for spring has been defined, allowing the deployment of a new realm or a new keystore very easily.</p><h2 id="Schema">Schema</h2><p>To override or deploy a new realm, you can use the following XSD which is supported by a Spring namespace handler and can thus be defined in a Spring xml configuration file.</p><p>Following is the XML Schema to use when defining Karaf realms:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code></code></pre></div><p>You can find the schema at the following <a href="http://karaf.apache.org/xmlns/jaas/v1.1.0">location</a>.</p><p>Here are two examples using this schema:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;
           xmlns:jaas=&quot;http://karaf.apache.org/xmlns/jaas/v1.0.0&quot;
           xmlns:ext=&quot;http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0&quot;&gt;

    &lt;!-- Bean to allow the $[karaf.base] property to be correctly resolved --&gt;
    &lt;ext:property-placeholder placeholder-prefix=&quot;$[&quot; placeholder-suffix=&quot;]&quot;/&gt;

    &lt;jaas:config name=&quot;myrealm&quot;&gt;
        &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.properties.PropertiesLoginModule&quot; 
                     flags=&quot;required&quot;&gt;
            users = $[karaf.base]/etc/users.properties
        &lt;/jaas:module&gt;
    &lt;/jaas:config&gt;

    &lt;service interface=&quot;org.apache.karaf.jaas.modules.BackingEngineFactory&quot;&gt;
        &lt;bean class=&quot;org.apache.karaf.jaas.modules.properties.PropertiesBackingEngineFactory&quot;/&gt;
    &lt;/service&gt;

&lt;/blueprint&gt;</code></pre></div><p>NB: Don't forge to expose the BackingEngine as an OSGi service.</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:keystore xmlns:jaas=&quot;http://karaf.apache.org/xmlns/jaas/v1.1.0&quot;
               name=&quot;ks&quot;
               rank=&quot;1&quot;
               path=&quot;classpath:privatestore.jks&quot;
               keystorePassword=&quot;keyStorePassword&quot;
               keyPasswords=&quot;myalias=myAliasPassword&quot;&gt;
&lt;/jaas:keystore&gt;</code></pre></div><p>The <tt>id</tt> attribute is the blueprint id of the bean, but it will be used by default as the name of the realm if no <tt>name</tt> attribute is specified.   Additional attributes on the <tt>config</tt> elements are a <tt>rank</tt>, which is an integer.  When the LoginContext looks for a realm for authenticating a given user, the realms registered in the OSGi registry are matched against the required name.  If more than one realm is found, the one with the highest rank will be used, thus allowing the override of some realms with new values.  The last attribute is <tt>publish</tt> which can be set to false to not publish the realm in the OSGi registry, thereby disabling the use of this realm.</p><p>Each realm can contain one or more module definitions.  Each module identifies a LoginModule and the <tt>className</tt> attribute must be set to the class name of the login module to use.   Note that this login module must be available from the bundle classloader, so either it has to be defined in the bundle itself, or the needed package needs to be correctly imported. The <tt>flags</tt> attribute can take one of four values that are explained on the <a href="http://svn.apache.org/repos/asf/karaf/tags/karaf-2.0.0/jaas/boot/src/main/java/org/apache/karaf/jaas/boot/ProxyLoginModule.java">JAAS documentation</a>.<br/>The content of the <tt>module</tt> element is parsed as a properties file and will be used to further configure the login module.</p><p>Deploying such a code will lead to a <a href="http://svn.apache.org/repos/asf/karaf/tags/karaf-2.0.0/jaas/config/src/main/java/org/apache/karaf/jaas/config/JaasRealm.java">JaasRealm</a> object in the OSGi registry, which will then be used when using the JAAS login module.</p><h3 id="Configurationoverrideanduseoftherankattribute">Configuration override and use of the <tt>rank</tt> attribute</h3><p>The <tt>rank</tt> attribute on the <tt>config</tt> element is tied to the ranking of the underlying OSGi service.  When the JAAS framework performs an authentication, it will use the realm name to find a matching JAAS configuration.  If multiple configurations are used, the one with the highest <tt>rank</tt> attribute will be used.<br/>So if you want to override the default security configuration in Karaf (which is used by the ssh shell, web console and JMX layer), you need to deploy a JAAS configuration with the name <tt>name="karaf"</tt> and <tt>rank="1"</tt>.</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;
           xmlns:jaas=&quot;http://karaf.apache.org/xmlns/jaas/v1.1.0&quot;
           xmlns:ext=&quot;http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0&quot;&gt;

    &lt;!-- Bean to allow the $[karaf.base] property to be correctly resolved --&gt;
    &lt;ext:property-placeholder placeholder-prefix=&quot;$[&quot; placeholder-suffix=&quot;]&quot;/&gt;

    &lt;jaas:config name=&quot;karaf&quot; rank=&quot;1&quot;&gt;
        &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.properties.PropertiesLoginModule&quot;
                     flags=&quot;required&quot;&gt;
            users = $[karaf.base]/etc/users.properties
            ...
        &lt;/jaas:module&gt;
    &lt;/jaas:config&gt;

&lt;/blueprint&gt;</code></pre></div><h2 id="Architecture">Architecture</h2><p>Due to constraints in the JAAS specification, one class has to be available for all bundles.  This class is called <a href="http://svn.apache.org/repos/asf/karaf/tags/karaf-2.0.0/jaas/boot/src/main/java/org/apache/karaf/jaas/boot/ProxyLoginModule.java">ProxyLoginModule</a> and is a LoginModule that acts as a proxy for an OSGi defines LoginModule.  If you plan to integrate this feature into another OSGi runtime, this class must be made available from the system classloader and the related package be part of the boot delegation classpath (or be deployed as a fragment attached to the system bundle).</p><p>The xml schema defined above allows the use of a simple xml (leveraging spring xml extensibility) to configure and register a JAAS configuration for a given realm.  This configuration will be made available into the OSGi registry as a <a href="http://svn.apache.org/repos/asf/karaf/tags/karaf-2.0.0/jaas/config/src/main/java/org/apache/karaf/jaas/config/JaasRealm.java">JaasRealm</a> and the OSGi specific Configuration will look for such services.  Then the proxy login module will be able to use the information provided by the realm to actually load the class from the bundle containing the real login module.</p><h2 id="Availablerealms">Available realms</h2><p>Karaf comes with several login modules to handle authentication needs for your environment.</p><h3 id="PropertiesLoginModule">PropertiesLoginModule</h3><div class="table-wrap"><table class="confluenceTable"><tr><td class="confluenceTd"> LoginModule           </td><td class="confluenceTd"> org.apache.karaf.jaas.modules.properties.PropertiesLoginModule            </td></tr><tr><td class="confluenceTd"> BackingEngineFactory  </td><td class="confluenceTd"> org.apache.karaf.jaas.modules.properties.PropertiesBackingEngineFactory   </td></tr></table></div><p>This login module is the one configured by default.  It uses a properties text file to load the users, passwords and roles.  </p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name             </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>users</tt>          </td><td class="confluenceTd"> location of the properties file </td></tr></table></div><p>This file uses the <a href="http://download.oracle.com/javase/6/docs/api/java/util/Properties.html#load(java.io.Reader)">properties file format</a>.<br/>The format of the properties is as follows, with each line defining a user, its password and associated roles:</p><pre>
user=password[,role][,role]...
</pre><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.properties.PropertiesLoginModule&quot; 
                 flags=&quot;required&quot;&gt;
        users = $[karaf.base]/etc/users.properties
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><h3 id="OsgiConfigLoginModule">OsgiConfigLoginModule</h3><div class="table-wrap"><table class="confluenceTable"><tr><td class="confluenceTd"> LoginModule           </td><td class="confluenceTd"> org.apache.karaf.jaas.modules.osgi.OsgiConfigLoginModule            </td></tr><tr><td class="confluenceTd"> BackingEngineFactory  </td><td class="confluenceTd">                                                                     </td></tr></table></div><p>The OsgiConfigLoginModule uses the OSGi ConfigurationAdmin service to provide the users, passwords and roles.</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name           </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>pid</tt>          </td><td class="confluenceTd"> the PID of the configuration containing user definitions </td></tr></table></div><p>The format of the configuration is the same than for the <tt>PropertiesLoginModule</tt>.</p><h3 id="JDBCLoginModule">JDBCLoginModule</h3><div class="table-wrap"><table class="confluenceTable"><tr><td class="confluenceTd"> LoginModule           </td><td class="confluenceTd"> org.apache.karaf.jaas.modules.jdbc.JDBCLoginModule            </td></tr><tr><td class="confluenceTd"> BackingEngineFactory  </td><td class="confluenceTd"> org.apache.karaf.jaas.modules.jdbc.JDBCBackingEngineFactory   </td></tr></table></div><p>The JDBCLoginModule uses a database to load the users, passwords and roles from a provided data source <em>(normal or XA)</em>. The data source and the queries for password and role retrieval are configurable using the following parameters.</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name                   </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>datasource</tt>           </td><td class="confluenceTd"> The datasource as on OSGi ldap filter or as JDNI name</td></tr><tr><td class="confluenceTd"> <tt>query.password</tt>       </td><td class="confluenceTd"> The SQL query that retries the password of the user </td></tr><tr><td class="confluenceTd"> <tt>query.role</tt>           </td><td class="confluenceTd"> The SQL query that retries the roles of the user </td></tr></table></div><p><u>Passing a data source as an OSGi ldap filter</u></p><p>To use an OSGi ldap filter, the prefix osgi: needs to be provided, as shown below:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.jdbc.JDBCLoginModule&quot; 
                 flags=&quot;required&quot;&gt;
        datasource = osgi:javax.sql.DataSource/(osgi.jndi.service.name=jdbc/karafdb)
        query.password = SELECT PASSWORD FROM USERS WHERE USERNAME=?
        query.role = SELECT ROLE FROM ROLES WHERE USERNAME=?
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><p><u>Passing a data source as a JNDI name</u></p><p>To use an JNDI name, the prefix jndi: needs to be provided. The example below assumes the use of Aries JNDI to expose services via JNDI.</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.jdbc.JDBCLoginModule&quot; 
                 flags=&quot;required&quot;&gt;
        datasource = jndi:aries:services/javax.sql.DataSource/(osgi.jndi.service.name=jdbc/karafdb)
        query.password = SELECT PASSWORD FROM USERS WHERE USERNAME=?
        query.role = SELECT ROLE FROM ROLES WHERE USERNAME=?
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><h3 id="LDAPLoginModule">LDAPLoginModule</h3><div class="table-wrap"><table class="confluenceTable"><tr><td class="confluenceTd"> LoginModule           </td><td class="confluenceTd"> org.apache.karaf.jaas.modules.ldap.LDAPLoginModule            </td></tr><tr><td class="confluenceTd"> BackingEngineFactory  </td><td class="confluenceTd">                                                               </td></tr></table></div><p>The LDAPLoginModule uses LDAP to load the users and roles and bind the users on the LDAP to check passwords.</p><p>The LDAPLoginModule supports the following parameters:</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name                      </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>connection.url</tt>          </td><td class="confluenceTd"> The LDAP connection URL, e.g. ldap://hostname </td></tr><tr><td class="confluenceTd"> <tt>connection.username</tt>     </td><td class="confluenceTd"> Admin username to connect to the LDAP. This parameter is optional, if it's not provided, the LDAP connection will be anonymous. </td></tr><tr><td class="confluenceTd"> <tt>connection.password</tt>     </td><td class="confluenceTd"> Admin password to connect to the LDAP. Only used if the <tt>connection.username</tt> is specified. </td></tr><tr><td class="confluenceTd"> <tt>user.base.dn</tt>            </td><td class="confluenceTd"> The LDAP base DN used to looking for user, e.g. ou=user,dc=apache,dc=org </td></tr><tr><td class="confluenceTd"> <tt>user.filter</tt>             </td><td class="confluenceTd"> The LDAP filter used to looking for user, e.g. (uid=%u) where %u will be replaced by the username. </td></tr><tr><td class="confluenceTd"> <tt>user.search.subtree</tt>     </td><td class="confluenceTd"> If "true", the user lookup will be recursive (SUBTREE). If "false", the user lookup will be performed only at the first level (ONELEVEL). </td></tr><tr><td class="confluenceTd"> <tt>role.base.dn</tt>            </td><td class="confluenceTd"> The LDAP base DN used to looking for roles, e.g. ou=role,dc=apache,dc=org </td></tr><tr><td class="confluenceTd"> <tt>role.filter</tt>             </td><td class="confluenceTd"> The LDAP filter used to looking for user's role, e.g. (member:=uid=%u) </td></tr><tr><td class="confluenceTd"> <tt>role.name.attribute</tt>     </td><td class="confluenceTd"> The LDAP role attribute containing the role string used by Karaf, e.g. cn </td></tr><tr><td class="confluenceTd"> <tt>role.search.subtree</tt>     </td><td class="confluenceTd"> If "true", the role lookup will be recursive (SUBTREE). If "false", the role lookup will be performed only at the first level (ONELEVEL). </td></tr><tr><td class="confluenceTd"> <tt>authentication</tt>          </td><td class="confluenceTd"> Define the authentication backend used on the LDAP server. The default is simple. </td></tr><tr><td class="confluenceTd"> <tt>initial.context.factory</tt> </td><td class="confluenceTd"> Define the initial context factory used to connect to the LDAP server. The default is com.sun.jndi.ldap.LdapCtxFactory </td></tr><tr><td class="confluenceTd"> <tt>ssl</tt>                     </td><td class="confluenceTd"> If "true" or if the protocol on the <tt>connection.url</tt> is <tt>ldaps</tt>, an SSL connection will be used </td></tr><tr><td class="confluenceTd"> <tt>ssl.provider</tt>            </td><td class="confluenceTd"> The provider name to use for SSL </td></tr><tr><td class="confluenceTd"> <tt>ssl.protocol</tt>            </td><td class="confluenceTd"> The protocol name to use for SSL (SSL for example)</td></tr><tr><td class="confluenceTd"> <tt>ssl.algorithm</tt>           </td><td class="confluenceTd"> The algorithm to use for the KeyManagerFactory and TrustManagerFactory  (PKIX for example) </td></tr><tr><td class="confluenceTd"> <tt>ssl.keystore</tt>            </td><td class="confluenceTd"> The key store name to use for SSL.  The key store must be deployed using a <tt>jaas:keystore</tt> configuration.  </td></tr><tr><td class="confluenceTd"> <tt>ssl.keyalias</tt>            </td><td class="confluenceTd"> The key alias to use for SSL </td></tr><tr><td class="confluenceTd"> <tt>ssl.truststore</tt>          </td><td class="confluenceTd"> The trust store name to use for SSL.  The trust store must be deployed using a <tt>jaas:keystore</tt> configuration.  </td></tr></table></div><p>A example of LDAPLoginModule usage follows:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
  &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.ldap.LDAPLoginModule&quot; flags=&quot;required&quot;&gt;
        connection.url = ldap://localhost:389
        user.base.dn = ou=user,dc=apache,dc=org
        user.filter = (cn=%u)
        user.search.subtree = true
        role.base.dn = ou=group,dc=apache,dc=org
        role.filter = (member:=uid=%u)
        role.name.attribute = cn
        role.search.subtree = true
        authentication = simple
  &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><p>If you wish to use an SSL connection, the following configuration can be used as an example:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;ext:property-placeholder /&gt;

&lt;jaas:config name=&quot;karaf&quot; rank=&quot;1&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.ldap.LDAPLoginModule&quot; flags=&quot;required&quot;&gt;
        connection.url = ldaps://localhost:10636
        user.base.dn = ou=users,ou=system
        user.filter = (uid=%u)
        user.search.subtree = true
        role.base.dn = ou=groups,ou=system
        role.filter = (uniqueMember=uid=%u)
        role.name.attribute = cn
        role.search.subtree = true
        authentication = simple
        ssl.protocol=SSL
        ssl.truststore=ks
        ssl.algorithm=PKIX
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;

&lt;jaas:keystore name=&quot;ks&quot;
               path=&quot;file:///${karaf.home}/etc/trusted.ks&quot;
               keystorePassword=&quot;secret&quot; /&gt;</code></pre></div><h2 id="Encryptionservice">Encryption service</h2><p>The <a href="http://svn.apache.org/repos/asf/karaf/trunk/jaas/modules/src/main/java/org/apache/karaf/jaas/modules/EncryptionService.java">EncryptionService</a> is a service registered in the OSGi registry providing means to encrypt and check encrypted passwords.  This service acts as a factory for <a href="http://svn.apache.org/repos/asf/karaf/trunk/jaas/modules/src/main/java/org/apache/karaf/jaas/modules/Encryption.java">Encryption</a> objects actually performing the encryption.</p><p>This service is used in all Karaf login modules to support encrypted passwords.</p><h3 id="Configuringproperties">Configuring properties</h3><p>Each login module supports the following additional set of properties:</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name                   </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>encryption.name</tt>      </td><td class="confluenceTd"> Name of the encryption service registered in OSGi (cf. paragraph <a href="#Jasypt.html">below</a>) </td></tr><tr><td class="confluenceTd"> <tt>encryption.enabled</tt>   </td><td class="confluenceTd"> Boolean used to turn on encryption </td></tr><tr><td class="confluenceTd"> <tt>encryption.prefix</tt>    </td><td class="confluenceTd"> Prefix for encrypted passwords </td></tr><tr><td class="confluenceTd"> <tt>encryption.suffix</tt>    </td><td class="confluenceTd"> Suffix for encrypted passwords </td></tr><tr><td class="confluenceTd"> <tt>encryption.algorithm</tt> </td><td class="confluenceTd"> Name of an algorithm to be used for hashing, like "MD5" or "SHA-1" </td></tr><tr><td class="confluenceTd"> <tt>encryption.encoding</tt>  </td><td class="confluenceTd"> Encrypted passwords encoding (can be <tt>hexadecimal</tt> or <tt>base64</tt>) </td></tr><tr><td class="confluenceTd"> <tt>role.policy</tt>          </td><td class="confluenceTd"> A policy for identifying roles (can be <tt>prefix</tt> or <tt>group</tt>) <a href="#Rolediscoverypolicies.html">below</a>) </td></tr><tr><td class="confluenceTd"> <tt>role.discriminator</tt>   </td><td class="confluenceTd"> A discriminator value to be used by the role policy </td></tr></table></div><p>A simple example follows:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.properties.PropertiesLoginModule&quot; 
                 flags=&quot;required&quot;&gt;
        users = $[karaf.base]/etc/users.properties
        encryption.enabled = true
        encryption.algorithm = MD5
        encryption.encoding = hexadecimal
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><h3 id="Prefixandsuffix">Prefix and suffix</h3><p>The login modules have the ability to support both encrypted and plain passwords at the same time.  In some cases, some login modules may be able to encrypt the passwords on the fly and save them back in an encrypted form.</p><h3 id="Jasypt">Jasypt</h3><p>Karaf default installation comes with a simple encryption service which usually fulfills simple needs.  However, in some cases, you may need to install the <a href="http://www.jasypt.org/">Jasypt</a> library which provides stronger encryption algorithms and more control over them.</p><p>To install the Jasypt library, the easiest way is to install the available feature:</p><pre>
karaf@root> features:install jasypt-encryption
</pre><p>It will download and install the required bundles and also register an <tt>EncryptionService</tt> for Jasypt in the OSGi registry.</p><p>When configuring a login module to use Jasypt, you need to specify the <tt>encryption.name</tt> property and set it to a value of <tt>jasypt</tt> to make sure the Jasypt encryption service will be used. </p><p>In addition to the standard properties above, the Jasypt service provides the following parameters:</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name                     </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>providerName</tt>           </td><td class="confluenceTd"> Name of the <tt>java.security.Provider</tt> name to use for obtaining the digest algorithm </td></tr><tr><td class="confluenceTd"> <tt>providerClassName</tt>      </td><td class="confluenceTd"> Class name for the security provider to be used for obtaining the digest algorithm </td></tr><tr><td class="confluenceTd"> <tt>iterations</tt>             </td><td class="confluenceTd"> Number of times the hash function will be applied recursively </td></tr><tr><td class="confluenceTd"> <tt>saltSizeBytes</tt>          </td><td class="confluenceTd"> Size of the salt to be used to compute the digest </td></tr><tr><td class="confluenceTd"> <tt>saltGeneratorClassName</tt> </td><td class="confluenceTd"> Class name of the salt generator </td></tr></table></div><p>A typical realm definition using Jasypt encryption service would look like:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.properties.PropertiesLoginModule&quot; 
                 flags=&quot;required&quot;&gt;
        users = $[karaf.base]/etc/users.properties
        encryption.enabled = true
        encryption.name = jasypt
        encryption.algorithm = SHA-256
        encryption.encoding = base64
        encryption.iterations = 100000
        encryption.saltSizeBytes = 16
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><h2 id="Rolediscoverypolicies">Role discovery policies</h2><p>The JAAS specification does not provide means to distinguish between User and Role Principals without referring to the specification classes. In order to provide means to the application developer to decouple the application from Karaf JAAS implementation role policies have been created.</p><p>A role policy is a convention that can be adopted by the application in order to identify Roles, without depending from the implementation. Each role policy can be cofigured by setting a "role.policy" and "role.discriminator" property to the login module configuration. Currently, Karaf provides two policies that can be applied to all Karaf Login Modules.</p><ol><li>Prefixed Roles</li><li>Grouped Roles</li></ol><p><u>Prefixed Roles</u><br/>When the prefixed role policy is used the login module applies a configurable prefix <em>(property role.discriminator)</em> to the role, so that the application can identify the role's principals by its prefix. Example:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.properties.PropertiesLoginModule&quot; 
                 flags=&quot;required&quot;&gt;
        users = $[karaf.base]/etc/users.properties
        role.policy = prefix
        role.discriminator = ROLE_
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><p>The application can identify the role principals using a snippet like this:</p><div class="syntax"><pre name='code' class='brush: java; gutter: false;'><code>
LoginContext ctx = new LoginContext(&quot;karaf&quot;, handler);
ctx.login();
authenticated = true;
subject = ctx.getSubject();
for (Principal p : subject.getPrincipals()) {
   	if (p.getName().startsWith(&quot;ROLE_&quot;)) {
   	   	roles.add((p.getName().substring(&quot;ROLE_&quot;.length())));
   	}
}</code></pre></div><p><u>Grouped Roles</u><br/>When the group role policy is used the login module provides all roles as members of a group with a configurable name <em>(property role.discriminator)</em>. Example:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;jaas:config name=&quot;karaf&quot;&gt;
    &lt;jaas:module className=&quot;org.apache.karaf.jaas.modules.properties.PropertiesLoginModule&quot; 
                 flags=&quot;required&quot;&gt;
        users = $[karaf.base]/etc/users.properties
        role.policy = group
        role.discriminator = ROLES
    &lt;/jaas:module&gt;
&lt;/jaas:config&gt;</code></pre></div><div class="syntax"><pre name='code' class='brush: java; gutter: false;'><code>
LoginContext ctx = new LoginContext(&quot;karaf&quot;, handler);
ctx.login();
authenticated = true;
subject = ctx.getSubject();
for (Principal p : subject.getPrincipals()) {
    if ((p instanceof Group) &amp;&amp; (&quot;ROLES&quot;.equalsIgnoreCase(p.getName()))) {
        Group g = (Group) p;
        Enumeration&lt;? extends Principal&gt; members = g.members();
        while (members.hasMoreElements()) {
            Principal member = members.nextElement();
            roles.add(member.getName());
        }
    }
}</code></pre></div><h2 id="Defaultrolepolicies">Default role policies</h2><p>The previous section describes how to leverage role policies. However, Karaf provides a default role policy, based on the following class names:</p><ul><li>org.apache.karaf.jaas.modules.UserPrincipal</li><li>org.apache.karaf.jaas.modules.RolePrincipal</li><li>org.apache.karaf.jaas.modules.GroupPrincipal</li></ul><p>It allows you to directly handling the role class:</p><div class="syntax"><pre name='code' class='brush: java; gutter: false;'><code>
String rolePrincipalClass = &quot;org.apache.karaf.jaas.modules.RolePrincipal&quot;;

for (Principal p : subject.getPrincipals()) {
	if (p.getClass().getName().equals(rolePrincipalClass)) {
		roles.add(p.getName());
	}
}</code></pre></div><h1 id="Usingthefeaturesmavenplugin">Using the features-maven-plugin</h1><p>The <tt>features-maven-plugin</tt> provides several goals to help you create and validate features XML descriptors as well as leverage your features to create a custom Karaf distribution.</p><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Goal </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt><a href="developers-guide/features-maven-plugin-add.html">features:add-features-to-repo</a></tt> </td><td class="confluenceTd"> Copies all the bundles required for a given set of features into a directory <br/> (e.g. for creating your own Karaf-based distribution) </td></tr><tr><td class="confluenceTd"> <tt>features:generate-features-file</tt> </td><td class="confluenceTd"> Deprecated - use <tt><a href="developers-guide/features-maven-plugin-generate.html">features:generate-features-xml</a></tt> instead </td></tr><tr><td class="confluenceTd"> <tt><a href="developers-guide/features-maven-plugin-generate.html">features:generate-features-xml</a></tt> </td><td class="confluenceTd"> Generates a features XML descriptor for a set of bundles </td></tr><tr><td class="confluenceTd"> <tt><a href="developers-guide/features-maven-plugin-validate.html">features:validate</a></tt> </td><td class="confluenceTd"> Validate a features XML descriptor by checking if all the required imports can be matched to exports </td></tr><tr><td class="confluenceTd"> {{</td><td class="confluenceTd">features:create-kar</td></tr></table></div><h2 id="Configurethefeaturesmavenplugin">Configure the features-maven-plugin</h2><p>In order to use the <tt>features-maven-plugin</tt>, you have to define the plugin in your project's <tt>pom.xml</tt> file:</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;project&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.karaf.tooling&lt;/groupId&gt;
        &lt;artifactId&gt;features-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.3.0&lt;/version&gt;

        &lt;executions&gt;
          &lt;!-- add execution definitions here --&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;  
&lt;/project&gt;</code></pre></div><h2 id="Goalfeaturesaddfeaturestorepo">Goal <tt>features:add-features-to-repo</tt></h2><p>The <tt>features:add-features-to-repo</tt> goal adds all the required bundles for a given set of features into directory.  You can use this goal to create a <tt>/system</tt> directory for building your own Karaf-based distribution.</p><p>By default, the Karaf core features descriptors (standard and enterprise) are automatically included in the descriptors set.</p><h3 id="Example">Example</h3><p>The example below copies the bundles for the <tt>spring</tt> and <tt>war</tt> features defined in the Karaf features XML descriptor into the <tt>target/features-repo</tt> directory.</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;project&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.karaf.tooling&lt;/groupId&gt;
        &lt;artifactId&gt;features-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.3.0&lt;/version&gt;

        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;add-features-to-repo&lt;/id&gt;
            &lt;phase&gt;generate-resources&lt;/phase&gt;
            &lt;goals&gt;
              &lt;goal&gt;add-features-to-repo&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
              &lt;descriptors&gt;
                &lt;descriptor&gt;mvn:my.groupid/my.artifactid/1.0.0/xml/features&lt;/descriptor&gt;
              &lt;/descriptors&gt;
              &lt;features&gt;
                &lt;feature&gt;spring&lt;/feature&gt;
                &lt;feature&gt;war&lt;/feature&gt;
                &lt;feature&gt;my&lt;/feature&gt;
                &lt;feature&gt;other/1.0-SNAPSHOT&lt;/feature&gt;
              &lt;/features&gt;
              &lt;repository&gt;target/features-repo&lt;/repository&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;  
&lt;/project&gt;</code></pre></div><h3 id="Parameters">Parameters</h3><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name </th><th class="confluenceTh"> Type </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>descriptors</tt> </td><td class="confluenceTd"> <tt>String[]</tt> </td><td class="confluenceTd"> List of features XML descriptors where the features are defined <br/> NB: Karaf core features descriptors (standard and enterprise) are automatically added in this list </td></tr><tr><td class="confluenceTd"> <tt>features</tt> </td><td class="confluenceTd"> <tt>String[]</tt> </td><td class="confluenceTd"> List of features that bundles should be copied to the repository directory. A feature could be just a feature name or a name/version. If it's just a name, the features-maven-plugin will take the first feature with the given name, whatever the version is. </td></tr><tr><td class="confluenceTd"> <tt>repository</tt> </td><td class="confluenceTd"> <tt>File</tt> </td><td class="confluenceTd"> The directory where the bundles will be copied by the plugin goal </td></tr><tr><td class="confluenceTd"> <tt>karafVersion</tt> </td><td class="confluenceTd"> <tt>String</tt> </td><td class="confluenceTd"> Target Karaf version to use to resolve the Karaf core features descriptors (standard and enterprise) </td></tr></table></div><h2 id="Goalfeaturesgenerate">Goal <tt>features:generate</tt></h2><p>The <tt>features:generate</tt> goal generates a features XML file for every bundle listed in the project's dependencies.  In order to satisfy the required imports in these bundles, the plugin will add bundles:</p><ul style="list-style: square"><li>bundles provided by Apache Karaf</li><li>a explicit list of bundles</li><li>bundles discovered in the POM's transitive dependencies</li></ul><p>Afterwards, the generated file will be attached to the build as an additional build artifact (by default as <tt>group:artifact:version:xml:features</tt>).</p><h3 id="Example">Example</h3><p>The example below generates one feature that installs bundle <tt>mvn:org.apache:bundle1:1.0</tt> in a features XML file called <tt>target/features.xml</tt>.  It will find bundle in Apache Karaf 2.3.0, the transitive dependencies for this POM and the bundles listed in <tt>src/main/resources/bundles.properties</tt>. </p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;project&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache&lt;/groupId&gt;
      &lt;artifactId&gt;bundle1&lt;/artifactId&gt;
      &lt;version&gt;1.0&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.karaf.tooling&lt;/groupId&gt;
        &lt;artifactId&gt;features-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.3.0&lt;/version&gt;
          &lt;executions&gt;
            &lt;execution&gt;
              &lt;id&gt;generate&lt;/id&gt;
              &lt;phase&gt;generate-resources&lt;/phase&gt;
              &lt;goals&gt;
                &lt;goal&gt;generate&lt;/goal&gt;
              &lt;/goals&gt;
              &lt;configuration&gt;
                &lt;bundles&gt;src/main/resources/bundles.properties&lt;/bundles&gt;
                &lt;kernelVersion&gt;2.3.0&lt;/kernelVersion&gt;
                &lt;outputFile&gt;target/features.xml&lt;/outputFile&gt;
              &lt;/configuration&gt;
            &lt;/execution&gt;
          &lt;/executions&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;  
&lt;/project&gt;</code></pre></div><h3 id="Parameters">Parameters</h3><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name </th><th class="confluenceTh"> Type </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>outputFile</tt> </td><td class="confluenceTd"> <tt>File</tt> </td><td class="confluenceTd"> Name of the features XML file that is being generated <br/> Default value: <tt>/x1/asf/karaf-2.3.x/target/checkout/manual/target/classes/feature.xml</tt> </td></tr><tr><td class="confluenceTd"> <tt>attachmentArtifactType</tt> </td><td class="confluenceTd"> <tt>String</tt> </td><td class="confluenceTd"> The artifact type for attaching the generated file to the project <br/> Default value: {{xml}) </td></tr><tr><td class="confluenceTd"> <tt>attachmentArtifactClassifier</tt> </td><td class="confluenceTd"> <tt>String</tt> </td><td class="confluenceTd"> The artifact classifier for attaching the generated file to the project <br/> Default value: <tt>features</tt> </td></tr><tr><td class="confluenceTd"> <tt>kernelVersion</tt> </td><td class="confluenceTd"> <tt>String</tt> </td><td class="confluenceTd"> The version of Karaf that is used to determine system bundles and default provided features </td></tr><tr><td class="confluenceTd"> <tt>bundles</tt> </td><td class="confluenceTd"> <tt>File</tt> </td><td class="confluenceTd"> A properties file that contains a list of bundles that will be used to generate the features.xml file </td></tr></table></div><h2 id="Goalfeaturesvalidate">Goal <tt>features:validate</tt></h2><p>The <tt>features:validate</tt> goal validates a features XML descriptor by checking if all the required imports for the bundles defined in the features can be matched to a provided export.</p><p>By default, the plugin tries to add the Karaf standard features (standard and enterprise) in the repositories set.<br/>It means that it's not necessary to explicitly define the Karaf features descriptor in the repository section of your features descriptor.</p><h3 id="Example">Example</h3><p>The example below validates the features defined in the <tt>target/features.xml</tt> by checking all the imports and exports.  It reads the definition for the packages that are exported by the system bundle from the <tt>src/main/resources/config.properties</tt> file.</p><div class="syntax"><pre name='code' class='brush: xml; gutter: false;'><code>
&lt;project&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.karaf.tooling&lt;/groupId&gt;
        &lt;artifactId&gt;features-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.3.0&lt;/version&gt;
          &lt;executions&gt;
            &lt;execution&gt;
              &lt;id&gt;validate&lt;/id&gt;
              &lt;phase&gt;process-resources&lt;/phase&gt;
              &lt;goals&gt;
                &lt;goal&gt;validate&lt;/goal&gt;
              &lt;/goals&gt;
              &lt;configuration&gt;
                &lt;file&gt;target/features.xml&lt;/file&gt;
                &lt;karafConfig&gt;src/main/resources/config.properties&lt;/karafConfig&gt;
              &lt;/configuration&gt;
            &lt;/execution&gt;
          &lt;/executions&gt;
          &lt;dependencies&gt;
            &lt;dependency&gt;
              &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
              &lt;artifactId&gt;slf4j-simple&lt;/artifactId&gt;
              &lt;version&gt;1.4.3&lt;/version&gt;
	        &lt;/dependency&gt;
          &lt;/dependencies&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;  
&lt;/project&gt;</code></pre></div><h3 id="Parameters">Parameters</h3><div class="table-wrap"><table class="confluenceTable"><tr><th class="confluenceTh"> Name </th><th class="confluenceTh"> Type </th><th class="confluenceTh"> Description </th></tr><tr><td class="confluenceTd"> <tt>file</tt> </td><td class="confluenceTd"> <tt>File</tt> </td><td class="confluenceTd"> The features XML descriptor file to validate. <br/> Default value: <tt>/x1/asf/karaf-2.3.x/target/checkout/manual/target/classes/features.xml</tt> </td></tr><tr><td class="confluenceTd"> <tt>karafConfig</tt> </td><td class="confluenceTd"> <tt>String</tt> </td><td class="confluenceTd"> The Karaf <tt>config.properties</tt> file to use during the validation process <br/> Default value: <tt>config.properties</tt> </td></tr><tr><td class="confluenceTd"> <tt>jreVersion</tt> </td><td class="confluenceTd"> <tt>String</tt> </td><td class="confluenceTd"> The JRE version that is used during the validation process <br/> Default value: {{jre-1.5}) </td></tr><tr><td class="confluenceTd"> <tt>karafVersion</tt> </td><td class="confluenceTd"> <tt>String</tt> </td><td class="confluenceTd"> The target Karaf version used to get the Karaf core features (standard and enterprise) <br/> Default value is the version of the plugin </td></tr><tr><td class="confluenceTd"> <tt>repositories</tt> </td><td class="confluenceTd"> <tt>String[]</tt> </td><td class="confluenceTd"> Additional features XML descriptors that will be used during the validation process </td></tr></table></div><h1 id="TroubleshootingDebuggingProfilingandMonitoring">Troubleshooting, Debugging, Profiling, and Monitoring</h1><h2 id="Troubleshooting">Troubleshooting</h2><h3 id="Logging">Logging</h3><p>Logging is easy to control through the console, with commands grouped under <em>log</em> shell. To learn about the available logging commands type:</p><pre>
karaf@root> log&lt;tab>

log:display              log:display-exception    log:get                  log:set
karaf@root>
</pre><p>Typical usage is:</p> <p> # Use <tt>log:set</tt> to dynamically change the global log level<br/> # Execute the problematic operation<br/> # Use <tt>log:display</tt> (or <tt>log:display-exception</tt> to display the log </p> <h3 id="WorstCaseScenario">Worst Case Scenario</h3><p>If you end up with a Karaf in a really bad state (i.e. you can not boot it anymore) or you just want to revert to a clean state quickly, you can safely remove the <tt>data</tt> directory in the installation directory.  This folder contains transient data and will be recreated if removed when you relaunch Karaf.<br/>You may also want to remove the files in the <tt>deploy</tt> folder to avoid them being automatically installed when Karaf is started the first time.</p><h2 id="Debugging">Debugging</h2><p>Usually, the easiest way to debug Karaf or any application deployed onto it is to use remote debugging.<br/>Remote debugging can be easily activated by using the <tt>debug</tt> parameter on the command line.</p><pre>> bin/karaf debug
{noformat
or on Windows
</pre><p>> bin\karaf.bat debug<br/>{noformat</p><p>Another option is to set the <tt>KARAF_DEBUG</tt> environment variable to <tt>TRUE</tt>.</p><p>This can be done using the following command on Unix systems:</p><pre>export KARAF_DEBUG=true
</pre><p>On Windows, use the following command</p><pre>set KARAF_DEBUG=true
</pre><p>Then, you can launch Karaf using the usual way:</p><pre>bin/karaf
</pre><p>or</p><pre>bin\karaf.bat
</pre><p>Last, inside your IDE, connect to the remote application (the default port to connect to is 5005).</p><p>This option works fine when it is needed to debug a project deployed top of Apache Karaf. Nevertheless, you will be blocked <br/>if you would like to debug the server Karaf. In this case, you can change the following parameter suspend=y in the <br/>karaf.bat script file. That will cause the JVM to pause just before running main() until you attach a debugger then it <br/>will resume the execution.  This way you can set your breakpoints anywhere in the code and you should be able to hit them<br/>no matter how early in the startup they are.  </p><pre>
export DEFAULT_JAVA_DEBUG_OPTS='-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005'
</pre><p>and on Windows,</p><pre>
set DEFAULT_JAVA_DEBUG_OPTS='-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005'
</pre><h2 id="Profiling">Profiling</h2><h3 id="YourKit">YourKit</h3><p>You need a few steps to be able to profile Karaf using YourKit.<br/>The first one is to edit the <tt>etc/config.properties</tt> configuration file and add the following property:</p><pre>org.osgi.framework.bootdelegation=com.yourkit.*
</pre><p>Then, set the <tt>JAVA_OPTS</tt> environment variable:</p><pre>export JAVA_OPTS='-Xmx512M -agentlib:yjpagent'
</pre><p>or, on Windows</p><pre>set JAVA_OPTS='-Xmx512M -agentlib:yjpagent'
</pre><p>Run Karaf from the console, and you should now be able to connect using YourKit standalone or from your favorite IDE.</p><h2 id="Monitoring">Monitoring</h2><p>Karaf uses JMX for monitoring and management of all Karaf components.</p><p>The JMX connection could be:</p><ul><li>local using the process id</li></ul><p><img border="1" src="images/jconsole_connect.jpg"/></p><ul><li>remote using the <tt>rmiRegistryPort</tt> property defined in <tt>etc/org.apache.karaf.management.cfg</tt> file.</li></ul><p>Using JMX, you can have a clean overview of the running Karaf instance:</p><ul><li>A overview with graphics displaying the load in terms of thread, heap/GC, etc:</li></ul><p><img border="1" src="images/jconsole_overview.jpg"/></p><ul><li>A thread overview:</li></ul><p><img border="1" src="images/jconsole_threads.jpg"/></p><ul><li>A memory heap consumption, including "Perform GC" button:</li></ul><p><img border="1" src="images/jconsole_memory.jpg"/></p><ul><li>A complete JVM summary, with all number of threads, etc:</li></ul><p><img border="1" src="images/jconsole_summary.jpg"/></p><p>You can manage Karaf features like you are in the shell. For example, you have access to the Admin service MBean, allowing you to create, rename, destroy, change SSH port, etc. Karaf instances:</p><p><img border="1" src="images/jconsole_admin.jpg"/></p><p>You can also manage Karaf features MBean to list, install, and uninstall Karaf features:</p><p><img border="1" src="images/jconsole_features.jpg"/></p><h1 id="Programmaticallyconnecttotheconsole">Programmatically connect to the console</h1><p>A connection to the Karaf console can also be done programmatically.<br/>The following code is a simplified version of the code from the client library.</p><div class="syntax"><pre name='code' class='brush: java; gutter: false;'><code>
import org.apache.sshd.ClientChannel;
import org.apache.sshd.ClientSession;
import org.apache.sshd.SshClient;
import org.apache.sshd.client.future.ConnectFuture;

public class Main {

    public static void main(String[] args) throws Exception {
        String host = &quot;localhost&quot;;
        int port = 8101;
        String user = &quot;karaf&quot;;
        String password = &quot;karaf&quot;;

        SshClient client = null;
        try {
            client = SshClient.setUpDefaultClient();
            client.start();
            ConnectFuture future = client.connect(host, port);
            future.await();
            ClientSession session = future.getSession();
            session.authPassword(user, password);
            ClientChannel channel = session.createChannel(&quot;shell&quot;);
            channel.setIn(System.in);
            channel.setOut(System.out);
            channel.setErr(System.err);
            channel.open();
            channel.waitFor(ClientChannel.CLOSED, 0);
        } catch (Throwable t) {
            t.printStackTrace();
            System.exit(1);
        } finally {
            try {
                client.stop();
            } catch (Throwable t) { }
        }
        System.exit(0);
    }

}</code></pre></div><p>You can find a more complete example at the <a href="http://svn.apache.org/repos/asf/karaf/trunk/client/src/main/java/org/apache/karaf/client/Main.java">following location</a>.</p><h1 id="Writingintegrationtests">Writing integration tests</h1><p>We recommend using <a href="http://team.ops4j.org/wiki/display/paxexam/Pax+Exam">PAX Exam</a> to write integration tests when developing<br/>applications using Karaf.</p><p>Karaf provides an helper library to help writing such integration tests.</p><div class="syntax"><pre name='code' class='brush: java; gutter: false;'><code>
   @Configuration
   public static Option[] configuration() throws Exception{
       return combine(
           // Default karaf environment
           Helper.getDefaultOptions(),
           // Test on both equinox and felix
           equinox(), felix()
       );
   }</code></pre></div><p>If you need to provision a few features in addition to the default Karaf environment, you can do so by adding the following code:</p><div class="syntax"><pre name='code' class='brush: java; gutter: false;'><code>
           scanFeatures(
                  maven().groupId(&quot;org.apache.felix.karaf&quot;)
                         .artifactId(&quot;apache-felix-karaf&quot;)
                         .type(&quot;xml&quot;).classifier(&quot;features&quot;)
                         .versionAsInProject(),
                  &quot;obr&quot;, &quot;wrapper&quot;
           ),</code></pre></div><h1 id="Addextendedinformationtobundles">Add extended information to bundles</h1><p>Karaf supports a OSGI-INF/bundle.info file in a bundle.</p><p>This file is extended description of the bundle. It supports ASCII character declarations (for adding color, formatting, etc).</p><p>For instance, you can define a bundle like this (using Apache Felix maven-bundle-plugin):</p><pre>
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

    &lt;modelVersion>4.0.0&lt;/modelVersion>

    &lt;groupId>my.groupId&lt;/groupId>
    &lt;artifactId>my.bundle&lt;/artifactId>
    &lt;version>1.0-SNAPSHOT&lt;/version>
    &lt;name>My Bundle&lt;/name>
    &lt;description>My bundle short description&lt;/description>

    &lt;build>
        &lt;resources>
            &lt;resource>
                &lt;directory>/x1/asf/karaf-2.3.x/target/checkout/manual/src/main/resources&lt;/directory>
                &lt;filtering>true&lt;/filtering>
                &lt;includes>
                    &lt;include>**/*&lt;/include>
                &lt;/includes>
            &lt;/resource>
        &lt;/resources>
        &lt;plugins>
            &lt;plugin>
                &lt;groupId>org.apache.felix&lt;/groupId>
                &lt;artifactId>maven-bundle-plugin&lt;/artifactId>
                &lt;version>2.2.0&lt;/version>
                &lt;extensions>true&lt;/extensions>
                &lt;configuration>
                    &lt;instructions>
                        &lt;Bundle-SymbolicName>manual&lt;/Bundle-SymbolicName>
                        ...
                    &lt;/instructions>
                &lt;/configuration>
            &lt;/plugin>
        &lt;/plugins>
    &lt;/build>

&lt;/project>
</pre><p>And simply add a src/main/resources/OSGI-INF/bundle.info file containing, for instance:</p><pre>
\u001B[1mSYNOPSIS\u001B[0m
    The Apache Software Foundation provides support for the Apache community of open-source software projects.
    The Apache projects are characterized by a collaborative, consensus based development process, an open and
    pragmatic software license, and a desire to create high quality software that leads the way in its field.
    We consider ourselves not simply a group of projects sharing a server, but rather a community of developers
    and users.

\u001B[1mDESCRIPTION\u001B[0m
    Long description of your bundle, including usage, etc.

\u001B[1mSEE ALSO\u001B[0m
    \u001B[36mhttp://yourside\u001B[0m
    \u001B[36mhttp://yourside/docs\u001B[0m

</pre><p>You can display this extended information using:</p><pre>
root@karaf> osgi:info
</pre><h1 id="Creatingbundlesforthirdpartydependencies">Creating bundles for third party dependencies</h1><p>Karaf supports the wrap: protocol execution.</p><p>It allows for directly deploying third party dependencies, like Apache Commons Lang:</p><pre>
root@karaf> osgi:install wrap:mvn:commons-lang/commons-lang/2.4
</pre><p>You can specify OSGi statements in the wrap URL:</p><p>from the shell</p><pre>
root@karaf> osgi:install -s 'wrap:mvn:commons-lang/commons-lang/2.4$Bundle-SymbolicName=commons-lang&amp;Bundle-Version=2.4'
</pre><p>from features.xml</p><pre>
&lt;bundle>wrap:mvn:commons-lang/commons-lang/2.4$Bundle-SymbolicName=commons-lang&amp;undle-Version=2.4&lt;/bundle>
</pre><p>You can also create a wrap bundle for a third party dependency.<br/>This bundle is simply a Maven POM that shades an existing jar and package into a jar bundle.</p><p>For instance, to create an OSGi bundle that wraps Apache Commons Lang, you can simply define the following Maven POM:</p><pre>
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

    &lt;modelVersion>4.0.0&lt;/modelVersion>

    &lt;groupId>osgi.commons-lang&lt;/groupId>
    &lt;artifactId>osgi.commons-lang&lt;/artifactId>
    &lt;version>2.4&lt;/version>
    &lt;packaging>bundle&lt;/packaging>
    &lt;name>commons-lang OSGi Bundle&lt;/name>
    &lt;description>This OSGi bundle simply wraps commons-lang-2.4.jar artifact.&lt;/description>

    &lt;dependencies>
        &lt;dependency>
            &lt;groupId>commons-lang&lt;/groupId>
            &lt;artifactId>commons-lang&lt;/artifactId>
            &lt;version>2.4&lt;/version>
            &lt;optional>true&lt;/optional>
        &lt;/dependency>
    &lt;/dependencies>

    &lt;build>
        &lt;defaultGoal>install&lt;/defaultGoal>

        &lt;plugin>
            &lt;groupId>org.apache.maven.plugins&lt;/groupId>
            &lt;artifactId>maven-shade-plugin&lt;/artifactId>
            &lt;version>1.1&lt;/version>
            &lt;executions>
                &lt;execution>
                    &lt;phase>package&lt;/phase>
                    &lt;goals>
                        &lt;goal>shade&lt;/goal>
                    &lt;/goals>
                    &lt;configuration>
                        &lt;artifactSet>
                            &lt;includes>
                                &lt;include>commons-lang:commons-lang&lt;/include>
                            &lt;/includes>
                        &lt;/artifactSet>
                        &lt;filters>
                            &lt;filter>
                                &lt;artifact>commons-lang:commons-lang&lt;/artifact>
                                &lt;excludes>
                                    &lt;exclude>**&lt;/exclude>
                                &lt;/excludes>
                            &lt;/filter>
                        &lt;/filters>
                        &lt;promoteTransitiveDependencies>true&lt;/promoteTransitiveDependencies>
                        &lt;createDependencyReducedPom>true&lt;/createDependencyReducedPom>
                    &lt;/configuration>
                &lt;/execution>
            &lt;/executions>
        &lt;/plugin>
        &lt;plugin>
            &lt;groupId>org.apache.felix&lt;/groupId>
            &lt;artifactId>maven-bundle-plugin&lt;/artifactId>
            &lt;version>2.1.0&lt;/version>
            &lt;extensions>true&lt;/extensions>
            &lt;configuration>
                &lt;instructions>
                    &lt;Bundle-SymbolicName>manual&lt;/Bundle-SymbolicName>
                    &lt;Export-Package>*&lt;/Export-Package>
                    &lt;Import-Package>&lt;/Import-Package>
                    &lt;_versionpolicy>[$(version;==;$(@)),$(version;+;$(@)))&lt;/_versionpolicy>
                    &lt;_removeheaders>Ignore-Package,Include-Resource,Private-Package,Embed-Dependency&lt;/_removeheaders>
                &lt;/instructions>
                &lt;unpackBundle>true&lt;/unpackBundle>
            &lt;/configuration>
        &lt;/plugin>
    &lt;/build>

&lt;/project>
</pre><p>You have now a OSGi bundle for commons-lang that you can deploy directly:</p><pre>
root@karaf> osgi:install -s mvn:osgi.commons-lang/osgi.commons-lang/2.4
</pre><p>Some more information is available at <a href="http://gnodet.blogspot.com/2008/09/id-like-to-talk-bit-about-third-party.html">http://gnodet.blogspot.com/2008/09/id-like-to-talk-bit-about-third-party.html</a>, <a href="http://blog.springsource.com/2008/02/18/creating-osgi-bundles/">http://blog.springsource.com/2008/02/18/creating-osgi-bundles/</a> and <a href="http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html">http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html</a>.</p><h1 id="Shellsyntax">Shell syntax</h1><h2 id="Easytouseinteractivelynounnecessarysyntax">Easy to use interactively - no unnecessary syntax</h2><pre>
// simple command
karaf@root> echo hello world
hello world

// session variables
karaf@root> msg = "hello world"
hello world
karaf@root> echo $msg
hello world

// execution quotes () - similar to bash backquotes
karaf@root> (bundle 1) location
mvn:org.ops4j.pax.url/pax-url-mvn/1.1.3
</pre><h2 id="Listmapspipesandclosures">List, maps, pipes and closures</h2><pre>
// lists - []
karaf@root> list = [1 2 a b]
1
2
a
b

karaf@root> map = [Jan=1 Feb=2 Mar=3]
Jan                 1
Feb                 2
Mar                 3

// pipes
karaf@root> bundles | grep felix
000000 ACT org.apache.felix.framework-3.0.2
000005 ACT org.apache.felix.configadmin-1.2.4
000006 ACT org.apache.felix.fileinstall-3.0.2

// closures - {}
karaf@root> echo2 = { echo xxx $args yyy }
org.apache.felix.gogo.runtime.shell.Closure@2ffb36c2
karaf@root> echo2 hello world
xxx hello world yyy
</pre><h2 id="LeveragesexistingJavacapabilitiesviareflection">Leverages existing Java capabilities, via reflection</h2><pre>
// exception handling - console shows summary, but full context available
karaf@root> start xxx
Error executing command osgi:start: unable to convert argument ids with value '[xxx]' to type java.util.List&lt;java.lang.Long>
karaf@root> $karaf.lastException printStackTrace
org.apache.felix.gogo.commands.CommandException: Unable to convert argument ids with value '[xxx]' to type java.util.List&lt;java.lang.Long>
	at org.apache.felix.gogo.commands.basic.DefaultActionPreparator.prepare(DefaultActionPreparator.java:347)
	at org.apache.felix.gogo.commands.basic.AbstractCommand.execute(AbstractCommand.java:34)
	at org.apache.felix.gogo.runtime.shell.CommandProxy.execute(CommandProxy.java:50)
	at org.apache.felix.gogo.runtime.shell.Closure.execute(Closure.java:229)
	at org.apache.felix.gogo.runtime.shell.Closure.executeStatement(Closure.java:162)
	at org.apache.felix.gogo.runtime.shell.Pipe.run(Pipe.java:101)
	at org.apache.felix.gogo.runtime.shell.Closure.execute(Closure.java:79)
	at org.apache.felix.gogo.runtime.shell.CommandSessionImpl.execute(CommandSessionImpl.java:71)
	at org.apache.karaf.shell.console.jline.Console.run(Console.java:169)
	at java.lang.Thread.run(Thread.java:637)
Caused by: java.lang.Exception: Unable to convert from [xxx] to java.util.List&lt;java.lang.Long>(error converting collection entry)
	at org.apache.aries.blueprint.container.AggregateConverter.convertToCollection(AggregateConverter.java:318)
	at org.apache.aries.blueprint.container.AggregateConverter.convert(AggregateConverter.java:159)
	at org.apache.karaf.shell.console.commands.BlueprintCommand$BlueprintActionPreparator.convert(BlueprintCommand.java:73)
	at org.apache.felix.gogo.commands.basic.DefaultActionPreparator.prepare(DefaultActionPreparator.java:344)
	... 9 more
Caused by: java.lang.NumberFormatException: For input string: "xxx"
	at java.lang.NumberFormatException.forInputString(NumberFormatException.java:48)
	at java.lang.Long.parseLong(Long.java:410)
	at java.lang.Long.valueOf(Long.java:525)
	at org.apache.aries.blueprint.container.AggregateConverter.convertFromString(AggregateConverter.java:261)
	at org.apache.aries.blueprint.container.AggregateConverter.convert(AggregateConverter.java:151)
	at org.apache.aries.blueprint.container.AggregateConverter.convertToCollection(AggregateConverter.java:316)
	... 12 more

// add all public methods on java.lang.System as commands:
karaf@root> addcommand system (loadClass java.lang.System)
karaf@root> system:getproperty karaf.name
root

// create new objects
karaf@root> map = (new java.util.HashMap)
karaf@root> $map put 0 0
karaf@root> $map
0                   0
</pre>
  </div>
</body>
</html>
